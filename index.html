<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Production - Migration Phase 1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #4361ee; --bg: #f8fafc; }
        body { background-color: var(--bg); font-family: sans-serif; }
        .screen { display: none; padding: 20px; }
        .active-screen { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-job { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; border-left: 5px solid #e2e8f0; transition: 0.2s; }
        .card-job.running { border-left-color: #10b981; background: #f0fdf4; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner-border text-primary"></div><div class="mt-2 fw-bold">SM CONNECTING...</div></div>

    <div class="container" style="max-width: 600px;">
        <!-- SCREEN: LOGIN -->
        <div id="screen-login" class="screen active-screen">
            <div class="text-center mt-5">
                <div class="mb-4"><i class="fa-solid fa-industry text-primary fa-4x"></i></div>
                <h3 class="fw-bold">SM Production</h3>
                <div class="card p-4 shadow-sm border-0 mt-4" style="border-radius: 20px;">
                    <select id="machine-select" class="form-select form-select-lg mb-3"></select>
                    <button class="btn btn-primary btn-lg w-100 py-3 fw-bold" onclick="enterSystem()">Login</button>
                </div>
            </div>
        </div>

        <!-- SCREEN: QUEUE -->
        <div id="screen-queue" class="screen">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0">งานรอผลิต: <span id="mc-tag" class="text-primary"></span></h4>
                <button class="btn btn-light rounded-circle shadow-sm" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
            </div>
            <div id="job-list"></div>
        </div>
    </div>

<script>
    // --- 1. API BRIDGE ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzl5VXzGxJo4SnuzkO4G6axSm1rAmBzAQ-9NAQPxEOmtiTVqxbZqmro6-RS94YhYYcJ/exec"; 
    const API_KEY = "TMT2026";

    async function callGAS(action, data = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ apiKey: API_KEY, action: action, data: data })
            });
            const res = await response.json();
            if (res.error) throw new Error(res.error);
            return res;
        } catch (err) {
            Swal.fire("API Connection Error", err.message, "error");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- 2. CORE LOGIC ---
    let ALL_DATA = {};
    let SELECTED_MC = "";

    window.onload = async () => {
        const data = await callGAS('getInitialData');
        if (data) {
            ALL_DATA = data;
            const sel = document.getElementById('machine-select');
            sel.innerHTML = '<option value="" disabled selected>-- เลือกเครื่องจักร --</option>';
            data.machines.forEach(m => sel.add(new Option(m, m)));
        }
    };

    function enterSystem() {
        SELECTED_MC = document.getElementById('machine-select').value;
        if (!SELECTED_MC) return;
        document.getElementById('mc-tag').innerText = SELECTED_MC;
        renderJobs();
        switchScreen('screen-queue');
    }

    function renderJobs() {
        const cont = document.getElementById('job-list');
        cont.innerHTML = "";
        const myJobs = ALL_DATA.jobs.filter(j => j.machine === SELECTED_MC && j.status !== 'Finished');

        myJobs.forEach(j => {
            const isRun = j.status === 'Running';
            const div = document.createElement('div');
            div.className = `card-job shadow-sm ${isRun ? 'running' : ''}`;
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge ${isRun?'bg-success':'bg-primary'} mb-1">${j.status}</span>
                        <div class="fw-bold fs-5">${j.jobId}</div>
                        <div class="small text-muted">${j.customer} | ${j.thickness} mm</div>
                    </div>
                    <div class="d-flex gap-2">
                        ${isRun ? 
                          `<button class="btn btn-warning btn-sm fw-bold" onclick="pauseJob('${j.jobId}')">PAUSE</button>
                           <button class="btn btn-success btn-sm fw-bold" onclick="alert('เดี๋ยวเฟส 2 เรามาทำหน้าบันทึกกันครับ')">บันทึก</button>` : 
                          `<button class="btn btn-primary btn-sm px-3" onclick="startJob('${j.jobId}')">START</button>`
                        }
                    </div>
                </div>`;
            cont.appendChild(div);
        });
    }

    async function startJob(id) {
        const res = await callGAS('startJob', { jobId: id });
        if (res === "SUCCESS") {
            Swal.fire({ icon:'success', title:'เริ่มงานแล้ว', timer:1000, showConfirmButton:false });
            // อัปเดตข้อมูลในเครื่องโดยไม่ต้องโหลดใหม่ทั้งหมด
            ALL_DATA.jobs.find(j => j.jobId === id).status = 'Running';
            renderJobs();
        }
    }

    async function pauseJob(id) {
        const res = await callGAS('pauseJob', { jobId: id });
        if (res === "SUCCESS") {
            ALL_DATA.jobs.find(j => j.jobId === id).status = 'Waiting';
            renderJobs();
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
    }
</script>
</body>
</html>
