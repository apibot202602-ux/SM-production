<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Migration - Phase 1</title>
    <!-- ใช้ SweetAlert2 เพื่อความสวยงามในการแจ้งเตือน -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f4f7f6; }
        .test-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        .btn-test { background: #4361ee; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-test:hover { background: #3a0ca3; }
        #result { margin-top: 20px; text-align: left; background: #f8fafc; padding: 10px; border-radius: 5px; font-size: 14px; color: #334155; display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4361ee; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="test-card">
    <h2 style="color: #1e293b;">เฟส 1: ทดสอบการเชื่อมต่อ</h2>
    <p style="color: #64748b;">กดปุ่มด้านล่างเพื่อทดสอบดึงรายชื่อเครื่องจักรจาก Google Sheets</p>
    
    <div class="loader" id="loader"></div>
    <button class="btn-test" id="btnTest" onclick="testConnection()">ทดสอบดึงข้อมูล (Connect)</button>

    <div id="result">
        <strong>พบเครื่องจักร:</strong>
        <ul id="machineList"></ul>
    </div>
</div>

<script>
    // --- ตั้งค่าการเชื่อมต่อ (สำคัญมาก) ---
    // 1. วาง URL ที่ก๊อปมาจาก Google Script (ขั้นตอนที่ 3) ตรงนี้ครับ
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzl5VXzGxJo4SnuzkO4G6axSm1rAmBzAQ-9NAQPxEOmtiTVqxbZqmro6-RS94YhYYcJ/exec"; 
    
    // 2. รหัสต้องตรงกับที่ตั้งไว้ใน Code.gs (ถ้าตั้งตามผมคือ TMT2026)
    const API_KEY = "TMT2026"; 

    async function testConnection() {
        const btn = document.getElementById('btnTest');
        const loader = document.getElementById('loader');
        const resultDiv = document.getElementById('result');
        const list = document.getElementById('machineList');

        // แสดง Loading
        btn.disabled = true;
        loader.style.display = 'block';
        resultDiv.style.display = 'none';

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    apiKey: API_KEY,
                    action: 'getInitialData'
                })
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // แสดงผลลัพธ์
            list.innerHTML = "";
            data.machines.forEach(m => {
                const li = document.createElement('li');
                li.innerText = m;
                list.appendChild(li);
            });

            resultDiv.style.display = 'block';
            Swal.fire('สำเร็จ!', 'เชื่อมต่อกับ Google Sheets เรียบร้อยแล้ว', 'success');

        } catch (err) {
            console.error(err);
            Swal.fire('เชื่อมต่อไม่สำเร็จ', 'สาเหตุ: ' + err.message, 'error');
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
        }
    }
</script>

</body>
</html>
