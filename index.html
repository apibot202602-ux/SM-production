<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Production App - Phase 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏™‡πÅ‡∏Å‡∏ô QR Code (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #f0f2f5; font-family: sans-serif; padding-bottom: 50px; }
        .screen { display: none; padding: 15px; }
        .active { display: block; }
        .card-custom { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; border: none; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; }
        .btn-main { border-radius: 10px; padding: 12px; font-weight: bold; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: black; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-grow text-primary"></div>
        <div class="mt-2 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤ Login (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <div id="screen-login" class="screen active">
        <div class="container text-center mt-5">
            <h3 class="fw-bold mb-4">SM Production Login</h3>
            <div class="card-custom mx-auto" style="max-width: 400px;">
                <select id="machine-select" class="form-select form-select-lg mb-3"></select>
                <button class="btn btn-primary btn-lg w-100 btn-main" onclick="enterSystem()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (Queue) -->
    <div id="screen-queue" class="screen">
        <h4 class="fw-bold mb-3">‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏ú‡∏•‡∏¥‡∏ï: <span id="display-machine" class="text-primary"></span></h4>
        <div id="job-list-container"></div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (Running) -->
    <div id="screen-running" class="screen">
        <div class="card-custom bg-primary text-white">
            <div class="small opacity-75">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï</div>
            <h2 id="run-job-id" class="fw-bold m-0">JOB-XXXX</h2>
            <div id="run-customer" class="small">Customer Name</div>
        </div>

        <div class="card-custom">
            <h6 class="fw-bold mb-3 text-muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</h6>
            
            <button class="btn btn-outline-success w-100 mb-3 btn-main" onclick="openScanner()">
                üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR Tag
            </button>
            <div id="reader" style="display:none;" class="mb-3"></div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Mill No.</label>
                    <input type="text" id="millNo" class="form-control">
                </div>
                <div class="col-6">
                    <label class="small fw-bold">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)</label>
                    <input type="number" id="weight" class="form-control">
                </div>
            </div>
            
            <label class="small fw-bold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="note" class="form-control mb-3"></textarea>

            <button class="btn btn-primary w-100 btn-lg btn-main shadow" onclick="saveRecord()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <button class="btn btn-light w-100 text-danger fw-bold" onclick="switchScreen('screen-queue')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzl5VXzGxJo4SnuzkO4G6axSm1rAmBzAQ-9NAQPxEOmtiTVqxbZqmro6-RS94YhYYcJ/exec";
    const API_KEY = "TMT2026";
    let ALL_DATA = { machines: [], jobs: [] };
    let SELECTED_MACHINE = "";
    let CURRENT_JOB = null;
    let html5QrCode = null;

    async function callGAS(action, data = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ apiKey: API_KEY, action: action, data: data })
            });
            return await response.json();
        } catch (err) {
            Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    window.onload = async () => {
        const data = await callGAS('getInitialData');
        if (data) {
            ALL_DATA = data;
            const select = document.getElementById('machine-select');
            data.machines.forEach(m => select.add(new Option(m, m)));
        }
    };

    function enterSystem() {
        SELECTED_MACHINE = document.getElementById('machine-select').value;
        if (!SELECTED_MACHINE) return;
        document.getElementById('display-machine').innerText = SELECTED_MACHINE;
        renderJobs();
        switchScreen('screen-queue');
    }

    function renderJobs() {
        const container = document.getElementById('job-list-container');
        container.innerHTML = "";
        const myJobs = ALL_DATA.jobs.filter(j => j.machine === SELECTED_MACHINE && j.status !== 'Finished');
        myJobs.forEach(j => {
            const div = document.createElement('div');
            div.className = 'card-custom';
            div.innerHTML = `
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="fw-bold">${j.jobId}</div>
                        <div class="small text-muted">${j.customer}</div>
                    </div>
                    <button class="btn btn-primary btn-sm px-4" onclick="startJob('${j.jobId}')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function startJob(jobId) {
        const res = await callGAS('startJob', { jobId: jobId });
        if (res === "SUCCESS") {
            CURRENT_JOB = ALL_DATA.jobs.find(j => j.jobId === jobId);
            document.getElementById('run-job-id').innerText = CURRENT_JOB.jobId;
            document.getElementById('run-customer').innerText = CURRENT_JOB.customer;
            switchScreen('screen-running');
        }
    }

    function openScanner() {
        document.getElementById('reader').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ñ‡πâ‡∏≤ QR ‡πÄ‡∏õ‡πá‡∏ô "MILL01,25000" ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á
                const data = decodedText.split(",");
                if(data[0]) document.getElementById('millNo').value = data[0];
                if(data[1]) document.getElementById('weight').value = data[1];
                
                stopScanner();
                Swal.fire('‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success');
            },
            (errorMessage) => { /* ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ */ }
        );
    }

    function stopScanner() {
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
            });
        }
    }

    async function saveRecord() {
        const formObj = {
            jobId: CURRENT_JOB.jobId,
            machine: SELECTED_MACHINE,
            millNo: document.getElementById('millNo').value,
            weight: document.getElementById('weight').value,
            note: document.getElementById('note').value
        };

        if(!formObj.millNo || !formObj.weight) return Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', '', 'warning');

        const res = await callGAS('saveProductionLog', { formObj: formObj, fileList: [] });
        if (res === "SUCCESS") {
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success').then(() => {
                location.reload(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
            });
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
