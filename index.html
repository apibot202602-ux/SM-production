<!DOCTYPE html>
<html>
  <head>
    <script>
        // GAS บังคับ iframe viewport = 980px ไม่ฟัง meta tag
        // Fix: ตรวจจับแล้ว rewrite viewport meta ให้ scale ถูก
        (function() {
            var deviceW = screen.width;
            var vmeta = document.querySelector('meta[name="viewport"]');
            if (vmeta) {
                // Force device width จริง ไม่ใช่ 980px ที่ GAS inject
                vmeta.content = 'width=' + deviceW + ', initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover';
            }
        })();
    </script>

    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>SM Production App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
          --primary-color: #4361ee;
          --primary-gradient: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
          --bg-color: #f8fafc;
          --card-radius: 16px; /* ลดความโค้งลงนิดนึงให้ดู Modern */
          --shadow-soft: 0 4px 20px -5px rgba(0, 0, 0, 0.08);
        }
        body { background-color: var(--bg-color); font-family: 'Sarabun', sans-serif; color: #1e293b; font-size: 14px; overflow-x: hidden; }

        /* Desktop: centered container */
        .container { max-width: 800px; padding-top: 15px; padding-bottom: 80px; padding-left: 16px; padding-right: 16px; }
        html, body { max-width: 100vw; overflow-x: hidden; }

        /* Mobile: เต็มจอ ไม่มีขอบ เหมือน native app */
        
        
        
        .screen { display: none; opacity: 0; transition: opacity 0.3s; }
        .active-screen { display: block; opacity: 1; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .card-custom { background: #fff; border-radius: var(--card-radius); border: none; box-shadow: var(--shadow-soft); overflow: hidden; margin-bottom: 12px; }
        
        .btn-main { background: var(--primary-gradient); color: white; border: none; border-radius: 12px; padding: 10px; font-weight: 600; transition: 0.2s; font-size: 0.95rem; }
        .btn-main:active { transform: scale(0.98); }

        .form-control, .form-select { border-radius: 10px; border: 1px solid #e2e8f0; background-color: #f8fafc; padding: 8px 12px; font-size: 0.9rem; }
        .form-control:focus { background-color: white; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1); }
        
        /* Log Item Compact */
        .log-item { background: white; border-radius: 12px; padding: 10px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; cursor: pointer; }
        
        /* Dashboard Grid */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 12px; 
        }
        .machine-card-dash { 
            background: white; 
            border-radius: 16px; 
            min-height: 200px;
            max-height: 450px;
            display: flex; 
            flex-direction: column; 
            box-shadow: var(--shadow-soft); 
        }
        .job-list-area { flex-grow: 1; overflow-y: auto; padding: 10px; background: #fafafa; }
        .job-ticket { background: white; border-radius: 10px; padding: 10px; margin-bottom: 8px; border: 1px solid #eee; font-size: 0.85rem; }

        /* Mobile dashboard: full-width app style */
        
        
        /* Status Colors */
        .st-run { border-left: 4px solid #10b981; background: #ecfdf5; }
        .st-wait { border-left: 4px solid #94a3b8; }
        .st-done { background: #f1f5f9; opacity: 0.7; }
        
        /* Loading */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        /* Table Custom for Mobile */
        .table-custom th, .table-custom td { padding: 4px; font-size: 0.8rem; vertical-align: middle; white-space: nowrap; }
        .table-custom input { font-size: 0.8rem; padding: 4px; min-width: 50px; }
        
        /* Analytics KPI Text */
        h3 { font-size: 1.5rem; } /* ลดขนาดหัวข้อตัวเลข */

        /* Scrollbar สวยๆ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        .nav-pills .nav-link {
            border-radius: 10px;
            font-weight: bold;
            color: #64748b;
            background: #f1f5f9;
            margin: 0 2px;
            border: 1px solid #e2e8f0;
        }
        .nav-pills .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            border: none;
        }
        /* Input Input ให้ใหญ่ขึ้น จิ้มง่าย */
        .big-input {
            height: 48px; /* สูงขึ้น */
            font-size: 1.1rem; /* ตัวเลขใหญ่ */
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        .big-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }
        /* ซ่อน Section ที่ยังไม่เลือก */
        .input-section { display: none; animation: fadeIn 0.3s; }
        .input-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Progress Bar Custom */
        .progress-thin {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar-custom {
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        /* Animation เล็กๆ ให้รู้ว่ากำลังอัปเดต */
        .pulse-update { animation: pulseGreen 1s; }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }        

        .is-invalid-qc {
            background-color: #fee2e2 !important; /* สีแดงอ่อน */
            border: 2px solid #ef4444 !important; /* ขอบแดง */
            color: #b91c1c !important;            /* ตัวเลขสีแดง */
        }

        .external-quote {
            font-family: 'Kanit', sans-serif;
            text-align: center;
            margin-bottom: 30px; /* เว้นระยะก่อนถึงกล่องสีขาว */
            width: 100%;
        }
        #qr-reader {
            background: #000;
        }
        .form-floating > label {
            font-size: 0.75rem;
        }
        /* แก้ไขให้ Profile Preview ไม่ลอยทับส่วนอื่น */
        .profile-preview-box {
            position: relative;
            clear: both;
            margin-top: 15px;
        }
        .stat-badge-crown {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .film-strip-container {
            background: #1e293b; /* พื้นหลังสีเข้มเพื่อให้เห็นเส้นชัดเจน */
            border-radius: 8px;
            padding: 15px 10px;
            margin: 10px 0;
            overflow-x: auto; /* เผื่อในมือถือให้เลื่อนดูได้ */
        }
        .film-frame-label {
            color: #94a3b8;
            font-size: 0.65rem;
            text-align: center;
            margin-top: 5px;
        }
        .film-3d-container {
            background: linear-gradient(145deg, #0f172a, #1e293b);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            position: relative;
        }
        .label-3d {
            position: absolute;
            font-size: 0.6rem;
            color: #64748b;
            text-transform: uppercase;
        }

        /* 1. High Contrast & Status Pulse */
        :root {
          --primary-color: #2563eb;
          --success-color: #10b981;
          --warning-color: #f59e0b;
          --danger-color: #ef4444;
        }

        /* ปุ่มใหญ่สะใจ (Fitts's Law) */
        .btn-lg-xl {
          padding: 1.25rem;
          font-size: 1.25rem;
          font-weight: 700;
          border-radius: 16px;
        }

        /* ตัวกะพริบสถานะ Running */
        .pulse-running {
          width: 10px;
          height: 10px;
          background: var(--success-color);
          border-radius: 50%;
          display: inline-block;
          margin-right: 8px;
          box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
          70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
          100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        /* ปรับแต่ง Input ให้ดูเป็นมืออาชีพ */
        .form-control:focus {
          border-color: var(--primary-color);
          box-shadow: 0 0 0 0.25 darkblue;
          background-color: #fff !important;
        }

        /* Toast Notification (แจ้งเตือนเล็กๆ) */
        #toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
        }

        /* สไตล์สำหรับการแจ้งเตือน Toast */
        .my-toast {
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          margin-bottom: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
          font-weight: bold;
          opacity: 1;
          transition: opacity 0.5s ease;
          display: flex;
          align-items: center;
        }
        /* สไตล์สำหรับช่อง Input ที่กำลังพิมพ์ (Highlight) */
        .form-control:focus {
          border: 2px solid #2563eb !important;
          background-color: #f0f7ff !important;
        }

        .history-card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .visual-container {
            background: #f8fafc;
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
        }
        .table-qc {
            font-size: 0.7rem;
            margin-bottom: 0;
            text-align: center;
        }
        .table-qc th { background: #334155; color: white; }    



        .qc-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .qc-header {
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 3D Container ที่ดูเป็นส่วนหนึ่งของแอป */
        .viewer-3d {
            /* เปลี่ยนจากสีดำเป็นสีเทาอ่อนแบบห้องแล็บ เพื่อให้เห็นเงาเหล็กชัดขึ้น */
            background: radial-gradient(circle, #ffffff 0%, #e2e8f0 100%); 
            position: relative;
            height: 300px;
            cursor: grab; /* เปลี่ยนรูปเมาส์ให้เป็นรูปมือ */
            touch-action: none;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
        }
        .viewer-3d:active { cursor: grabbing; }

        /* ตารางและข้อมูล Traceability */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 15px;
            background: #f8fafc;
        }

        .data-box {
            background: white;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .data-label { font-size: 0.65rem; color: #64748b; font-weight: bold; text-transform: uppercase; }
        .data-value { font-size: 0.85rem; font-weight: bold; color: #1e293b; }    

        .viewer-3d-container {
            position: relative;
            background: radial-gradient(circle, #ffffff 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            overflow: hidden;
        }

        /* แถบอธิบายสี (Color Legend) */
        .color-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 2px;
            pointer-events: none; /* ไม่ให้ขวางการหมุน */
        }
        .legend-bar {
            width: 60px;
            height: 8px;
            background: linear-gradient(to right, #3b82f6, #4ade80, #facc15, #ef4444);
            border-radius: 2px;
        }


        /* ปุ่มล็อคมุมมอง */
        .view-presets {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* ปรับปุ่ม Preset ให้ทึบและเห็นชัดขึ้นมาก */
        .btn-preset {
            width: 36px; /* ใหญ่ขึ้นนิดนึง */
            height: 36px;
            background: #ffffff; /* เปลี่ยนเป็นสีขาวทึบ */
            border: 2px solid #2563eb; /* ขอบสีน้ำเงินเข้ม */
            color: #1e293b; /* ตัวหนังสือสีเข้ม */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); /* เพิ่มเงาให้ลอยเด่น */
            transition: 0.2s;
            opacity: 0.9;
        }
        .btn-preset:hover { background: #2563eb; color: #fff; opacity: 1; }
        .btn-preset:active { transform: scale(0.9); }

        /* Tooltip บอกค่าความหนาเวลาจิ้ม */
        .thk-tooltip {
            position: absolute;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 5px;
            font-size: 0.7rem;
            pointer-events: none;
            display: none;
            z-index: 1000;
            border: 1px solid #4ade80;
            white-space: nowrap;
        }

        .color-legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            display: flex;
            flex-direction: row-reverse; /* วางแถบสีคู่กับตัวเลข */
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none;
        }

        .legend-scale {
            display: flex;
            flex-direction: column;
            justify-content: bween;
            height: 120px; /* ความสูงของแถบสี */
            width: 15px;
            background: linear-gradient(to top, #3b82f6, #2dd4bf, #4ade80, #facc15, #fb923c, #ef4444);
            border-radius: 4px;
        }

        .legend-values {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 120px; /* ลดความยาวลงเล็กน้อย */
            font-size: 8px;
            color: #fff;
            font-family: monospace;
            text-align: right;
        }

        /* สไตล์สำหรับรูปภาพในหน้าประวัติ */
        .img-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .img-thumb {
            width: 65px;
            height: 65px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
        }

        .img-thumb:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        .img-container-label {
            font-size: 0.65rem;
            color: #64748b;
            font-weight: bold;
            margin-bottom: 4px;
        }     

        /* สีสำหรับค่าที่หลุดสเปก */
        .qc-high { color: #2563eb !important; font-weight: bold; } /* หลุด Max = น้ำเงิน */
        .qc-low { color: #ef4444 !important; font-weight: bold; }  /* หลุด Min = แดง */

        /* ปรับแต่ง Input เมื่อพิมพ์ (Live Validation) */
        .input-high { background-color: #dbeafe !important; color: #1e40af !important; border: 2px solid #2563eb !important; }
        .input-low { background-color: #fee2e2 !important; color: #b91c1c !important; border: 2px solid #ef4444 !important; }           

        /* สีสำหรับค่าที่หลุดสเปกในตาราง */
        .qc-high { 
            color: #2563eb !important; /* สีน้ำเงิน (หนาเกิน) */
            background-color: #dbeafe !important; /* พื้นหลังฟ้าอ่อน */
            font-weight: bold; 
        }
        .qc-low { 
            color: #ef4444 !important; /* สีแดง (บางเกิน) */
            background-color: #fee2e2 !important; /* พื้นหลังแดงอ่อน */
            font-weight: bold; 
        }

        /* ปรับปรุง Modal History ให้เหมาะกับมือถือ */
        #modal-view-history .modal-header {
            display: block; /* เปลี่ยนจาก flex เป็น block เพื่อให้หัวข้ออยู่บรรทัดบน */
            padding: 15px;
        }

        #modal-view-history .modal-title-area {
            margin-bottom: 12px;
        }

        /* จัดกลุ่มปุ่มควบคุมกราฟให้เรียงสวยๆ */
        .chart-controls-container {
            display: flex;
            flex-direction: column; /* เรียงปุ่มเป็น 2 แถวบนมือถือ */
            gap: 10px;
            background: #f8fafc;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        /* ปรับ Button Group ให้ขยายเต็มความกว้าง (Full Width) เพื่อให้จิ้มง่าย */
        .chart-controls-container .btn-group {
            display: flex;
            width: 100%;
        }

        .chart-controls-container .btn-group .btn {
            flex: 1; /* ให้ปุ่มทุกปุ่มกว้างเท่ากัน */
            font-size: 0.8rem;
            padding: 8px 2px;
            font-weight: 600;
        }

        /* ปรับขนาดตัวอักษรหัวข้อวิเคราะห์ */
        .analysis-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ปรับแต่งความสูงของกราฟให้พอดีจอ */
        #job-trend-chart {
            max-height: 250px !important;
        }  

        /* Flatness Health Bar */
        .flatness-monitor {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }

        .flat-bar-bg {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            position: relative;
            margin: 10px 0;
            overflow: hidden;
        }

        .flat-bar-fill {
            height: 100%;
            width: 0%; /* ปรับตามค่าความเรียบ */
            transition: width 0.5s ease, background-color 0.5s ease;
        }

        .flat-status-text {
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* สีตามสถานะ */
        .bg-flat-good { background: #10b981; } /* เขียว */
        .bg-flat-warn { background: #f59e0b; } /* ส้ม */
        .bg-flat-danger { background: #ef4444; } /* แดง */    

        /* แถบสีอธิบาย 3D (Color Scale) */
        .thk-color-legend {
            position: absolute;
            right: 8px;
            top: 35%; /* ขยับขึ้นจาก 50% เพื่อเปิดพื้นที่ให้ Slider ด้านล่าง */
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 4px;
            border-radius: 8px;
            z-index: 30;
        }

        .color-bar-gradient {
            width: 8px;
            height: 110px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .legend-label { color: white; font-size: 9px; font-weight: bold; }

        /* คำอธิบาย Flatness Scale */
        .flatness-scale-guide {
            display: flex;
            justify-content: bween;
            margin-top: 4px;
            font-size: 8px;
            color: #94a3b8;
            font-weight: bold;
        }
        .scale-item { display: flex; align-items: center; gap: 3px; }
        .dot-good { width: 6px; height: 6px; background: #10b981; border-radius: 50%; }
        .dot-warn { width: 6px; height: 6px; background: #f59e0b; border-radius: 50%; }
        .dot-danger { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; }          

        /* Flatness Box มุมซ้ายบน */
        .compact-flatness-box {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 105px; /* ย่อให้เล็กลง */
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            padding: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 30;
        }

        .flat-title-mini { color: #94a3b8; font-size: 7px; text-transform: uppercase; font-weight: bold; }
        .shape-status-text { font-size: 10px; font-weight: bold; display: block; margin: 1px 0; }
        .crown-val-mini { font-size: 9px; font-family: monospace; color: #ccc; display: block; }
        .flat-bar-bg { height: 2px; background: rgba(255,255,255,0.1); border-radius: 1px; margin-top: 3px; }

        .dev-status-tag { 
            font-size: 13px; 
            font-family: 'Courier New', monospace;
            margin-top: 6px;
            display: block;
            border-radius: 6px;
            padding: 4px 2px;
            text-align: center;
            font-weight: 800;
            letter-spacing: 1px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        .label-3d-head-tail {
            position: absolute;
            color: rgba(255,255,255,0.4);
            font-weight: bold;
            font-size: 11px;
            pointer-events: none;
        }

        .meter-display-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 5px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 8px;
        }  
        .meter-label { color: #10b981; font-family: monospace; font-weight: bold; font-size: 13px; }
        .dev-label-bottom { color: #3b82f6; font-family: monospace; font-weight: bold; font-size: 13px; }

        /* ปรับแต่งความสูง Canvas บนมือถือ */
        @media (max-width: 1024px) {
            #modal-view-history .col-lg-7 { min-height: 380px !important; } /* ลดความสูงส่วน 3D */
            #modal-view-history canvas[id^="3d-canvas-"] { height: 260px !important; }
        }

        .custom-range-mobile { height: 32px !important; z-index: 50; position: relative; }

        #slit-stats-container::-webkit-scrollbar {
            height: 4px;
        }
        #slit-stats-container::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        /* ปรับแต่ง Badge ให้ดูเป็นแนววิศวกรรม */
        #slit-stats-container .bg-black {
            background-color: #000 !important;
            border: 1px solid #1e293b !important;
        }

        /* Badge ของสลิต (เน้นตัวเลขวิ่ง) */
        .slit-badge-live {
            min-width: 120px;
            background: #000;
            border: 1px solid #1e293b;
            border-top: 3px solid #06b6d4;
            padding: 8px;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .slit-val-grid {
            display: grid;
            gap: 2px;
        }
        .slit-val-live {
            color: #fff;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        /* แถบไม้บรรทัดใต้หน้าตัด */
        .cutting-ruler {
            height: 20px;
            background: #e2e8f0;
            margin-top: -5px;
            position: relative;
            border-radius: 0 0 10px 10px;
            border: 1px solid #cbd5e1;
        }
        .ruler-mark {
            position: absolute;
            bottom: 0;
            width: 1px;
            height: 5px;
            background: #64748b;
        }

        /* รอยมีดบนหน้าตัด */
        .knife-line {
            position: absolute;
            width: 2px;
            height: 100%;
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            pointer-events: none;
        }

        .knife-handle {
            cursor: ew-resize; /* สัญลักษณ์เลื่อนซ้ายขวา */
            transition: 0.2s;
        }
        .knife-handle:hover {
            background: #3b82f6 !important; /* เปลี่ยนเป็นสีน้ำเงินเมื่อจะลาก */
            width: 4px !important;
        }    

        /* โหมดขยายกราฟเต็มจอ */
        .timeline-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 10000 !important;
            background: #ffffff !important; /* พื้นหลังขาวทึบ */
            padding: 20px !important;
            overflow-y: auto !important;
            opacity: 1 !important; /* ทึบ 100% */
        }
        .timeline-fullscreen #timelineChart {
            height: 80vh !important;
        }
        .btn-close-fullscreen {
            display: none;
        }
        .timeline-fullscreen .btn-close-fullscreen {
            display: inline-block;
        }
        #chart-height-control {
            transition: height 0.3s ease;
        }        
        .timeline-fullscreen .fa-expand {
            display: none;
        }                    


        .ai-hint-bar {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f0f4ff;
            border-left: 3px solid #4361ee;
            border-radius: 0 8px 8px 0;
            margin-bottom: 10px;
            font-size: 0.78rem;
            color: #4361ee;
            /* ไม่ wrap — scroll แนวนอนถ้าจอแคบ */
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            width: 100%;
            box-sizing: border-box;
        }
        .ai-hint-bar::-webkit-scrollbar { display: none; }
        .ai-hint-bar.visible { display: flex; }
        .ai-hint-bar .hint-label {
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }
        /* กลุ่ม badge แต่ละตำแหน่ง */
        .ai-hint-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        .ai-hint-group .hint-tag {
            font-size: 0.7rem;
            color: #818cf8;
            font-weight: 500;
        }
        .ai-hint-badge {
            background: #e0e7ff;
            border: 1px solid #c7d2fe;
            border-radius: 6px;
            padding: 2px 8px;
            font-weight: 700;
            font-size: 0.82rem;
            color: #3730a3;
            letter-spacing: 0.02em;
            white-space: nowrap;
        }
        .ai-hint-bar .hint-sep { color: #c7d2fe; flex-shrink: 0; }

        /* === History Card — Mobile Order ===
           Desktop (lg): 3D ซ้าย | workbench+slit+table ขวา (ไม่เปลี่ยน)
           Mobile (<992px): 3D → Table → Workbench → ปรับแผน
        */
        @media (max-width: 991px) {
            .hist-card-right {
                display: flex !important;
                flex-direction: column;
            }
            .hist-order-table    { order: 1; }
            .hist-order-workbench { order: 2; }
            .hist-order-slit     { order: 3; }
            .hist-order-meta     { order: 4; }
            .hist-order-actions  { order: 5; }
        }


        
            #mobile-bottom-nav  { display: none !important; }
        }

        /* ================================================================
           MOBILE STYLES — comprehensive, single block, no conflicts
           Breakpoint: 700px
        ================================================================ */
        

        /* Desktop: always hide mobile-only elements */
        

        /* ================================================================
           MOBILE COMPONENT STYLES (ไม่ใช่ media query — ใช้กับ class เฉพาะ)
        ================================================================ */

        /* Bottom Nav */
        #mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #fff;
            border-top: 1px solid #e2e8f0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .mob-nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 4px 8px;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 0.65rem;
            font-weight: 600;
            gap: 3px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: color 0.15s;
            min-height: 56px;
        }
        .mob-nav-btn i { font-size: 1.3rem; }
        .mob-nav-btn.active { color: #4361ee; }
        .mob-nav-btn.record-btn {
            color: #fff !important;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            border-radius: 14px;
            margin: 6px 3px;
            padding: 6px 8px;
            box-shadow: 0 4px 14px rgba(67,97,238,0.4);
            min-height: 44px;
            font-size: 0.7rem;
        }

        /* Mobile Dashboard */
        .mob-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0 12px;
        }
        .mob-stat-bar {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 8px;
            margin-bottom: 14px;
        }
        .mob-stat-card {
            background: #fff;
            border-radius: 14px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .mob-stat-num   { font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .mob-stat-label { font-size: 0.7rem; color: #94a3b8; margin-top: 3px; }

        /* Machine accordion */
        .mob-machine-row {
            background: #fff;
            border-radius: 16px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .mob-machine-row.is-running { box-shadow: 0 2px 14px rgba(16,185,129,0.18); }

        .mob-machine-header {
            display: flex;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            gap: 12px;
            -webkit-tap-highlight-color: transparent;
        }
        .mob-machine-header:active { background: #f8fafc; }

        .mob-machine-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .mob-machine-dot.running {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
            animation: pulse-green 2s infinite;
        }
        .mob-machine-dot.idle { background: #cbd5e1; }

        @keyframes pulse-green {
            0%,100% { box-shadow: 0 0 0 3px rgba(16,185,129,0.2); }
            50%      { box-shadow: 0 0 0 7px rgba(16,185,129,0.05); }
        }

        .mob-machine-name { font-weight: 700; font-size: 1.05rem; flex: 1; color: #0f172a; }
        .mob-machine-sub  { font-size: 0.78rem; color: #94a3b8; margin-top: 1px; }

        .mob-mc-badge {
            font-size: 0.68rem; font-weight: 700;
            padding: 4px 10px; border-radius: 20px;
            flex-shrink: 0;
        }
        .mob-mc-badge.running { background: #d1fae5; color: #065f46; }
        .mob-mc-badge.idle    { background: #f1f5f9; color: #64748b; }

        .mob-chevron {
            color: #cbd5e1;
            transition: transform 0.25s ease;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .mob-machine-row.open .mob-chevron { transform: rotate(180deg); }

        .mob-job-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid #f1f5f9;
        }
        .mob-machine-row.open .mob-job-list { max-height: 9999px; }

        .mob-job-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #f8fafc;
            cursor: pointer;
            gap: 12px;
            min-height: 64px;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.1s;
        }
        .mob-job-item:active  { background: #eff6ff; }
        .mob-job-item:last-child { border-bottom: none; }

        .mob-job-bar {
            width: 4px;
            align-self: stretch;
            border-radius: 4px;
            flex-shrink: 0;
            min-height: 36px;
        }
        .mob-job-bar.running  { background: #10b981; }
        .mob-job-bar.waiting  { background: #cbd5e1; }
        .mob-job-bar.finished { background: #e2e8f0; }

        .mob-job-info { flex: 1; min-width: 0; }
        .mob-job-id   { font-weight: 700; font-size: 0.95rem; color: #0f172a; }
        .mob-job-cust { font-size: 0.8rem; color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mob-job-thk  { font-weight: 800; color: #4361ee; font-size: 1.05rem; margin-top: 2px; }

        .mob-job-right { text-align: right; flex-shrink: 0; }
        .mob-job-count { font-size: 0.95rem; font-weight: 700; color: #334155; }
        .mob-job-status-label { font-size: 0.68rem; }
        .mob-job-status-label.running { color: #10b981; font-weight: 700; }
        .mob-job-status-label.waiting { color: #94a3b8; }

        .mob-empty { text-align: center; padding: 20px; color: #94a3b8; font-size: 0.85rem; }



        /* ================================================================
           LANDSCAPE ONLY — compact vertical spacing
           Portrait: ใช้ default layout (scroll ตามปกติ ไม่บังคับ height)
        ================================================================ */
        

        /* ============================================================
           MOBILE RESPONSIVE — single clean block
           ≤768px: phone & small tablet
        ============================================================ */
        @media (max-width: 1024px) {

            /* 1. Container เต็มจอ ไม่มีขอบขาว */
            body { font-size: 16px; overflow-x: hidden; background: #f0f2f5; }
            #app-container {
                max-width: 100vw !important;
                width: 100vw !important;
                margin: 0 !important;
                padding: 12px 14px 80px !important;
                box-sizing: border-box;
            }

            /* 2. Modal เต็มจอ */
            .modal-dialog {
                margin: 0 !important;
                max-width: 100vw !important;
            }
            .modal-content { border-radius: 0 !important; }
            .modal-dialog.modal-lg .modal-content,
            .modal-dialog.modal-xl .modal-content { min-height: 100dvh; }

            /* 3. Font & touch target */
            .btn { min-height: 44px; }
            .form-control, .form-select { font-size: 16px !important; min-height: 44px; }
            /* ป้องกัน iOS zoom เวลา focus input */

            /* 4. Dashboard: cards เต็มจอ ไม่มีขอบ */
            #screen-dashboard { padding: 12px 0 80px !important; }
            #screen-dashboard > .d-flex { padding: 0 14px 10px !important; flex-direction: column !important; gap: 6px !important; }
            #screen-dashboard > .d-flex h4 { font-size: 1rem !important; }
            #screen-dashboard > .d-flex small,
            #screen-dashboard .form-switch { display: none !important; }
            #screen-dashboard .d-flex.flex-wrap.align-items-center { flex-direction: row !important; flex-wrap: wrap !important; }
            #monitor-date-start, #monitor-date-end,
            #screen-dashboard .input-group-text:not(:first-child) { display: none !important; }
            #screen-dashboard .input-group { min-width: 0 !important; }

            .dashboard-grid { grid-template-columns: 1fr !important; gap: 0 !important; }
            .machine-card-dash { border-radius: 0 !important; max-height: none !important; box-shadow: none !important; border-bottom: 8px solid #f0f2f5 !important; }
            .job-list-area { overflow-y: visible !important; padding: 8px 12px !important; background: #fff !important; }
            .job-ticket { padding: 14px 12px !important; font-size: 1rem !important; border-radius: 12px !important; }
            .job-ticket .fw-bold { font-size: 1rem !important; }
            .job-ticket .text-primary { font-size: 1.05rem !important; font-weight: 800 !important; }

            /* 5. Tabs: horizontal scroll */
            #pills-tab { flex-wrap: nowrap !important; overflow-x: auto !important; scrollbar-width: none; }
            #pills-tab::-webkit-scrollbar { display: none; }
            #pills-tab .nav-item { flex-shrink: 0 !important; }
            #pills-tab .nav-link { font-size: 0.8rem !important; padding: 7px 12px !important; white-space: nowrap; }

            /* 6. History modal columns: stack vertical */
            #modal-view-history .col-lg-7,
            #modal-view-history .col-lg-5 { width: 100% !important; max-width: 100% !important; }
            #modal-view-history .row.g-0 { flex-direction: column !important; }

            /* 7. Mobile accordion (hidden — ใช้ desktop grid แทน) */
            #mobile-dash { display: none !important; }

            /* 8. Bottom nav */
            #mobile-bottom-nav { display: flex !important; }

            /* 9. History card order */
            .hist-card-right { display: flex !important; flex-direction: column; }
            .hist-order-table     { order: 1; }
            .hist-order-workbench { order: 2; }
            .hist-order-slit      { order: 3; }
            .hist-order-meta      { order: 4; }
            .hist-order-actions   { order: 5; }
        }

        /* Desktop: hide mobile-only */
        @media (min-width: 1025px) {
            #mobile-dash        { display: none !important; }
            #mobile-bottom-nav  { display: none !important; }
        }

        /* Landscape phone: compact */
        @media (max-width: 1024px) and (orientation: landscape) {
            .screen.active-screen { padding-top: 8px !important; }
            #screen-running .card-custom { padding: 10px 14px !important; margin-bottom: 8px !important; }
            #screen-running .row.g-3 { flex-wrap: nowrap !important; }
            #screen-running .row.g-3 > .col-12 { flex: 1 !important; max-width: none !important; padding: 0 !important; }
            #screen-running .row.g-3 .mt-3 { margin-top: 0 !important; }
            #run-btn-record { padding: 10px !important; }
            #run-btn-record .flex-column { flex-direction: row !important; gap: 8px; align-items: center; }
            #run-btn-record .fa-pen-to-square { font-size: 1.4rem !important; margin-bottom: 0 !important; }
            #run-btn-record .fs-3 { font-size: 1rem !important; }
            #run-btn-record small { display: none; }
            .mob-nav-btn { min-height: 44px; padding: 5px 4px; font-size: 0.6rem; }
        }

    </style>
  </head>
  <body>

    <div id="loading">
      <div class="spinner-grow text-primary" role="status"></div>
      <p class="mt-2 fw-bold text-muted small">UPDATING...</p>
    </div>

    <div class="container" id="app-container">
      
      <!-- SCREEN 1: LOGIN -->
      <div id="screen-select" class="screen active-screen">
        <div class="d-flex justify-content-center align-items-center" style="min-height: 70vh;">
          <div class="card-custom p-5 w-100" style="max-width: 450px;">
            <div class="text-center mb-4">
              <div style="width: 80px; height: 80px; background: var(--primary-gradient); border-radius: 24px; display: inline-flex; align-items: center; justify-content: center; transform: rotate(-10deg); box-shadow: 0 10px 20px rgba(67,97,238,0.3);">
                <i class="fa-solid fa-industry text-white fa-2x" style="transform: rotate(10deg);"></i>
              </div>
              <h3 class="fw-bold mt-3 mb-0">SM Production</h3>
            </div>
            <div class="mb-4">
              <select id="machine-select" class="form-select form-select-lg fw-bold text-primary text-center">
                <option value="" selected disabled>-- เลือกเครื่องจักร --</option>
              </select>
            </div>
            <button onclick="enterSystem()" class="btn-main w-100 btn-lg mb-3" id="btn-enter" disabled>เข้าสู่ระบบ</button>
            <button onclick="showDashboard()" class="btn btn-light w-100 border shadow-sm text-secondary fw-bold hover-shadow">
              <i class="fa-solid fa-chart-line me-1"></i> ดูภาพรวม (Dashboard)
          </button>
          </div>
        </div>
      </div>

      <!-- SCREEN 2: QUEUE -->
      <div id="screen-queue" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
             <h4 class="fw-bold m-0">งานรอผลิต</h4>
             <span class="badge bg-primary bg-opacity-10 text-primary" id="queue-machine-name">-</span>
          </div>
          <div class="d-flex gap-2">
            <button onclick="openDailyPlanModal()" class="btn btn-warning text-dark fw-bold shadow-sm" title="จัดแผนผลิตวันนี้">
              <i class="fa-solid fa-calendar-day"></i> จัดแผน
            </button>
            <button onclick="openAddJobModal()" class="btn btn-primary btn-add-job text-white" title="เพิ่มแผนผลิต"><i class="fa-solid fa-plus"></i></button>
            <button onclick="goHome()" class="btn btn-light rounded-circle shadow-sm" style="width:40px; height:40px;"><i class="fa-solid fa-chevron-left"></i></button>
          </div>
        </div>

        <div id="back-to-run-area" class="mb-3" style="display:none;">
            <button onclick="backToRunning()" class="btn btn-success w-100 py-3 shadow-sm rounded-4 fw-bold border-0" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="pulse-running me-2"></div> <!-- ตัวกะพริบสีเขียว -->
                    <span>กลับไปหน้างานที่กำลังผลิต (RUNNING)</span>
                </div>
            </button>
        </div>

        <div id="queue-list-container"></div>
      </div>

      <!-- SCREEN 3: RUNNING -->
      <div id="screen-running" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="bg-white px-3 py-2 rounded-pill shadow-sm">
            <span class="fw-bold text-primary" id="run-machine-tag">-</span>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <!-- ปุ่มกลับหน้า Queue (ที่เพิ่มใหม่) -->
            <button onclick="setupQueue()" id="run-btn-queue" class="btn btn-light text-dark fw-bold small shadow-sm">
              <i class="fa-solid fa-list-check"></i> รายการแผน
            </button>
            
            <button onclick="openAddJobModal()" class="btn btn-light text-primary fw-bold shadow-sm rounded-circle" style="width:38px; height:38px; display:flex; align-items:center; justify-content:center;">
              <i class="fa-solid fa-plus"></i>
            </button>
            <button onclick="goHome()" id="run-btn-logout" class="btn btn-light text-danger fw-bold small shadow-sm"><i class="fa-solid fa-power-off"></i> Logout</button>
          </div>
        </div>

        <div class="card-custom mb-4 p-4 text-center text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
           <div class="badge bg-white text-success mb-2 px-3 py-1 rounded-pill">RUNNING</div>
           <h1 id="run-job-id" class="fw-bold mb-0">JOB-XXXX</h1>
           <p id="run-customer" class="mb-0 opacity-75 fw-bold">-</p>
        </div>
        <div class="row g-3 mb-4">
          <!-- 1. ปุ่มบันทึก (พระเอก): ใหญ่ เด่น สีทึบ -->
          <div class="col-12">
            <button class="btn w-100 py-4 shadow text-white" id="run-btn-record" onclick="openRecordModal(false)" 
                    style="background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); border-radius: 16px;">
              <div class="d-flex align-items-center justify-content-center flex-column">
                <i class="fa-solid fa-pen-to-square fa-3x mb-2"></i>
                <span class="fs-3 fw-bold">บันทึกผลการผลิต</span>
                <small class="opacity-75">Record Production</small>
              </div>
            </button>
          </div>
          
          <!-- 2. ปุ่มจบงาน (พระรอง): โปร่ง ขอบแดง มีเส้นประ -->
          <div class="col-12 mt-3">
          <button class="btn btn-outline-danger w-100 py-3 border-2 fw-bold" id="run-btn-finish" onclick="requestFinishJob()" 
                  style="border-radius: 12px; background-color: #fff5f5;">
            <i class="fa-solid fa-flag-checkered me-2"></i> จบงาน (Finish Job)
          </button>
        </div>
        </div>
        <h6 class="fw-bold text-muted ps-1 mb-3">ประวัติบันทึก</h6>
        <div id="history-list"></div>
      </div>

      <!-- SCREEN 4: DASHBOARD (Header Layout Fix) -->
      <div id="screen-dashboard" class="screen">
        
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2 dash-header-row">
          <!-- ฝั่งซ้าย: Title & Auto Switch -->
          <div>
            <h4 class="fw-bold m-0"><i class="fa-solid fa-chart-line text-primary"></i> Machine Monitor</h4>
            <div class="d-flex align-items-center gap-2 mt-1">
              <small class="text-muted">Real-time status</small>
              <!-- Auto Refresh Switch -->
              <div class="form-check form-switch ms-3">
                  <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
                  <label class="form-check-label small fw-bold text-secondary" for="auto-refresh-toggle">
                    <i class="fa-solid fa-rotate"></i> Auto (30s)
                  </label>
              </div>
            </div>
          </div>

          <!-- ฝั่งขวา: Filter & Buttons (จัดกลุ่มใหม่) -->
          <div class="d-flex flex-wrap align-items-center gap-2 justify-content-end dash-filter-wrap">
            
            <!-- 1. GROUP FILTER: รวม Status + Date + Clear ไว้ในก้อนเดียว -->
            <div class="input-group input-group-sm shadow-sm" style="width: auto; min-width: 0;">
              <!-- Icon -->
              <span class="input-group-text bg-white text-muted"><i class="fa-solid fa-filter"></i></span>
              
              <!-- Status Select -->
            <div class="d-flex align-items-center gap-2 bg-light px-2 py-1 rounded border">
                <div class="form-check form-check-inline m-0">
                    <input class="form-check-input" type="checkbox" id="chk-running" value="Running" checked onchange="showDashboard()">
                    <label class="form-check-label small fw-bold text-success" for="chk-running">Run</label>
                </div>
                <div class="form-check form-check-inline m-0">
                    <input class="form-check-input" type="checkbox" id="chk-waiting" value="Waiting" checked onchange="showDashboard()">
                    <label class="form-check-label small fw-bold text-secondary" for="chk-waiting">Wait</label>
                </div>
                <div class="form-check form-check-inline m-0">
                    <input class="form-check-input" type="checkbox" id="chk-finished" value="Finished" onchange="showDashboard()">
                    <label class="form-check-label small fw-bold text-muted" for="chk-finished">Fin</label>
                </div>
            </div>

              <!-- Date Range -->
              <input type="date" id="monitor-date-start" class="form-control border-start-0" onchange="showDashboard()">
              <span class="input-group-text bg-white text-muted">ถึง</span>
              <input type="date" id="monitor-date-end" class="form-control border-start-0" onchange="showDashboard()">
              
              <!-- Clear Button -->
              <button class="btn btn-light border text-secondary" onclick="clearMonitorFilter()" title="Clear Filter">
                  <i class="fa-solid fa-rotate-left"></i>
              </button>
            </div>

            <!-- 2. ACTION BUTTONS: แยกออกมา -->
            <div class="d-flex gap-1">
              <button onclick="showExecDashboard()" class="btn btn-primary btn-sm px-3 shadow-sm text-nowrap">
                <i class="fa-solid fa-chart-pie me-1"></i> Analytics
              </button>
              <button onclick="goHome()" class="btn btn-light btn-sm rounded shadow-sm border px-3" title="Close">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            
          </div>
        </div>
        <!-- Container สำหรับการ์ดเครื่องจักร (เหมือนเดิม ไม่ต้องแก้) -->
        <div id="dash-container"></div>

        <!-- MOBILE APP VIEW (แสดงเฉพาะบน mobile ≤700px) -->
        <div id="mobile-dash" style="display:none;">
          <!-- Top bar -->
          <div class="mob-topbar">
            <div>
              <div class="fw-bold" style="font-size:1.1rem;">Machine Monitor</div>
              <div class="text-muted" style="font-size:0.72rem;" id="mob-last-update">-</div>
            </div>
            <div class="d-flex gap-2">
              <button onclick="showExecDashboard()" class="btn btn-sm btn-light border shadow-sm rounded-pill px-3">
                <i class="fa-solid fa-chart-pie text-primary me-1"></i> Analytics
              </button>
              <button onclick="goHome()" class="btn btn-sm btn-light border shadow-sm rounded-circle" style="width:34px;height:34px;">
                <i class="fa-solid fa-xmark text-muted"></i>
              </button>
            </div>
          </div>

          <!-- Stat summary -->
          <div class="mob-stat-bar" id="mob-stat-bar">
            <div class="mob-stat-card">
              <div class="mob-stat-num text-success" id="mob-stat-run">-</div>
              <div class="mob-stat-label">Running</div>
            </div>
            <div class="mob-stat-card">
              <div class="mob-stat-num text-secondary" id="mob-stat-wait">-</div>
              <div class="mob-stat-label">Waiting</div>
            </div>
            <div class="mob-stat-card">
              <div class="mob-stat-num text-primary" id="mob-stat-total">-</div>
              <div class="mob-stat-label">Total Jobs</div>
            </div>
          </div>

          <!-- Machine accordion list -->
          <div id="mob-machine-list"></div>
        </div>

      </div>

      <!-- MOBILE BOTTOM NAV (global, fixed) -->
      <div id="mobile-bottom-nav" style="display:none;">
        <button class="mob-nav-btn" id="mob-nav-home" onclick="goHome()">
          <i class="fa-solid fa-house"></i>
          <span>หน้าหลัก</span>
        </button>
        <button class="mob-nav-btn" id="mob-nav-monitor" onclick="showDashboard()">
          <i class="fa-solid fa-gauge-high"></i>
          <span>Monitor</span>
        </button>
        <button class="mob-nav-btn record-btn" id="mob-nav-record" style="display:none;" onclick="openRecordModal(false)">
          <i class="fa-solid fa-pen-to-square"></i>
          <span>บันทึก</span>
        </button>
        <button class="mob-nav-btn" id="mob-nav-queue" onclick="setupQueue()">
          <i class="fa-solid fa-list-check"></i>
          <span>Queue</span>
        </button>
        <button class="mob-nav-btn" id="mob-nav-analytics" onclick="showExecDashboard()">
          <i class="fa-solid fa-chart-pie"></i>
          <span>Analytics</span>
        </button>
      </div>

      <!-- SCREEN 5: EXECUTIVE DASHBOARD (Analytics) -->
      <div id="screen-dashboard-exec" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h4 class="fw-bold m-0 text-primary">Executive Dashboard</h4>
            <small class="text-muted">Production Summary</small>
          </div>
          <div class="d-flex gap-2">
            <!-- ปุ่มสลับกลับไปหน้า Monitor -->
            <button onclick="showDashboard()" class="btn btn-outline-secondary shadow-sm">
              <i class="fa-solid fa-server me-1"></i> Monitor
            </button>
            <button onclick="goHome()" class="btn btn-light rounded-circle shadow-sm" style="width:40px; height:40px;">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="card-custom p-3 mb-4 bg-white">
          <div class="row g-2 align-items-end">
            <div class="col-md-3 col-6">
              <label class="small fw-bold text-muted">Start Date</label>
              <input type="date" id="dash-date-start" class="form-control form-control-sm">
            </div>
            <div class="col-md-3 col-6">
              <label class="small fw-bold text-muted">End Date</label>
              <input type="date" id="dash-date-end" class="form-control form-control-sm">
            </div>
            <div class="col-md-3 col-6">
              <label class="small fw-bold text-muted">Machine</label>
              <select id="dash-filter-machine" class="form-select form-select-sm">
                <option value="ALL">All Machines</option>
              </select>
            </div>
            <div class="col-md-3 col-6">
              <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="refreshExecDashboard()">
                <i class="fa-solid fa-filter me-1"></i> Apply Filter
              </button>
            </div>
            <div class="col-md-2 col-12">
              <button class="btn btn-success btn-sm w-100 fw-bold" onclick="exportToExcel()">
                <i class="fa-solid fa-file-excel me-1"></i> Export
              </button>
            </div>
          </div>
        </div>

          <div class="card-custom bg-white mb-3 border-start border-4 border-primary shadow-sm">
              <div class="row g-0">
                  <!-- ฝั่งซ้าย: Daily Progress -->
                  <div class="col-md-4 p-3 border-end">
                      <h6 class="fw-bold text-muted text-uppercase small mb-3">Daily Progress</h6>
                      <div class="d-flex justify-content-between align-items-end mb-2">
                          <h2 class="fw-bold text-primary m-0">
                              <span id="fac-actual">0</span> 
                              <small class="fs-6 text-muted">/ <span id="fac-plan">0</span></small>
                          </h2>
                          <h3 class="fw-bold text-dark m-0" id="fac-percent">0%</h3>
                      </div>
                      <div class="progress" style="height: 10px; border-radius: 5px; background: #f1f5f9;">
                          <div id="fac-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                      </div>
                  </div>

                  <!-- ฝั่งขวา: Machine Activity Timeline (ปรับให้สูงขึ้นและใหญ่ขึ้น) -->
                  <div class="col-md-8 p-3 bg-light bg-opacity-50" id="timeline-card-node">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                          <h6 class="fw-bold text-muted text-uppercase small m-0">
                              <i class="fa-solid fa-clock-rotate-left me-1 text-info"></i> Machine Activity Timeline
                          </h6>
                          <div class="d-flex gap-2">
                              <button class="btn btn-sm btn-light border py-0" onclick="toggleTimelineFullscreen()" title="ขยายเต็มจอ">
                                  <i class="fa-solid fa-expand"></i>
                              </button>
                              <button class="btn btn-sm btn-danger btn-close-fullscreen py-0" onclick="toggleTimelineFullscreen()">
                                  ปิดหน้าต่างขยาย
                              </button>
                              <div style="font-size: 9px;">
                                  <span class="badge bg-success">Finished</span>
                                  <span class="badge bg-primary">Running</span>
                              </div>
                          </div>
                      </div>
                      <!-- ปรับความสูงตั้งต้นให้สูงขึ้นเพื่อเครื่องจักร SM04 และ SANDBOX -->
                      <div id="chart-height-control" style="height: 150px; position: relative;">
                          <canvas id="timelineChart"></canvas>
                      </div>
                  </div>
              </div>
          </div>

        <!-- KPI Cards -->
        <div class="row g-3 mb-4">
          <div class="col-6 col-md-3">
            <div class="card-custom p-3 h-100 border-start border-4 border-primary">
              <div class="text-muted small fw-bold text-uppercase">Total Weight</div>
              <div class="d-flex align-items-baseline mt-1">
                <h3 class="fw-bold text-dark m-0 me-1" id="kpi-weight">0</h3><span class="small text-muted">kg</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card-custom p-3 h-100 border-start border-4 border-success">
              <div class="text-muted small fw-bold text-uppercase">Total Coils</div>
              <div class="d-flex align-items-baseline mt-1">
                <h3 class="fw-bold text-dark m-0 me-1" id="kpi-coils">0</h3><span class="small text-muted">pcs</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card-custom p-3 h-100 border-start border-4 border-info">
              <div class="text-muted small fw-bold text-uppercase">Active Jobs</div>
              <div class="d-flex align-items-baseline mt-1">
                <h3 class="fw-bold text-dark m-0 me-1" id="kpi-jobs">0</h3><span class="small text-muted">Jobs</span>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card-custom p-3 h-100 border-start border-4 border-danger">
              <div class="text-muted small fw-bold text-uppercase">QC Alerts</div>
              <div class="d-flex align-items-baseline mt-1">
                <h3 class="fw-bold text-danger m-0 me-1" id="kpi-qc">0</h3><span class="small text-muted">Times</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Area -->
        <div class="row g-3 mb-4">
          <div class="col-md-8">
            <div class="card-custom p-3 h-100">
              <h6 class="fw-bold text-muted mb-3">Production by Machine (kg)</h6>
              <div style="height: 250px;"><canvas id="dashChartMain"></canvas></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-custom p-3 h-100">
              <h6 class="fw-bold text-muted mb-3">Job Status</h6>
              <div style="height: 200px; display:flex; justify-content:center;"><canvas id="dashChartPie"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Detailed Table -->
        <div class="card-custom p-0 overflow-hidden mb-4">
            <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                <h6 class="fw-bold m-0 text-secondary"><i class="fa-solid fa-list-ul me-2"></i>Recent Logs</h6>
                <!-- ช่องเลือกจำนวนแถว -->
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">แสดง:</small>
                    <select id="dash-log-limit" class="form-select form-select-sm" style="width: 85px; border-radius: 8px;" onchange="refreshExecDashboard()">
                        <option value="10">10 แถว</option>
                        <option value="20" selected>20 แถว</option>
                        <option value="50">50 แถว</option>
                        <option value="100">100 แถว</option>
                        <option value="99999">ทั้งหมด</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 450px;">
                <table class="table table-hover align-middle mb-0 text-center" style="font-size: 0.85rem;">
                    <thead class="table-light text-secondary sticky-top">
                        <tr>
                            <th>Time</th>
                            <th>Machine</th>
                            <th>Job ID</th>
                            <th>Coil</th>
                            <th>Weight</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dash-table-body">
                        <!-- ข้อมูลจะถูกเติมตรงนี้ -->
                        <tr><td colspan="6" class="py-4 text-muted">กำลังโหลดข้อมูล...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card-custom p-3 mb-4 bg-white border-top border-4 border-warning">
            <h6 class="fw-bold mb-3"><i class="fa-solid fa-filter text-warning"></i> กรองข้อมูลแนวโน้มความหนา (5 ตำแหน่ง)</h6>
            
            <!-- แถวที่ 1: การเลือกสเปกงาน -->
            <div class="row g-2 mb-2">
                <div class="col-md-3 col-12">
                    <label class="small fw-bold">ค้นหาด่วน (Job ID / ลูกค้า)</label>
                    <input type="text" id="trend-search" class="form-control form-control-sm" placeholder="เช่น J-2024 หรือ ชื่อลูกค้า">
                </div>
                <div class="col-md-2 col-6">
                    <label class="small fw-bold">Mill Group</label>
                    <select id="trend-mill-group" class="form-select form-select-sm" onchange="updateThicknessDropdown()">
                        <option value="ALL">ALL</option>
                        <option value="SA">SA</option>
                        <option value="GJ">GJ</option>
                        <option value="GS">GS</option>
                        <option value="BSP">BSP</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="small fw-bold">ความหนาเป้าหมาย</label>
                    <select id="trend-thickness" class="form-select form-select-sm">
                        <option value="">-- เลือกขนาด --</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="small fw-bold">จุดที่แสดงผล</label>
                    <select id="trend-point-type" class="form-select form-select-sm">
                        <option value="AVG" selected>ค่าเฉลี่ย (1+2+3)</option>
                        <option value="1">จุดที่ 1</option>
                        <option value="2">จุดที่ 2</option>
                        <option value="3">จุดที่ 3</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="small fw-bold">ประเภทงาน</label>
                    <select id="trend-work-type" class="form-select form-select-sm">
                        <option value="ALL">ทุกประเภท</option>
                        <option value="ท่อเหลี่ยม">ท่อเหลี่ยม</option>
                        <option value="ท่อกลม">ท่อกลม</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="small fw-bold">เครื่องจักร</label>
                    <select id="trend-machine" class="form-select form-select-sm">
                        <option value="ALL">รวมทุกเครื่อง</option>
                    </select>
                </div>
            </div>

            <!-- แถวที่ 2: ช่วงวันที่ และปุ่มค้นหา -->
            <div class="row g-2 align-items-end mb-3">
                <div class="col-md-5 col-6">
                    <label class="small fw-bold">ตั้งแต่วันที่</label>
                    <input type="date" id="trend-date-start" class="form-control form-control-sm">
                </div>
                <div class="col-md-5 col-6">
                    <label class="small fw-bold">ถึงวันที่</label>
                    <input type="date" id="trend-date-end" class="form-control form-control-sm">
                </div>
                <div class="col-md-2 col-12">
                    <button class="btn btn-warning btn-sm w-100 fw-bold shadow-sm" onclick="loadTrendChart()">
                        <i class="fa-solid fa-magnifying-glass"></i> พลอตกราฟ
                    </button>
                </div>
            </div>

            <div style="height: 350px;"><canvas id="trendChart"></canvas></div>

            <div id="trend-stats-container" class="mt-3" style="display:none;">
                <!-- ใช้ g-2 เพื่อเว้นช่องว่างระหว่างกล่องเล็กน้อย -->
                <div class="row g-2">
                    
                    <!-- กล่องที่ 1: ค่าเฉลี่ย -->
                    <div class="col-6 col-md-3">
                        <div class="p-2 border rounded bg-white shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                            <small class="text-muted d-block" style="font-size: 0.75rem;">ค่าเฉลี่ยรวม</small>
                            <strong class="fs-5 text-primary" id="stat-avg">0.000</strong>
                        </div>
                    </div>

                    <!-- กล่องที่ 2: เกณฑ์ -->
                    <div class="col-6 col-md-3">
                        <div class="p-2 border rounded bg-white shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                            <small class="text-muted d-block" style="font-size: 0.75rem;">เกณฑ์ (Min-Max)</small>
                            <strong class="fs-5 text-dark" id="stat-spec-range">0.00 - 0.00</strong>
                        </div>
                    </div>

                    <!-- กล่องที่ 3: Cp -->
                    <div class="col-6 col-md-3">
                        <div class="p-2 border rounded bg-white shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                            <small class="text-muted d-block" style="font-size: 0.75rem;">Cp (ความนิ่ง)</small>
                            <strong class="fs-5 text-dark" id="stat-cp">0.00</strong>
                        </div>
                    </div>

                    <!-- กล่องที่ 4: Cpk -->
                    <div class="col-6 col-md-3">
                        <div class="p-2 border rounded bg-white shadow-sm text-center h-100 d-flex flex-column justify-content-center">
                            <small class="text-muted d-block" style="font-size: 0.75rem;">Cpk (คุณภาพ)</small>
                            <strong class="fs-5 text-dark" id="stat-cpk">0.00</strong>
                        </div>
                    </div>

                </div>

                <!-- แถบสรุปผลด้านล่าง -->
                <div class="mt-2 p-2 border rounded bg-light shadow-sm" id="stat-interpretation" style="font-size: 0.85rem;">
                    <!-- คำอธิบายผล -->
                </div>
            </div>
            </div>
        </div>
      </div>

    </div>

<!-- MODAL 1: RECORD PRODUCTION (REDESIGNED) -->
<div class="modal fade" id="modal-record" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <form id="record-form">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h5 class="modal-title fw-bold text-primary"><i class="fa-solid fa-pen-to-square"></i> บันทึกผลการผลิต</h5>
                        <small class="text-muted" id="record-subtitle">กรุณากรอกข้อมูลให้ครบถ้วน</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body bg-light rounded-4 m-2 p-2"> <!-- ปรับ padding มวลรวมให้เล็กลงเพื่อพื้นที่มือถือ -->
                    <input type="hidden" name="jobId" id="input-job-id">
                    <input type="hidden" name="machine" id="input-machine">
                    <input type="hidden" name="rowId" id="input-row-id">
                    <input type="hidden" name="oldImageUrl" id="input-old-img">
                    <input type="hidden" name="orderNo">

                    <!-- [CARD 1] ส่วนข้อมูลการผลิตและน้ำหนัก -->
                    <div class="card-custom p-3 mb-3 bg-white shadow-sm border-0">
                        <h6 class="text-primary fw-bold mb-3"><i class="fa-solid fa-tag me-2"></i>ข้อมูลการผลิต</h6>
                        <div class="row g-2 mb-3 border-bottom pb-3">
                            <div class="col-6">
                                <label class="small fw-bold text-muted">MILL NO.</label>
                                <input type="text" name="millNo" class="form-control fw-bold big-input" placeholder="เบอร์ Mill" required>
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-muted">COIL SEQ.</label>
                                <input type="text" name="coilNo" class="form-control fw-bold big-input" placeholder="1/4" required>
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-7">
                                <label class="small fw-bold text-muted">น้ำหนัก (WEIGHT KG)</label>
                                <div class="input-group">
                                    <input type="number" name="weight" inputmode="decimal" class="form-control fw-bold text-primary big-input border-end-0" placeholder="0" required>
                                    <span class="input-group-text bg-white border-start-0 text-muted">KG</span>
                                </div>
                            </div>
                            <div class="col-5">
                                <label class="small fw-bold text-muted">THICKNESS (หนา)</label>
                                <input type="number" step="0.001" id="disp-target-thick" class="form-control text-center fw-bold bg-white big-input" placeholder="0.000">
                            </div>
                        </div>
                    </div>

                    <!-- [CARD 2] ส่วน Traceability และ QR Scanner -->
                    <div class="card-custom p-3 mb-3 bg-white shadow-sm border-0">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary fw-bold m-0"><i class="fa-solid fa-link me-2"></i>Traceability</h6>
                            <button type="button" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="openQRScanner()">
                                <i class="fa-solid fa-qrcode me-1"></i> สแกน QR Tag
                            </button>
                        </div>

                        <div id="qr-reader-container" style="display:none; border: 2px dashed #4361ee; border-radius: 12px; overflow: hidden; background: #f8fafc;" class="mb-3 p-2">
                            <!-- รายการเลือกกล้อง -->
                            <div class="mb-2">
                                <label class="small fw-bold text-muted"><i class="fa-solid fa-video"></i> เลือกเลนส์กล้อง:</label>
                                <select id="qr-camera-select" class="form-select form-select-sm border-primary" onchange="switchCamera(this.value)"></select>
                            </div>
                            
                            <div id="qr-reader" style="width:100%; border-radius: 8px; overflow: hidden;"></div>
                            <div id="qr-reader-file" style="display:none;"></div>
                            
                            <button type="button" class="btn btn-danger btn-sm w-100 mt-2 shadow-sm" onclick="stopQRScanner()">
                                <i class="fa-solid fa-video-slash"></i> ปิดกล้อง
                            </button>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="keep-trace-data" checked>
                            <label class="form-check-label small text-muted" for="keep-trace-data">จำค่า TMT/Heat/M-Coil ไว้</label>
                        </div>

                        <div class="row g-2">
                            <div class="col-12 mb-2">
                                <div class="form-floating">
                                    <input type="text" name="tmtNo" class="form-control border-0 shadow-sm bg-light" id="floatTMT" placeholder="TMT No">
                                    <label for="floatTMT" class="small text-muted">TMT NO. (Batch No)</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="text" name="heatNo" class="form-control border-0 shadow-sm bg-light" id="floatHeat" placeholder="Heat No">
                                    <label for="floatHeat" class="small text-muted">HEAT NO.</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="text" name="mCoil" class="form-control border-0 shadow-sm bg-light" id="floatMCoil" placeholder="Coil No">
                                    <label for="floatMCoil" class="small text-muted">COIL NO.</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- [TABS] ระบบเลือกตำแหน่ง (Head / Mid / Tail) -->
                    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item"><button type="button" class="nav-link active" onclick="switchRecordTab('H')">ต้นม้วน</button></li>
                        <li class="nav-item"><button type="button" class="nav-link" onclick="switchRecordTab('HM')">30m แรก</button></li>
                        <li class="nav-item"><button type="button" class="nav-link" onclick="switchRecordTab('M')">กลางม้วน</button></li>
                        <li class="nav-item"><button type="button" class="nav-link" onclick="switchRecordTab('MT')">30m ท้าย</button></li>
                        <li class="nav-item"><button type="button" class="nav-link" onclick="switchRecordTab('T')">ท้ายม้วน</button></li>
                        <li class="nav-item"><button type="button" class="nav-link bg-warning bg-opacity-10 text-dark border-warning" onclick="switchRecordTab('Review')">ตรวจสอบ</button></li>
                    </ul>

                    <!-- พื้นที่กรอกข้อมูล Thick/Width (จะเปลี่ยนไปตาม Tab) -->
                    <div class="card-custom p-3 mb-3 bg-white border-0 shadow-sm">
                        <!-- ตัวอย่าง Section: HEAD (Section อื่นๆ ให้ใส่ต่อตามลำดับเหมือนเดิม) -->
                        <div id="sec-H" class="input-section active">
                            <h6 class="fw-bold text-primary mb-3"><i class="fa-solid fa-arrow-right"></i> ช่วง: ต้นม้วน (H)</h6>
                            <div class="ai-hint-bar" id="hint-H">
                                <span class="hint-label"><i class="fa-solid fa-microchip"></i> AI แนะนำ:</span>
                                <span class="hint-sep">|</span>
                                <span class="ai-hint-group">
                                    <span class="hint-tag">t1</span>
                                    <span class="ai-hint-badge" id="hint-H1">—</span>
                                </span>
                                <span class="hint-sep">|</span>
                                <span class="ai-hint-group">
                                    <span class="hint-tag">t2</span>
                                    <span class="ai-hint-badge" id="hint-H2">—</span>
                                </span>
                                <span class="hint-sep">|</span>
                                <span class="ai-hint-group">
                                    <span class="hint-tag">t3</span>
                                    <span class="ai-hint-badge" id="hint-H3">—</span>
                                </span>
                            </div>
                            <div class="row g-2">
                                <div class="col-6"><label class="small text-muted">ความกว้าง</label><input type="number" step="0.01" name="widthH" class="form-control big-input"></div>
                                <div class="col-6"><label class="small text-muted">สภาพผิว</label><input type="text" name="condH" class="form-control big-input"></div>
                                <div class="col-4"><label class="small text-muted">Thick 1</label><input type="number" step="0.001" name="thickH1" class="form-control big-input qc-thick"></div>
                                <div class="col-4"><label class="small text-muted">Thick 2</label><input type="number" step="0.001" name="thickH2" class="form-control big-input qc-thick"></div>
                                <div class="col-4"><label class="small text-muted">Thick 3</label><input type="number" step="0.001" name="thickH3" class="form-control big-input qc-thick"></div>
                            </div>
                        </div>

                <!-- SECTION: HM -->
                <div id="sec-HM" class="input-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-primary m-0"><i class="fa-solid fa-arrow-right"></i> 30m แรก (HM)</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary border-0" onclick="copyFromPrevious('HM')"><i class="fa-solid fa-copy"></i> ดึงจากจุดก่อนหน้า</button>
                    </div>
                    <div class="ai-hint-bar" id="hint-HM">
                        <span class="hint-label"><i class="fa-solid fa-microchip"></i> AI แนะนำ:</span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t1</span>
                            <span class="ai-hint-badge" id="hint-HM1">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t2</span>
                            <span class="ai-hint-badge" id="hint-HM2">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t3</span>
                            <span class="ai-hint-badge" id="hint-HM3">—</span>
                        </span>
                    </div>
                    <div class="row g-2">
                        <div class="col-6"><label class="small text-muted">ความกว้าง</label><input type="number" step="0.01" name="widthHM" class="form-control big-input"></div>
                        <div class="col-6"><label class="small text-muted">สภาพผิว</label><input type="text" name="condHM" class="form-control big-input"></div>
                        <div class="col-4"><label class="small text-muted">Thick 1</label><input type="number" step="0.001" name="thickHM1" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 2</label><input type="number" step="0.001" name="thickHM2" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 3</label><input type="number" step="0.001" name="thickHM3" class="form-control big-input qc-thick"></div>
                    </div>
                </div>

                <!-- SECTION: MID -->
                <div id="sec-M" class="input-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-primary m-0"><i class="fa-solid fa-arrow-right"></i> กลางม้วน (M)</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary border-0" onclick="copyFromPrevious('M')"><i class="fa-solid fa-copy"></i> ดึงจากจุดก่อนหน้า</button>
                    </div>
                    <div class="ai-hint-bar" id="hint-M">
                        <span class="hint-label"><i class="fa-solid fa-microchip"></i> AI แนะนำ:</span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t1</span>
                            <span class="ai-hint-badge" id="hint-M1">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t2</span>
                            <span class="ai-hint-badge" id="hint-M2">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t3</span>
                            <span class="ai-hint-badge" id="hint-M3">—</span>
                        </span>
                    </div>
                    <div class="row g-2">
                        <div class="col-6"><label class="small text-muted">ความกว้าง</label><input type="number" step="0.01" name="widthM" class="form-control big-input"></div>
                        <div class="col-6"><label class="small text-muted">สภาพผิว</label><input type="text" name="condM" class="form-control big-input"></div>
                        <div class="col-4"><label class="small text-muted">Thick 1</label><input type="number" step="0.001" name="thickM1" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 2</label><input type="number" step="0.001" name="thickM2" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 3</label><input type="number" step="0.001" name="thickM3" class="form-control big-input qc-thick"></div>
                    </div>
                </div>

                <!-- SECTION: MT -->
                <div id="sec-MT" class="input-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-primary m-0"><i class="fa-solid fa-arrow-right"></i> 30m ท้าย (MT)</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary border-0" onclick="copyFromPrevious('MT')"><i class="fa-solid fa-copy"></i> ดึงจากจุดก่อนหน้า</button>
                    </div>
                    <div class="ai-hint-bar" id="hint-MT">
                        <span class="hint-label"><i class="fa-solid fa-microchip"></i> AI แนะนำ:</span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t1</span>
                            <span class="ai-hint-badge" id="hint-MT1">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t2</span>
                            <span class="ai-hint-badge" id="hint-MT2">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t3</span>
                            <span class="ai-hint-badge" id="hint-MT3">—</span>
                        </span>
                    </div>
                    <div class="row g-2">
                        <div class="col-6"><label class="small text-muted">ความกว้าง</label><input type="number" step="0.01" name="widthMT" class="form-control big-input"></div>
                        <div class="col-6"><label class="small text-muted">สภาพผิว</label><input type="text" name="condMT" class="form-control big-input"></div>
                        <div class="col-4"><label class="small text-muted">Thick 1</label><input type="number" step="0.001" name="thickMT1" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 2</label><input type="number" step="0.001" name="thickMT2" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 3</label><input type="number" step="0.001" name="thickMT3" class="form-control big-input qc-thick"></div>
                    </div>
                </div>

                <!-- SECTION: TAIL -->
                <div id="sec-T" class="input-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-primary m-0"><i class="fa-solid fa-arrow-right"></i> ท้ายม้วน (T)</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary border-0" onclick="copyFromPrevious('T')"><i class="fa-solid fa-copy"></i> ดึงจากจุดก่อนหน้า</button>
                    </div>
                    <div class="ai-hint-bar" id="hint-T">
                        <span class="hint-label"><i class="fa-solid fa-microchip"></i> AI แนะนำ:</span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t1</span>
                            <span class="ai-hint-badge" id="hint-T1">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t2</span>
                            <span class="ai-hint-badge" id="hint-T2">—</span>
                        </span>
                        <span class="hint-sep">|</span>
                        <span class="ai-hint-group">
                            <span class="hint-tag">t3</span>
                            <span class="ai-hint-badge" id="hint-T3">—</span>
                        </span>
                    </div>
                    <div class="row g-2">
                        <div class="col-6"><label class="small text-muted">ความกว้าง</label><input type="number" step="0.01" name="widthT" class="form-control big-input"></div>
                        <div class="col-6"><label class="small text-muted">สภาพผิว</label><input type="text" name="condT" class="form-control big-input"></div>
                        <div class="col-4"><label class="small text-muted">Thick 1</label><input type="number" step="0.001" name="thickT1" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 2</label><input type="number" step="0.001" name="thickT2" class="form-control big-input qc-thick"></div>
                        <div class="col-4"><label class="small text-muted">Thick 3</label><input type="number" step="0.001" name="thickT3" class="form-control big-input qc-thick"></div>
                    </div>
                </div>
            </div>

              <!-- SECTION: REVIEW (SUMMARY) -->
              <div id="sec-Review" class="input-section">
                  <h6 class="fw-bold text-dark mb-3"><i class="fa-solid fa-list-check"></i> สรุปข้อมูลที่กรอก</h6>
                  <div class="table-responsive rounded border">
                      <table class="table table-bordered table-sm text-center mb-0" style="font-size: 0.85rem;">
                          <thead class="table-light">
                              <tr>
                                  <th>Position</th>
                                  <th>Width</th>
                                  <th>Thick 1</th>
                                  <th>Thick 2</th>
                                  <th>Thick 3</th>
                                  <th>Cond</th>
                              </tr>
                          </thead>
                          <tbody id="review-table-body">
                              <!-- Data will be injected here by JS -->
                          </tbody>
                      </table>
                  </div>
                  <div class="alert alert-info mt-3 mb-0 small">
                      <i class="fa-solid fa-circle-info"></i> ตรวจสอบความถูกต้องก่อนกดบันทึกด้านล่าง
                  </div>
              </div>              

                    <!-- Note & Image & Simulation -->
                    <div class="card-custom p-3 mb-3 bg-white border-0 shadow-sm">
                        <div class="mb-3">
                            <input type="text" name="note" class="form-control" placeholder="หมายเหตุ (Note)">
                        </div>
                        <div class="mb-0">
                            <label class="small fw-bold text-muted"><i class="fa-solid fa-camera"></i> แนบรูปถ่าย</label>
                            <input type="file" id="file-upload" class="form-control" multiple accept="image/*">
                        </div>
                    </div>

                    <!-- Simulation Preview -->
                    <div class="profile-preview-box">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold text-muted">Simulation (จำลองหน้าตัด)</span>
                            <div>
                                <span id="live-crown-val" class="stat-badge-crown bg-primary text-white">Crown: 0.000</span>
                                <span id="live-wedge-val" class="stat-badge-crown bg-warning text-dark">Wedge: 0.000</span>
                            </div>
                        </div>
                        <canvas id="profileCanvas" width="300" height="60" style="width:100%; height:60px;"></canvas>
                    </div>
                </div> <!-- END modal-body -->

                <!-- วางทับส่วน Slitting Pre-plan เดิมใน modal-record ทั้งหมด (เอาอันที่ซ้ำออกให้หมด) -->
                <div class="card-custom p-3 mb-3 bg-white border-0 shadow-sm">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fa-solid fa-scissors text-primary"></i>
                            <label class="small fw-bold text-primary m-0">วางแผนการซอย (Slit Plan)</label>
                        </div>
                        <div id="record-re-slit-area" style="display:none;">
                            <button type="button" class="btn btn-sm btn-danger py-0 px-2" onclick="confirmDeleteExistingSlits()" style="font-size:10px;">
                                <i class="fa-solid fa-trash-can"></i> ลบข้อมูลเดิมในคลัง
                            </button>
                        </div>
                    </div>

                    <!-- ช่องหน้ากว้างรวม -->
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <label class="small text-muted text-nowrap mb-0">หน้ากว้างรวม</label>
                        <div class="input-group input-group-sm" style="max-width:140px;">
                            <input type="number" id="record-strip-width" class="form-control fw-bold"
                                   placeholder="เช่น 1219" step="0.01"
                                   oninput="updateRecordSlitPreview()">
                            <span class="input-group-text">mm</span>
                        </div>
                        <span class="text-muted small" id="record-strip-width-hint"></span>
                    </div>

                    <!-- hidden input เก็บค่าจริง -->
                    <input type="hidden" name="slitPlan" id="input-slit-plan">

                    <div class="d-flex justify-content-end mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                onclick="addRecordSlitRow()">
                            <i class="fa-solid fa-plus me-1"></i> เพิ่มเส้น
                        </button>
                    </div>

                    <div id="record-slit-rows"></div>

                    <div id="record-slit-preview" class="mt-2" style="display:none;">
                        <div class="d-flex rounded overflow-hidden" id="record-slit-bar"
                            style="height:22px; border:1px solid #e2e8f0;"></div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="badge bg-light text-dark border" id="preplan-count" style="font-size:9px;">0 เส้น</span>
                            <span class="badge bg-light text-danger border" id="preplan-scrap" style="font-size:9px;">Scrap: - mm</span>
                        </div>
                    </div>

                    <div id="slit-already-exists-msg" class="text-danger mt-1 fw-bold" style="font-size:10px; display:none;">
                        ⚠️ ม้วนนี้บันทึกเข้าคลังแล้ว หากจะแก้ต้องกด 'ลบข้อมูลเดิม'
                    </div>
                </div>

                <div class="modal-footer border-0 p-3 pt-0">
                    <button type="submit" class="btn-main w-100 shadow-sm py-3" id="btn-save">บันทึกข้อมูลการผลิต</button>
                </div>

                <!-- Sandbox Tools Panel (จะแสดงผลเฉพาะเครื่อง SANDBOX) -->
                <div id="sandbox-panel" class="mt-3 p-3 border-top" style="display:none; background: #fff3cd; border-radius: 0 0 15px 15px;">
                    <h6 class="text-dark fw-bold mb-2"><i class="fa-solid fa-flask"></i> Sandbox Test Tools</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="fillSandbox('normal')">เติมค่า: ปกติ</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="fillSandbox('thin')">เติมค่า: บาง (Alert แดง)</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillSandbox('thick')">เติมค่า: หนา (Alert น้ำเงิน)</button>
                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="fillSandbox('chaos')">สุ่มค่า: (ทดสอบสี 3D)</button>
                        <button type="button" class="btn btn-sm btn-danger ms-auto" onclick="confirmClearSandbox()">
                            <i class="fa-solid fa-trash-can"></i> ล้างข้อมูล Sandbox ทั้งหมด
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

    <!-- MODAL 2: ADD NEW JOB -->
    <div class="modal fade" id="modal-add-job" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <form id="add-job-form">
            <div class="modal-header border-0">
              <h5 class="modal-title fw-bold text-primary"><i class="fa-solid fa-calendar-plus me-2"></i>เพิ่มแผนการผลิต</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light rounded-4 m-3 p-4">
              <div class="mb-3">
                <label class="small fw-bold text-muted">MACHINE</label>
                <input type="text" name="newMachine" id="new-machine" class="form-control fw-bold bg-white text-primary" readonly>
              </div>
              <div class="mb-3">
                <label class="small fw-bold text-muted">JOB ID *</label>
                <input type="text" name="newJobId" class="form-control" placeholder="เช่น J-2023-001" required>
              </div>
              <div class="mb-3">
                <label class="small fw-bold text-muted">CUSTOMER</label>
                <input type="text" name="newCustomer" class="form-control" required>
              </div>
              <div class="row g-2 mb-3">
                 <div class="col-6"><label class="small fw-bold text-muted">PLAN DATE</label><input type="date" name="newDate" class="form-control" required></div>
                 <div class="col-6"><label class="small fw-bold text-muted">TOTAL COILS</label><input type="number" name="newCoils" class="form-control" required></div>
              </div>
              <div class="row g-2 mb-3">
                 <div class="col-6">
                    <label class="small fw-bold text-muted">FOR WORK</label>
                    <select name="newWorkType" class="form-select" required>
                       <option value="ท่อเหลี่ยม">ท่อเหลี่ยม</option>
                       <option value="ท่อกลม">ท่อกลม</option>
                       <option value="Other">Other</option>
                    </select>
                 </div>
                 <div class="col-6">
                    <label class="small fw-bold text-muted">THICKNESS (mm)</label>
                    <input type="number" step="0.01" name="newThickness" class="form-control" required>
                 </div>
              </div>
              <div class="mb-3">
                <label class="small fw-bold text-muted">MILL PLAN</label>
                <!-- แก้ไข: เพิ่ม list="mill-list-options" -->
                <input type="text" name="newMill" id="new-mill-input" class="form-control" placeholder="พิมพ์เพื่อค้นหา Mill..." list="mill-list-options" autocomplete="off">
                
              <!-- เพิ่มส่วน Slit Plan ใน add-job-form -->
              <div class="mb-3 px-1">
                  <label class="small fw-bold text-muted">
                      <i class="fa-solid fa-scissors text-primary me-1"></i> หน้าแถบรวม (mm) *
                  </label>
                  <input type="number" step="0.01" name="newStripWidth" id="new-strip-width" 
                        class="form-control fw-bold" placeholder="เช่น 1219" 
                        oninput="updateSlitPreview()">
              </div>

              <div class="mb-3 px-1">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="small fw-bold text-muted">
                          <i class="fa-solid fa-scissors text-primary me-1"></i> แผนการซอย (Slit Plan)
                      </label>
                      <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3"
                              onclick="addSlitRow()">
                          <i class="fa-solid fa-plus me-1"></i> เพิ่มเส้น
                      </button>
                  </div>

                  <!-- แถวซอยที่สร้างด้วย JS -->
                  <div id="slit-rows-container"></div>

                  <!-- Preview แถบสีแสดงสัดส่วน -->
                  <div id="slit-preview-bar" class="mt-2" style="display:none;">
                      <div class="d-flex rounded overflow-hidden" id="slit-color-bar" 
                          style="height: 22px; border: 1px solid #e2e8f0;"></div>
                      <div class="d-flex justify-content-between mt-1">
                          <small class="text-muted" id="slit-sum-label">รวม: 0 mm</small>
                          <small id="slit-scrap-label" class="fw-bold"></small>
                      </div>
                  </div>

                  <!-- ค่าที่จะส่งไปหลังบ้าน (comma-separated) -->
                  <input type="hidden" name="newSlitPlan" id="new-slit-plan-value">
              </div>

                <!-- เพิ่ม datalist สำหรับเก็บตัวเลือก -->
                <datalist id="mill-list-options"></datalist>
              </div>
              <div class="mb-2">
                 <label class="small fw-bold text-muted ms-1">รูปใบสั่งผลิต (1 รูป)</label>
                 <input type="file" id="new-job-file" class="form-control form-control-sm" accept="image/*">
              </div>
            </div>
            <div class="modal-footer border-0 p-3 pt-0">
              <button type="submit" class="btn-main w-100" id="btn-add-job-save">สร้างแผนงาน</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- MODAL 3: VIEW HISTORY (ปรับปรุงใหม่) -->
    <div class="modal fade" id="modal-view-history" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
          
          <!-- Header: แสดง Job ID และปุ่มปิด -->
          <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-center">
            <div>
              <h4 class="fw-bold text-primary m-0" id="hist-modal-title">Job ID</h4>
              <small class="text-muted" id="hist-modal-sub">Customer Name</small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body p-3">
            
            <!-- ส่วนหัวข้อวิเคราะห์ (ย้ายมาไว้ข้างล่าง Job ID) -->
            <div class="mb-2">
              <p class="analysis-title">
                <i class="fa-solid fa-chart-line text-primary"></i> วิเคราะห์ความหนา (ทุกลูก)
              </p>
            </div>

            <!-- ส่วนควบคุมกราฟ (จัดกลุ่มใหม่ ไม่ให้ทับกัน) -->
            <div class="chart-controls-container">
              <!-- แถวที่ 1: เลือกโหมด AVG/T1/T2/T3 -->
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="updateTrendMode('AVG', this)">AVG</button>
                <button type="button" class="btn btn-outline-primary" onclick="updateTrendMode('T1', this)">T1</button>
                <button type="button" class="btn btn-outline-primary" onclick="updateTrendMode('T2', this)">T2</button>
                <button type="button" class="btn btn-outline-primary" onclick="updateTrendMode('T3', this)">T3</button>
              </div>

              <!-- แถวที่ 2: เลือกโหมดแผนที่สี -->
              <div class="btn-group" role="group">
                <button type="button" id="btn-map-std" class="btn btn-dark active" onclick="setMapMode('STD')">Standard Map</button>
                <button type="button" id="btn-map-dev" class="btn btn-outline-danger" onclick="setMapMode('DEV')">Deviation (จุดเสีย)</button>
                <button type="button" id="btn-map-heat" class="btn btn-outline-warning" onclick="setMapMode('HEAT')">🔥 Heat Trail</button>
              </div>
            </div>

            <!-- พื้นที่กราฟ -->
            <div class="bg-white rounded-3 mb-4" style="height: 250px; position: relative;">
              <canvas id="job-trend-chart"></canvas>
            </div>

            <hr class="opacity-10">

            <!-- รายการประวัติม้วนด้านล่าง -->
            <div id="dash-history-list">
                <!-- ข้อมูลจะถูกโหลดใส่ที่นี่ -->
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- MODAL 4: DAILY PLAN -->
    <div class="modal fade" id="modal-daily-plan" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
          <div class="modal-header border-0 bg-warning bg-opacity-10">
            <h5 class="modal-title fw-bold text-dark"><i class="fa-solid fa-calendar-day me-2"></i>วางแผนการผลิตวันนี้</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body bg-white p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr class="text-secondary small text-uppercase">
                    <th class="ps-3">Job ID</th>
                    <th>Customer</th>
                    <th class="text-center">Total</th>
                    <th class="text-center">Done</th>
                    <th class="text-center text-primary" style="width: 150px;">Today Target</th>
                  </tr>
                </thead>
                <tbody id="daily-plan-list">
                  <!-- รายการ Job จะมาโผล่ตรงนี้ -->
                </tbody>
                <tfoot class="table-light border-top">
                   <tr>
                     <td colspan="4" class="text-end fw-bold text-muted pe-3">รวมยอดผลิตวันนี้:</td>
                     <td class="text-center fw-bold text-primary fs-5" id="sum-daily-target">0</td>
                   </tr>
                </tfoot>
              </table>
            </div>
            <div class="p-3 bg-light text-muted small">
               <i class="fa-solid fa-info-circle"></i> ระบบจะช่วยใส่ยอดคงเหลือให้อัตโนมัติ ท่านสามารถแก้ไขตัวเลขได้ตามต้องการ
            </div>
          </div>
          <div class="modal-footer border-0">
            <button onclick="saveDailyPlan()" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">บันทึกแผนงาน</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal สำหรับดูรายละเอียด Log ใน Dashboard -->
    <div class="modal fade" id="modal-log-detail" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
          <div class="modal-header border-0 bg-primary text-white p-4">
            <div class="d-flex align-items-center">
                <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                    <i class="fa-solid fa-file-contract fa-lg"></i>
                </div>
                <div>
                    <h5 class="modal-title fw-bold m-0" id="detail-title">Production Details</h5>
                    <small class="opacity-75" id="detail-subtitle">รายละเอียดข้อมูลรายม้วน</small>
                </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-4 bg-light" id="detail-body">
              <!-- ข้อมูลจะถูกฉีดเข้าตรงนี้ -->
          </div>
          <div class="modal-footer border-0 bg-light p-3">
              <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">ปิดหน้าต่าง</button>
          </div>
        </div>
      </div>
    </div>    

    <!-- Modal: ยืนยัน Next Station -->
    <div class="modal fade" id="modal-next-station" data-bs-backdrop="static" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title fw-bold"><i class="fa-solid fa-arrow-right-arrow-left me-2 text-primary"></i>ยืนยัน Next Station</h6>
          </div>
          <div class="modal-body">
            <p class="text-muted small mb-3">ตรวจสอบและแก้ไข Next Station ของแต่ละเส้นก่อนบันทึก</p>
            <div class="table-responsive"><table class="table table-sm table-bordered" id="ns-table">
              <thead class="table-light">
                <tr><th style="width:36px">#</th><th>ขนาด</th><th>Next Station</th></tr>
              </thead>
              <tbody id="ns-table-body"></tbody>
            </table></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="btn-ns-cancel">ยกเลิก</button>
            <button type="button" class="btn btn-primary" id="btn-ns-confirm"><i class="fa-solid fa-floppy-disk me-1"></i>บันทึก</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>

      // เปลี่ยน URL ตรงนี้เป็น URL ที่ได้จากข้อ 1 (Backend API)
      const GAS_URL = "ใส่_URL_WEB_APP_ของคุณที่นี่"; 

      // ฟังก์ชันหัวใจสำคัญสำหรับเชื่อมต่อ GitHub -> Google
      async function callGAS(action, data = {}) {
        try {
          const response = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify({ action: action, data: data })
          });
          const result = await response.json();
          if (result && result.error) throw new Error(result.error);
          return result;
        } catch (err) {
          console.error("Connection Error:", err);
          Swal.fire("เชื่อมต่อล้มเหลว", "โปรดตรวจสอบการตั้งค่า API หรืออินเทอร์เน็ต", "error");
          throw err;
        }
      }      

        let ALL_DATA = {};
        let CURRENT_MACHINE = "";
        let CURRENT_LOGS = [];
        let CURRENT_JOB_STD = null;
        let CURRENT_JOB_INFO = null;
        let ALL_LOGS_DATA = [];
        let CURRENT_JOB_SPEC = { min: 0, max: 0 };
        let DASHBOARD_LOGS = [];
        let refreshTimer = null;
        let trendChartInstance = null; 
        let JOB_TREND_CHART_INSTANCE = null; 
        let CURRENT_TREND_MODE = 'AVG';
        let ACTIVE_KNIVES = []; 
        let draggingKnifeIdx = -1;
        let timelineChart = null;
        let ALL_TIMELINE_DATA = [];
   
        // ใช้ตัวแปรนี้ตัวเดียวสำหรับโหมดแผนที่สี
        window.CURRENT_MAP_MODE = 'STD'; 

        function setMapMode(mode) {
            window.CURRENT_MAP_MODE = mode;
            const btnStd  = document.getElementById('btn-map-std');
            const btnDev  = document.getElementById('btn-map-dev');
            const btnHeat = document.getElementById('btn-map-heat');
            if(btnStd)  btnStd.className  = (mode === 'STD'  ? 'btn btn-sm btn-dark px-3 rounded-pill'           : 'btn btn-sm btn-outline-dark px-3 rounded-pill');
            if(btnDev)  btnDev.className  = (mode === 'DEV'  ? 'btn btn-sm btn-danger px-3 rounded-pill'          : 'btn btn-sm btn-outline-danger px-3 rounded-pill');
            if(btnHeat) btnHeat.className = (mode === 'HEAT' ? 'btn btn-sm btn-warning px-3 rounded-pill fw-bold'  : 'btn btn-sm btn-outline-warning px-3 rounded-pill');
            
            if (ALL_LOGS_DATA) {
                ALL_LOGS_DATA.forEach((l, i) => {
                    const canvasId = '3d-canvas-' + i;
                    if (document.getElementById(canvasId) && document.getElementById(canvasId).style.display !== 'none') {
                        // อัปเดต Legend และวาดรูปใหม่
                        updateLegendDisplay(i, l); 
                        draw3DCoilProfile(l, canvasId);
                        updateSlice(i, document.getElementById('slider-'+i).value);
                    }
                });
            }
        }

        // ฟังก์ชันเสริมสำหรับอัปเดตป้ายแถบสี (Legend)
function updateLegendDisplay(index, log) {
    const legVals = document.getElementById(`leg-vals-${index}`);
    const gradBar = document.getElementById(`grad-bar-${index}`);
    if(!legVals || !gradBar) return;

    const raw = [log.tH1, log.tH2, log.tH3, log.tHM1, log.tHM2, log.tHM3, log.tM1, log.tM2, log.tM3, log.tMT1, log.tMT2, log.tMT3, log.tT1, log.tT2, log.tT3];
    const thks = raw.map(parseFloat).filter(v => v > 0);
    const maxV = Math.max(...thks);
    const minV = Math.min(...thks);

    if (window.CURRENT_MAP_MODE === 'DEV') {
        legVals.innerHTML = `<span>+0.05</span><span style="font-size:7px; color:#94a3b8;">TARGET</span><span>-0.05</span>`;
        gradBar.style.background = 'linear-gradient(to top, #ef4444, #f8fafc, #2563eb)';
    } else if (window.CURRENT_MAP_MODE === 'HEAT') {
        legVals.innerHTML = `<span style="color:#f97316">Crown+</span><span style="color:#22c55e">Flat</span><span style="color:#3b82f6">Crown-</span>`;
        gradBar.style.background = 'linear-gradient(to top, #3b82f6, #22c55e, #f97316)';
    } else {
        legVals.innerHTML = `<span>${maxV.toFixed(2)}</span><span>${((maxV+minV)/2).toFixed(2)}</span><span>${minV.toFixed(2)}</span>`;
        gradBar.style.background = 'linear-gradient(to top, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff)';
    }
}


        // ================================================================
        // GAS API BRIDGE — แทน google.script.run สำหรับ GitHub Pages
        // ตั้งค่า GAS_URL ให้ตรงกับ Web App URL ของคุณ
        // ================================================================
        const GAS_URL = 'YOUR_GAS_WEB_APP_URL_HERE'; // ← เปลี่ยนตรงนี้หลัง deploy GAS

        function callGAS(funcName, args, successCb, failCb) {
            const payload = { action: funcName, args: args || [] };
            fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' }, // GAS ต้องการ text/plain (ไม่ใช่ application/json)
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    if (failCb) failCb(new Error(data.error));
                    else console.error('GAS Error:', data.error);
                } else {
                    if (successCb) successCb(data.result);
                }
            })
            .catch(err => {
                if (failCb) failCb(err);
                else console.error('Fetch Error:', err);
            });
        }

        document.addEventListener('DOMContentLoaded', () => loadInitial());

        function loadInitial() {
          showLoading();
          callGAS('getInitialData', [], data => {
            ALL_DATA = data;
            
            // 1. เติมรายชื่อเครื่องจักร (ของเดิม)
            const sel = document.getElementById('machine-select');
            sel.innerHTML = '<option value="" selected disabled>-- เลือกเครื่องจักร --</option>';
            data.machines.forEach(m => sel.add(new Option(m, m)));
            
            // 2. เติมรายชื่อ Mill ลงใน datalist (ที่เพิ่มใหม่)
            const millDataList = document.getElementById('mill-list-options');
            if (millDataList && data.mills) {
              millDataList.innerHTML = ""; // ล้างค่าเก่า
              data.mills.forEach(mill => {
                const option = document.createElement('option');
                option.value = mill;
                millDataList.appendChild(option);
              });
            }
            
            setupAutoSwitch();
            hideLoading();
          });
        }

        // ... (goHome, machine-select change, switchScreen, enterSystem, setupQueue เหมือนเดิม) ...
        function goHome() {
            switchScreen('screen-select');
            document.getElementById('machine-select').value = "";
            document.getElementById('btn-enter').disabled = true;
            loadInitial();
        }
        document.getElementById('machine-select').addEventListener('change', () => document.getElementById('btn-enter').disabled = false);

        function switchScreen(id) {
            setTimeout(updateMobNav, 50);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        function enterSystem() {
            CURRENT_MACHINE = document.getElementById('machine-select').value;
            const rJob = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');
            rJob ? setupRunning(rJob) : setupQueue();
        }

        function setupQueue() {
            const cont = document.getElementById('queue-list-container');
            document.getElementById('queue-machine-name').innerText = CURRENT_MACHINE; 
            cont.innerHTML = "";

            // --- ส่วนที่แก้ไข: เช็คว่ามีงาน Running อยู่หรือไม่ ---
            const runningJob = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');
            const backBtnArea = document.getElementById('back-to-run-area');
            
            if (runningJob) {
                backBtnArea.style.display = 'block'; // โชว์ปุ่มเขียวถ้ามีงานค้าง
            } else {
                backBtnArea.style.display = 'none';  // ซ่อนถ้าไม่มีงาน Running
            }
            // -------------------------------------------

            const machineJobs = ALL_DATA.jobs.filter(j => 
                j.machine === CURRENT_MACHINE && j.status !== 'Finished'
            );
            
            machineJobs.forEach((j) => {
                const div = document.createElement('div');
                const isRunning = (j.status === 'Running');
                
                div.className = `card-custom p-3 mb-3 border-start border-4 ${isRunning ? 'border-success bg-success bg-opacity-10' : 'border-primary'}`;
                
                div.innerHTML = `
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <span class="badge ${isRunning ? 'bg-success' : 'bg-primary'} mb-1">${j.status.toUpperCase()}</span>
                      <h5 class="fw-bold mb-0">${j.jobId}</h5>
                      <small class="text-muted">${j.customer} | ${j.thickness} mm</small>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- ปุ่มลบ (เพิ่มใหม่) -->
                        <button class="btn btn-light btn-sm border" onclick="confirmDeleteJob('${j.jobId}', '${j.status}')" title="ลบแผนงาน">
                          <i class="fa-solid fa-trash text-danger"></i>
                        </button>
                        
                        <!-- ปุ่มแก้ไข -->
                        <button class="btn btn-light btn-sm border" onclick="openEditJobModal('${j.jobId}')" title="แก้ไขแผนงาน">
                          <i class="fa-solid fa-pen text-secondary"></i>
                        </button>
                      ${isRunning ? 
                        `<button class="btn btn-warning btn-sm fw-bold" onclick="pauseJob('${j.jobId}')">PAUSE</button>` : 
                        `<button class="btn btn-dark btn-sm px-3" onclick="startJob('${j.jobId}')">START</button>`
                      }
                    </div>
                  </div>`;
                cont.appendChild(div);
            });

            if (machineJobs.length === 0) {
                cont.innerHTML = '<div class="text-center text-muted py-5"><p>ไม่มีงานค้างผลิตในขณะนี้</p></div>';
            }
            switchScreen('screen-queue');
        }

        function startJob(id) {
            // 1. ตรวจสอบก่อนว่า "ปัจจุบัน" มีงานอื่น Running อยู่หรือไม่
            const alreadyRunning = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');

            if (alreadyRunning) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่สามารถเริ่มงานได้',
                    text: `เครื่อง ${CURRENT_MACHINE} มีงาน ${alreadyRunning.jobId} กำลังผลิตอยู่ โปรดกด PAUSE งานเดิมก่อนเริ่มงานใหม่`,
                    confirmButtonColor: '#f59e0b'
                });
                return; // หยุดการทำงาน ไม่ให้ไปต่อ
            }

            // 2. ถ้าไม่มีงานค้าง ถึงจะยอมให้เริ่มงานได้
            Swal.fire({
                title: 'ยืนยันเริ่มงาน?',
                text: `คุณต้องการเริ่มงาน ${id} ใช่หรือไม่?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ยืนยันเริ่มงาน',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [() => {
                        // อัปเดตสถานะในตัวแปร LOCAL ด้วย
                        let job = ALL_DATA.jobs.find(j => j.jobId === id], null, null);
                        if(job) job.status = 'Running';
                        
                        setupRunning(job); // เข้าหน้าผลิต
                        hideLoading();
                    }).startJob(id);
                }
            });
        }

        // --- [แก้ไข] setupRunning: โชว์ Mill และ Thickness ---
        function setupRunning(job) {
          CURRENT_JOB_INFO = job; 
          document.getElementById('run-job-id').innerText = job.jobId;
          document.getElementById('run-customer').innerHTML = `${job.customer} <br> Mill: <b>${job.millPlan}</b> | Thk: <b>${job.thickness}</b> mm`;
          document.getElementById('run-machine-tag').innerText = CURRENT_MACHINE;

          CURRENT_JOB_STD = null;
          if (ALL_DATA.standards) {
              // 1. ระบุชื่อคอลัมน์ที่จะค้นหาตามชื่อ Mill (แปลงเป็นตัวเล็ก sa, gj, gs, bsp)
              const millKey = String(job.millPlan).toLowerCase().trim(); 

              const matchStd = ALL_DATA.standards.find(s => {
                  // เช็คประเภทท่อก่อน
                  const isTypeMatch = String(s.type).trim() === String(job.workType).trim();
                  
                  // เช็คความหนา โดยเลือกคอลัมน์ตาม Mill (เช่น ถ้า millKey คือ 'gs' ก็จะไปเช็คค่าใน s.gs)
                  let isThickMatch = false;
                  if (s[millKey] !== undefined) {
                      // เทียบค่าความหนาในคอลัมน์ Mill นั้นๆ กับค่าความหนาของ Job
                      isThickMatch = parseFloat(s[millKey]).toFixed(2) === parseFloat(job.thickness).toFixed(2);
                  } else {
                      // ถ้าชื่อ Mill ไม่ตรงกับคอลัมน์ที่มี (SA,GJ,GS,BSP) ให้กลับไปเช็คคอลัมน์ B (thick) ปกติ
                      isThickMatch = parseFloat(s.thick).toFixed(2) === parseFloat(job.thickness).toFixed(2);
                  }

                  return isTypeMatch && isThickMatch;
              });

              if (matchStd) {
                  CURRENT_JOB_STD = { min: parseFloat(matchStd.min), max: parseFloat(matchStd.max) };
                  console.log("✅ ค้นหา Standard สำเร็จ:", CURRENT_JOB_STD);
              } else {
                  console.warn("❌ ไม่พบ Standard ในคอลัมน์:", millKey, "สำหรับความหนา:", job.thickness);
              }
          }

          loadHistory(job.jobId);
          switchScreen('screen-running');
        }

        function loadHistory(jobId) {
            const cont = document.getElementById('history-list');
            cont.innerHTML = '<div class="text-center p-3 small text-muted">กำลังโหลดประวัติ...</div>';
            
            // เติม .trim() เพื่อความชัวร์ที่สุดก่อนส่งไปหลังบ้าน
            const cleanJobId = String(jobId).trim();
            console.log("กำลังขอข้อมูลประวัติสำหรับ: '" + cleanJobId + "'"); 

            callGAS('withSuccessHandler', [logs => {
                console.log("ได้รับข้อมูลจากหลังบ้านแล้ว:", logs], null, null); // ดูว่ามีข้อมูลส่งมาถึงหน้าเว็บไหม
                if(logs === null) {
                    alert("คำเตือน: ระบบส่งข้อมูลมาเป็น null โปรดเช็ค Executions ใน Script");
                }                
                
                CURRENT_LOGS = logs || [];
                if(CURRENT_LOGS.length === 0) { 
                    cont.innerHTML = '<div class="text-center text-muted py-3 small">ยังไม่มีบันทึกสำหรับงานนี้</div>'; 
                    return; 
                }
                
                // ส่วนการสร้าง HTML แสดงผล
                try {
                    cont.innerHTML = CURRENT_LOGS.map((l, i) => {
                        // กันเหนียว: เช็คว่าตัวแปรพื้นฐานมีค่าไหม
                        const weight = l.weight ? Number(l.weight).toLocaleString() : '0';
                        const mill = l.millNo || '-';
                        const coil = l.coilNo ? String(l.coilNo).replace(/^'/, '') : '-';

                        return `
                            <div class="log-item d-flex justify-content-between align-items-center mb-2" onclick="editLogByIndex(${i})">
                                <div>
                                    <div class="fw-bold text-primary">${mill} - ${weight} kg</div>
                                    <div class="text-muted" style="font-size:0.75rem;">
                                        Coil: <b>${coil}</b> | TMT NO.: <b>${l.tmtNo || '-'}</b>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right text-muted opacity-50"></i>
                            </div>
                        `;
                    }).join('');
                    console.log("สร้างรายการประวัติสำเร็จ " + CURRENT_LOGS.length + " รายการ");
                } catch (err) {
                    console.error("เกิดข้อผิดพลาดในการสร้างรายการประวัติ:", err);
                    cont.innerHTML = '<div class="text-center text-danger py-3 small">เกิดข้อผิดพลาดในการแสดงผลประวัติ</div>';
                }
            })
            .withFailureHandler(err => {
                console.error("หลังบ้านพัง Error:", err.message);
                alert("หลังบ้าน Error: " + err.message);                
            })
            .getJobLogs(cleanJobId);
        }
        
        function validateQC(input) {
            if (!CURRENT_JOB_STD) return;
            const val = parseFloat(input.value);
            input.classList.remove('input-high', 'input-low');
            
            const status = getSpecClass(val, CURRENT_JOB_STD.min, CURRENT_JOB_STD.max);
            if (status === "qc-high") input.classList.add('input-high');
            if (status === "qc-low") input.classList.add('input-low');
        }

        function openRecordModal(isEdit) {
            const f = document.getElementById('record-form');
            const subtitle = document.getElementById('record-subtitle');
            const currentId = document.getElementById('run-job-id').innerText;
            const thkDisplay = document.getElementById('disp-target-thick'); // ช่อง Thickness เป้าหมาย
            
            // 1. ล้างสถานะ data-touched และสีพื้นหลังทุกครั้งที่เริ่มม้วนใหม่
            document.querySelectorAll('.qc-thick').forEach(el => {
                el.removeAttribute('data-touched'); 
                el.style.backgroundColor = "#ffffff";
                el.style.color = "#000000";
            });

            // 2. จัดการข้อมูล Traceability (จำค่าเดิมก่อน Reset)
            const keep = document.getElementById('keep-trace-data')?.checked;
            const tmt = f.tmtNo.value;
            const heat = f.heatNo.value;
            const mcoil = f.mCoil.value;

            f.reset(); // ล้างฟอร์ม
            
            // 3. ปลดล็อคช่อง Thickness (เป้าหมาย) ให้พิมพ์ได้ และเติมค่าจากฐานข้อมูล
            if (thkDisplay) {
                thkDisplay.readOnly = false; // ปลดล็อคให้พิมพ์ได้
                thkDisplay.classList.remove('bg-light'); // เอาสีเทาออกเพื่อให้รู้ว่าพิมพ์ได้
                thkDisplay.style.backgroundColor = "#ffffff";
                
                if (CURRENT_JOB_INFO) {
                    const baseThk = parseFloat(CURRENT_JOB_INFO.thickness);
                    thkDisplay.value = !isNaN(baseThk) ? baseThk.toFixed(3) : "";
                }
            }

            // 4. ใส่ค่าพื้นฐานคืนให้ฟอร์ม
            if(keep) { f.tmtNo.value = tmt; f.heatNo.value = heat; f.mCoil.value = mcoil; }
            document.getElementById('input-job-id').value = currentId;
            document.getElementById('input-machine').value = CURRENT_MACHINE;
            f.orderNo.value = currentId;
            // ดึง Mill No อัตโนมัติจาก Job
            if (CURRENT_JOB_INFO && CURRENT_JOB_INFO.millPlan) {
                f.millNo.value = CURRENT_JOB_INFO.millPlan;
            }

            // 5. เติม Slit Plan จาก Job_Master
            loadSlitPlanFromJobMaster(isEdit);

            // 6. ตั้งค่า Subtitle + เรียก AI hint (ไม่แตะ input)
            clearAiHints();
            if (isEdit) {
                subtitle.innerHTML = `<span class="text-secondary fw-bold"><i class="fa-solid fa-pen-to-square"></i> [โหมดแก้ไข] ใช้ข้อมูลเดิมจากระบบ</span>`;
            } else {
                subtitle.innerHTML = `<i class="fa-solid fa-microchip fa-spin"></i> กำลังโหลดค่าแนะนำ...`;
                callGAS('withSuccessHandler', [res => {
                        if (res && res.found) {
                            showAiHints(res.prediction], null, null);
                            subtitle.innerHTML = `<i class="fa-solid fa-lightbulb text-warning"></i> ค่าแนะนำจาก <b>${res.mill}</b> | ความแม่นยำ: <b>${res.confidence}</b>`;
                        } else {
                            subtitle.innerHTML = `<span class="text-muted small">กรุณากรอกข้อมูลให้ครบถ้วน</span>`;
                        }
                    })
                    .withFailureHandler(() => {
                        subtitle.innerHTML = `<span class="text-muted small">กรุณากรอกข้อมูลให้ครบถ้วน</span>`;
                    })
                    .getSmartPrediction(currentId);
            }

            // 7. ตั้งค่า Tab และ Event
            switchRecordTab('H');
            
            document.querySelectorAll('.qc-thick').forEach(input => {
                input.oninput = function() {
                    if (typeof validateQC === "function") validateQC(this);
                    if (typeof drawStripProfile === "function") drawStripProfile();
                };
            });

            drawStripProfile();
            if (typeof setupEnterToTab === "function") setupEnterToTab(); 
            
            // เปิด Modal
            new bootstrap.Modal(document.getElementById('modal-record')).show();
        }

        // [REMOVED] reCalibrateByActualHead

        // [REMOVED] adjustCrownByActualWidth


        // [REMOVED] setupCalibrationEvents


        // ฟังก์ชันสำหรับแก้ไขข้อมูลเดิม (ดึงค่าเก่าขึ้นมาโชว์)
        function editLogByIndex(index) {
            const l = CURRENT_LOGS[index];
            openRecordModal(true);
            const f = document.getElementById('record-form');
            document.getElementById('input-row-id').value = l.rowId;
            f.millNo.value = l.millNo;
            f.weight.value = l.weight;
            f.coilNo.value = l.coilNo.replace(/^'/, '');
            f.tmtNo.value = l.tmtNo;
            f.heatNo.value = l.heatNo;
            f.mCoil.value = l.mCoil; // ให้ตรงกับ name="mCoil" ใน HTML
            
            f.widthH.value = l.wH; f.widthHM.value = l.wHM; f.widthM.value = l.wM; f.widthMT.value = l.wMT; f.widthT.value = l.wT;
            f.thickH1.value = l.tH1; f.thickHM1.value = l.tHM1; f.thickM1.value = l.tM1; f.thickMT1.value = l.tMT1; f.thickT1.value = l.tT1;
            f.thickH2.value = l.tH2; f.thickHM2.value = l.tHM2; f.thickM2.value = l.tM2; f.thickMT2.value = l.tMT2; f.thickT2.value = l.tT2;
            f.thickH3.value = l.tH3; f.thickHM3.value = l.tHM3; f.thickM3.value = l.tM3; f.thickMT3.value = l.tMT3; f.thickT3.value = l.tT3;
            f.condH.value = l.condH; f.condHM.value = l.condHM; f.condM.value = l.condM; f.condMT.value = l.condMT; f.condT.value = l.condT;
            f.note.value = l.note;

            document.getElementById('record-slit-rows').innerHTML = '';
            recordSlitCount = 0;
            const cleanPlan = String(l.slitPlan || '').replace(/^'/, '');
            if (cleanPlan) {
                cleanPlan.split(',').forEach(item => {
                    const wm = item.match(/^([0-9.]+)/);
                    const nm = item.match(/\[(.*?)\]/);
                    if (wm) addRecordSlitRow(wm[1], nm ? nm[1] : '');
                });
            }

            document.getElementById('input-old-img').value = l.img;
            document.querySelectorAll('.qc-thick').forEach(input => validateQC(input));
            drawStripProfile();
            const cleanSlitPlan = String(l.slitPlan || "").replace(/^'/, '').replace(/\[.*?\]/g, '');
            f.slitPlan.value = cleanSlitPlan;
            calculatePrePlan(cleanSlitPlan);
            syncKeyInputToCanvas('current', cleanSlitPlan);
            // แสดง preview Job_Master ขณะแก้ไขด้วย
            loadSlitPlanFromJobMaster(true);             

        }

        document.getElementById('record-form').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save');

            btn.disabled = true; // ล็อคปุ่มทันที ป้องกันกดซ้ำ
            const scrapText = document.getElementById('slit-scrap-label').innerText;
            if (scrapText.includes("เกิน")) {
                btn.disabled = false;
                Swal.fire("ขนาดเกิน!", "ขนาดซอยรวมกันเกินหน้ากว้างเหล็ก กรุณาแก้ไข", "error");
                return;
            }

            const fd = {};
            new FormData(this).forEach((value, key) => { fd[key] = value; });

            // เตรียม slitPayload
            const slitPlanText = document.getElementById('input-slit-plan').value;
            let slitPayload = [];
            if (slitPlanText) {
                const totalW      = parseFloat(fd.widthM) || Number(CURRENT_JOB_INFO?.stripWidth || 0) || 1225;
                const totalWeight = parseFloat(fd.weight) || 0;
                const planItems   = slitPlanText.split(',').map(item => {
                    const wm = item.match(/^([0-9.]+)/);
                    const nm = item.match(/\[(.*?)\]/);
                    return { w: wm ? parseFloat(wm[1]) : 0, note: nm ? nm[1] : '' };
                }).filter(i => i.w > 0);
                slitPayload = planItems.map((item, idx) => ({
                    slitId:   `${fd.jobId}-${fd.tmtNo || 'NA'}-S${idx + 1}`,
                    parentId: fd.jobId,
                    width:    item.w,
                    note:     item.note,
                    weight:   Math.round((item.w / totalW) * totalWeight),
                    thkL: ((parseFloat(fd.thickH1)+parseFloat(fd.thickM1)+parseFloat(fd.thickT1))/3).toFixed(3),
                    thkC: ((parseFloat(fd.thickH2)+parseFloat(fd.thickM2)+parseFloat(fd.thickT2))/3).toFixed(3),
                    thkR: ((parseFloat(fd.thickH3)+parseFloat(fd.thickM3)+parseFloat(fd.thickT3))/3).toFixed(3),
                    grade: "A", position: "Planned"
                }));
            }

            // Popup ยืนยัน Next Station
            if (slitPayload.length > 0) {
                // ดึง note ที่บันทึกไว้แล้วจาก Slit_Inventory
                await new Promise(resolve => {
                    callGAS('getSlitNotesByParent', [fd.jobId], savedNotes => {
                            slitPayload.forEach(s => {
                                if (savedNotes[s.width] !== undefined && savedNotes[s.width] !== '') {
                                    s.note = savedNotes[s.width];
                                }
                            });
                            resolve();
                        }, () => resolve());
                });

                // สร้าง table ใน modal
                const tbody = document.getElementById('ns-table-body');
                tbody.innerHTML = slitPayload.map((s, i) => `
                    <tr>
                        <td class="text-center fw-bold">${i+1}</td>
                        <td class="text-center">${s.width} mm</td>
                        <td><input type="text" id="ns-${i}" value="${s.note}" placeholder="-" class="form-control form-control-sm"></td>
                    </tr>`).join('');

                const nsModal = new bootstrap.Modal(document.getElementById('modal-next-station'));
                nsModal.show();

                const confirmed = await new Promise(resolve => {
                    document.getElementById('btn-ns-confirm').onclick = () => {
                        slitPayload.forEach((s, i) => {
                            const el = document.getElementById(`ns-${i}`);
                            if (el) s.note = el.value.trim();
                        });
                        nsModal.hide();
                        resolve(true);
                    };
                    document.getElementById('btn-ns-cancel').onclick = () => {
                        nsModal.hide();
                        resolve(false);
                    };
                });

                if (!confirmed) {
                    btn.disabled = false;
                    return;
                }
            }

            showLoading();
            btn.disabled = true;

            callGAS('withSuccessHandler', [res => {
                hideLoading(], null, null);
                btn.disabled = false;
                if (res.includes("SUCCESS")) {
                    Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('modal-record')).hide();
                    this.reset();
                    loadHistory(fd.jobId);
                } else {
                    Swal.fire("Error", res, "error");
                }
            }).saveLogAndSlits(fd, [], slitPayload);
        };

        function requestFinishJob() {
            // ดึงชื่อ Job มาโชว์ในคำถามด้วย
            const currentJobId = document.getElementById('run-job-id').innerText;

            // ใช้ SweetAlert2 สร้างหน้าต่างยืนยันสวยๆ
            Swal.fire({
                title: 'ยืนยันจบงาน?',
                text: `คุณต้องการจบงาน ${currentJobId} และปิด Order ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // สีแดงสำหรับปุ่มยืนยัน (อันตราย)
                cancelButtonColor: '#3085d6', // สีฟ้าสำหรับยกเลิก
                confirmButtonText: 'ใช่, จบงานทันที',
                cancelButtonText: 'ยกเลิก',
                reverseButtons: true // สลับตำแหน่งปุ่มให้กดยากขึ้นนิดนึง (ป้องกันความชินมือ)
            }).then((result) => {
                if (result.isConfirmed) {
                    // ถ้ากดยืนยันสีแดง -> ค่อยทำงานจริง
                    showLoading();
                    callGAS('withSuccessHandler', [() => { 
                        // แจ้งเตือนความสำเร็จก่อนกลับหน้าหลัก
                        Swal.fire({
                            title: 'จบงานสำเร็จ!',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            goHome(], null, null); 
                        });
                    }).finishJob(currentJobId);
                }
            });
        }

        function showDashboard(isAuto = false) { 
            if(!isAuto) showLoading(); 
            
            const today = new Date().toISOString().split('T')[0];
            const startPicker = document.getElementById('monitor-date-start');
            const endPicker = document.getElementById('monitor-date-end');
            const filterDate = startPicker?.value || today;
            const filterDateEnd = endPicker?.value || today;

            const showRun = document.getElementById('chk-running')?.checked ?? true;
            const showWait = document.getElementById('chk-waiting')?.checked ?? true;
            const showFin = document.getElementById('chk-finished')?.checked ?? false;

            callGAS('withSuccessHandler', [data => {
                switchScreen('screen-dashboard'], null, null); 
                
                // 1. อัปเดตส่วน Factory Monitor (ถ้ามี)
                const summary = data.summary;
                const monDiv = document.getElementById('factory-monitor');
                if (monDiv && summary) {
                    monDiv.style.display = (summary.plan > 0 || summary.actual > 0) ? 'block' : 'none';
                    const facAct = document.getElementById('fac-actual');
                    const facPlan = document.getElementById('fac-plan');
                    const facPer = document.getElementById('fac-percent');
                    const facBar = document.getElementById('fac-progress-bar');
                    
                    if(facAct) facAct.innerText = summary.actual || 0;
                    if(facPlan) facPlan.innerText = summary.plan || 0;
                    if(facPer) facPer.innerText = Math.round(summary.percent || 0) + "%";
                    if(facBar) facBar.style.width = (summary.percent || 0) + "%";
                }

                // 2. เตรียมตัวแปร Card เครื่องจักร
                let cardsHtml = '<div class="dashboard-grid">';

                data.machines.forEach(m => {
                    let mJobHtml = "";
                    let displayJobs = m.jobs ? m.jobs.filter(j => {
                        if (j.status === 'Running' && showRun) return true;
                        if (j.status === 'Waiting' && showWait) return true;
                        if (j.status === 'Finished' && showFin) return true;
                        return false;
                    }) : [];

                    displayJobs.forEach(job => {
                        // สร้างปุ่มรูปภาพใบสั่งผลิต
                        const imgBtn = job.jobImg ? `<a href="${job.jobImg}" target="_blank" class="btn btn-sm text-info p-0 ms-1" onclick="event.stopPropagation();"><i class="fa-solid fa-image"></i></a>` : '';

                        const jobPct = job.totalCoils > 0 ? Math.round(job.producedTotal / job.totalCoils * 100) : 0;
                        const jobBarColor = job.status === 'Running' ? '#4361ee' : job.status === 'Finished' ? '#10b981' : '#cbd5e1';
                        const statusBadgeClass = job.status === 'Running' ? 'bg-success text-white' : 'bg-light text-muted border';
                        mJobHtml += `
                        <div class="job-ticket border p-2 mb-2 rounded bg-white shadow-sm" onclick="viewJobHistory('${job.jobId}', '${job.customer}')" style="cursor:pointer;">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="fw-bold">${job.jobId} ${imgBtn}</span>
                                <span class="badge ${statusBadgeClass}" style="font-size:0.65rem;">${job.status}</span>
                            </div>
                            <div class="small text-muted text-truncate">${job.customer}</div>
                            <div class="d-flex justify-content-between align-items-end mt-1">
                                <strong class="text-primary">${job.thickness.toFixed(2)} mm</strong>
                                <span class="small fw-bold">${job.producedTotal}/${job.totalCoils}</span>
                            </div>
                            <div style="height:4px;background:#f1f5f9;border-radius:4px;margin-top:8px;overflow:hidden;">
                                <div style="height:100%;width:${jobPct}%;background:${jobBarColor};border-radius:4px;transition:width 0.3s;"></div>
                            </div>
                        </div>`;
                    });

                    let isMcRunning = m.jobs && m.jobs.some(j => j.status === 'Running');
                    // คำนวณ progress รวมของเครื่อง
                    const mcJobs = m.jobs || [];
                    const mcTotal    = mcJobs.reduce((a, j) => a + (j.totalCoils || 0), 0);
                    const mcProduced = mcJobs.reduce((a, j) => a + (j.producedTotal || 0), 0);
                    const mcPct      = mcTotal > 0 ? Math.round(mcProduced / mcTotal * 100) : 0;
                    const mcBarColor = isMcRunning ? '#10b981' : '#94a3b8';
                    cardsHtml += `<div class="machine-card-dash" style="border-top: 4px solid ${isMcRunning ? '#10b981' : '#cbd5e1'}">
                                    <div class="p-3 border-bottom bg-light">
                                        <div class="d-flex align-items-center justify-content-between mb-1">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fa-solid fa-industry text-secondary" style="font-size:0.85rem;"></i>
                                                <strong style="font-size:1rem;">${m.machine}</strong>
                                            </div>
                                            <span class="badge ${isMcRunning ? 'bg-success' : 'bg-secondary'}">${isMcRunning ? 'Running' : 'Idle'}</span>
                                        </div>
                                        ${mcTotal > 0 ? `
                                        <div class="d-flex justify-content-between align-items-center" style="font-size:0.78rem;color:#64748b;margin-bottom:4px;">
                                            <span>Plan: ${mcProduced}/${mcTotal}</span>
                                            <span class="fw-bold">${mcPct}%</span>
                                        </div>
                                        <div style="height:5px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
                                            <div style="height:100%;width:${mcPct}%;background:${mcBarColor};border-radius:4px;"></div>
                                        </div>` : ''}
                                    </div>
                                    <div class="job-list-area p-2">${mJobHtml || '<div class="text-center text-muted py-4 small opacity-50">No Jobs</div>'}</div>
                                  </div>`;
                });

                cardsHtml += '</div>';
                
                // แสดงผลลัพธ์ลงหน้าจอ
                const dashCont = document.getElementById('dash-container');
                if(dashCont) dashCont.innerHTML = cardsHtml;

                // Mobile: render app-style list
                renderMobileDash(data);
                
                hideLoading();
            }).withFailureHandler(err => {
                hideLoading();
                Swal.fire("Error", err.message, "error");
            }).getDashboardOverview(filterDate, filterDateEnd); 
        }
        // เพิ่มฟังก์ชันสำหรับปุ่ม Clear Filter
        function clearMonitorFilter() {
            document.getElementById('monitor-date-start').value = "";
            document.getElementById('monitor-date-end').value = "";
            showDashboard();
        }

        // --- DASHBOARD: 2. EXECUTIVE (Analytics) ---
        let dashChart1 = null;
        let dashChart2 = null;

        function showExecDashboard() {
            switchScreen('screen-dashboard-exec');
            
            // ตั้งค่าวันที่ปัจจุบัน (เหมือนเดิม)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dash-date-start').value = today;
            document.getElementById('dash-date-end').value = today;
            document.getElementById('trend-date-start').value = today;
            document.getElementById('trend-date-end').value = today;

            // 1. เติมรายชื่อเครื่องจักรในตัวกรอง (Dashboard & Trend)
            const mSelExec = document.getElementById('dash-filter-machine');
            const mSelTrend = document.getElementById('trend-machine');
            
            [mSelExec, mSelTrend].forEach(sel => {
                if (!sel) return;
                const currentVal = sel.value;
                sel.innerHTML = (sel.id === 'trend-machine') ? '<option value="ALL">รวมทุกเครื่อง (All)</option>' : '<option value="ALL">All Machines</option>';
                ALL_DATA.machines.forEach(m => sel.add(new Option(m, m)));
                sel.value = currentVal || "ALL";
            });

            // 2. เติม Mill Group จากชีท Config
            const millSel = document.getElementById('trend-mill-group');
            if (millSel && ALL_DATA.mills) {
                millSel.innerHTML = '<option value="ALL">ALL</option>';
                ALL_DATA.mills.forEach(mill => {
                    millSel.add(new Option(mill, mill));
                });
            }

            // 3. เติมความหนาเป้าหมาย จากประวัติที่เคยมีใน Job_Master
            const thkSel = document.getElementById('trend-thickness');
            if (thkSel && ALL_DATA.recordedThk) {
                thkSel.innerHTML = '<option value="ALL">ALL</option>';
                ALL_DATA.recordedThk.forEach(thk => {
                    thkSel.add(new Option(thk.toFixed(2) + " mm", thk));
                });
            }

            refreshExecDashboard();
        }

        function refreshExecDashboard() {
            const startDateEl = document.getElementById('dash-date-start');
            const endDateEl = document.getElementById('dash-date-end');
            const machineEl = document.getElementById('dash-filter-machine');
            const limitEl = document.getElementById('dash-log-limit');

            showLoading();
            
            const filterObj = {
              start: startDateEl.value, 
              end: endDateEl.value,
              machine: machineEl ? machineEl.value : "ALL",
              limit: limitEl ? limitEl.value : 20
            };

            callGAS('withFailureHandler', [err => { hideLoading(], null, null); Swal.fire("Error", err.message, "error"); })
            .withSuccessHandler(data => {
                // บันทึกข้อมูลเข้าตัวแปรส่วนกลาง
                DASHBOARD_LOGS = data.logs || [];
                ALL_TIMELINE_DATA = data.timeline || [];

                // 1. อัปเดต Daily Progress
                const actual = data.kpi.actualToday || 0;
                const target = data.kpi.targetToday || 0;
                const percent = target > 0 ? Math.round((actual / target) * 100) : 0;

                document.getElementById('fac-actual').innerText = actual;
                document.getElementById('fac-plan').innerText = target;
                document.getElementById('fac-percent').innerText = percent + "%";
                document.getElementById('fac-progress-bar').style.width = percent + "%";

                // 2. อัปเดต KPI Cards
                document.getElementById('kpi-weight').innerText = data.kpi.weight.toLocaleString();
                document.getElementById('kpi-coils').innerText = data.kpi.coils.toLocaleString();
                document.getElementById('kpi-jobs').innerText = data.kpi.jobs;
                document.getElementById('kpi-qc').innerText = data.kpi.qcAlerts;

                // 3. วาดกราฟทั้งหมด (เรียกใช้ฟังก์ชันที่ประกาศไว้ด้านล่าง)
                renderTimelineChart(ALL_TIMELINE_DATA);
                renderMainCharts(data); 

                // 4. อัปเดตตาราง Recent Logs
                const tbody = document.getElementById('dash-table-body');
                if (tbody) {
                    tbody.innerHTML = data.logs.map((row, index) => {
                        const statusBadge = row.isFail ? '<span class="badge bg-danger">Alert</span>' : '<span class="badge bg-success bg-opacity-10 text-success">OK</span>';
                        return `<tr onclick="showDashboardLogDetail(${index})" style="cursor:pointer;" class="align-middle">
                            <td class="text-muted small">${row.time}</td>
                            <td class="fw-bold">${row.machine}</td>
                            <td class="text-primary fw-bold">${row.job}</td>
                            <td><span class="badge bg-light text-dark border">${row.coil}</span></td>
                            <td class="fw-bold text-end">${row.weight.toLocaleString()}</td>
                            <td class="text-center">${statusBadge}</td>
                        </tr>`;
                    }).join('');
                }

                hideLoading();
            }).getExecutiveData(filterObj);
        }

        function renderMainCharts(data) {
            // กราฟที่ 1: Job Status (Doughnut)
            const ctxPie = document.getElementById('dashChartPie')?.getContext('2d');
            if (ctxPie) {
                if (window.myPieChart) window.myPieChart.destroy();
                window.myPieChart = new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: ['Finished', 'Running', 'Waiting'],
                        datasets: [{ 
                            data: data.chartStatus, 
                            backgroundColor: ['#10b981', '#3b82f6', '#94a3b8'], 
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '70%', 
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } } 
                    }
                });
            }

            // กราฟที่ 2: Production by Machine (Bar)
            const ctxBar = document.getElementById('dashChartMain')?.getContext('2d');
            if (ctxBar) {
                if (window.myBarChart) window.myBarChart.destroy();
                window.myBarChart = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: data.chartMachine.labels,
                        datasets: [{ 
                            label: 'Weight (kg)', 
                            data: data.chartMachine.data, 
                            backgroundColor: 'rgba(67, 97, 238, 0.8)', 
                            borderRadius: 8,
                            barThickness: 25
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }

        function viewJobHistory(jobId, customer) {
            const cont = document.getElementById('dash-history-list');
            document.getElementById('hist-modal-title').innerText = jobId;
            document.getElementById('hist-modal-sub').innerText = customer;
            cont.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 small text-muted">กำลังดึงข้อมูล Digital Twin...</p></div>';
            
            new bootstrap.Modal(document.getElementById('modal-view-history')).show();

            const jobInfo = ALL_DATA.jobs.find(function(j) { return j.jobId === jobId; });
            const targetThkDisplay = jobInfo ? jobInfo.thickness.toFixed(2) : "0.00";
            let minS = 0, maxS = 0;
            
            if (jobInfo && ALL_DATA.standards) {
                const millK = String(jobInfo.millPlan).toLowerCase().trim();
                const std = ALL_DATA.standards.find(function(s) {
                    return String(s.type).trim() === String(jobInfo.workType).trim() && 
                    (s[millK] !== undefined ? parseFloat(s[millK]).toFixed(2) === parseFloat(jobInfo.thickness).toFixed(2) : parseFloat(s.thick).toFixed(2) === parseFloat(jobInfo.thickness).toFixed(2));
                });
                if (std) { minS = parseFloat(std.min); maxS = parseFloat(std.max); }
            }

            callGAS('join', [''], function(logs) {
                if(!logs || logs.length === 0) { cont.innerHTML = '<div class="text-center py-5 text-muted">ไม่พบประวัติการผลิต</div>'; return; }
                ALL_LOGS_DATA = logs;
                if (typeof renderJobTrendChart === "function") renderJobTrendChart(logs);

                let finalHtml = '<div class="d-flex justify-content-center gap-2 mb-3 bg-white p-2 rounded shadow-sm sticky-top" style="top:0; z-index:100;">' +
                                '<button id="btn-map-std" class="btn btn-sm btn-dark px-3 rounded-pill" onclick="setMapMode(\'STD\')">Standard Map</button>' +
                                '<button id="btn-map-dev" class="btn btn-sm btn-outline-danger px-3 rounded-pill" onclick="setMapMode(\'DEV\')">Deviation Map</button>' +
                                '<button id="btn-map-heat" class="btn btn-sm btn-outline-warning px-3 rounded-pill" onclick="setMapMode(\'HEAT\')">🔥 Heat Trail</button>' +
                            '</div>';

                logs.forEach(function(l, i) {
                    const canvasId = '3d-canvas-' + i;
                    const positions = ['H', 'HM', 'M', 'MT', 'T'];
                    
                    const wRow = '<tr><td class="fw-bold bg-light">Width</td>' + positions.map(function(p) { return '<td>' + (l['w'+p]||'-') + '</td>'; }).join('') + '</tr>';
                    const tRows = [1, 2, 3].map(function(tNum) {
                        return '<tr><td class="fw-bold bg-light">T' + tNum + '</td>' + positions.map(function(p) {
                            const val = l['t'+p+tNum];
                            return '<td class="' + getSpecClass(val, minS, maxS) + '">' + (parseFloat(val) > 0 ? parseFloat(val).toFixed(3) : '-') + '</td>';
                        }).join('') + '</tr>';
                    });

                    // สร้างส่วนรูปภาพแบบปลอดภัย (วงกลมเหลือง)
                    let imgGalleryHtml = "";
                    if (l.img && l.img.trim() !== "") {
                        const urls = l.img.split(',');
                        let imgThumbs = "";
                        urls.forEach(function(urlStr) {
                            const cleanUrl = urlStr.trim();
                            const fileIdMatch = cleanUrl.match(/[-\w]{25,}/);
                            const thumbUrl = fileIdMatch ? "https://lh3.googleusercontent.com/u/0/d/" + fileIdMatch[0] + "=w200-h200-p-k-no-iv1" : cleanUrl;
                            imgThumbs += '<a href="' + cleanUrl + '" target="_blank">' +
                                        '<img src="' + thumbUrl + '" class="img-thumb shadow-sm" style="width:65px; height:65px; object-fit:cover; border-radius:8px; border:2px solid #fff; margin-right:5px;" onerror="this.src=\'https://via.placeholder.com/65?text=IMG\'">' +
                                        '</a>';
                        });
                        imgGalleryHtml = '<div class="mt-3 p-2 rounded" style="background: #f8fafc; border: 1px solid #e2e8f0;">' +
                                        '<div class="img-container-label mb-2"><i class="fa-solid fa-camera"></i> รูปถ่ายบันทึกหน้างาน</div>' +
                                        '<div class="img-gallery d-flex flex-wrap">' + imgThumbs + '</div>' +
                                        '</div>';
                    }

                    const displaySlitPlan = String(l.slitPlan || "").replace(/^'/, '');

                    // ประกอบ HTML ม้วนลูกแต่ละม้วน
                    finalHtml += '<div class="qc-card mb-5 border rounded-4 overflow-hidden bg-white shadow-sm">' +
                        '<div class="p-2 px-3 bg-light d-flex justify-content-between align-items-center border-bottom">' +
                            '<span class="fw-bold text-primary" style="font-size:12px;"><i class="fa-solid fa-box"></i> ม้วน: ' + (l.coilNo || (i+1)) + '</span>' +
                            '<span class="small text-muted" style="font-size:9px;">บันทึกเมื่อ: ' + l.timestamp + '</span>' +
                        '</div>' +
                        '<div class="row g-0">' +
                            '<div class="col-lg-7 d-flex flex-column" style="background: #0f172a; position:relative; min-height:250px;">' +
                                '<div class="compact-flatness-box" id="flat-box-' + i + '" style="display:none;">' +
                                    '<span class="flat-title-mini">Steel Profile</span>' +
                                    '<span class="shape-status-text" id="flat-text-' + i + '">-</span>' +
                                    '<span class="crown-val-mini" id="crown-display-' + i + '">Crown: 0.000</span>' +
                                    '<div class="flat-bar-bg"><div id="flat-bar-' + i + '" class="flat-bar-fill" style="width:0%; height:100%;"></div></div>' +
                                '</div>' +
                                '<div class="thk-color-legend" id="3d-legend-' + i + '" style="display:none;">' +
                                    '<div class="legend-values" id="leg-vals-' + i + '"></div>' +
                                    '<div class="color-bar-gradient" id="grad-bar-' + i + '"></div>' +
                                '</div>' +
                                '<div id="btn-load-3d-' + i + '" class="text-center py-5 my-auto">' +
                                    '<button class="btn btn-sm btn-outline-info rounded-pill px-4" onclick="load3DSpecific(' + i + ')">LOAD DIGITAL TWIN</button>' +
                                '</div>' +
                                '<canvas id="' + canvasId + '" style="width:100%; height:300px; touch-action:none; display:none;"></canvas>' +
                                '<div id="slice-ctrl-' + i + '" class="p-2" style="display:none; background:rgba(0,0,0,0.9); border-top:1px solid #1e293b;">' +
                                    '<div class="meter-display-bar">' +
                                        '<span class="meter-label"><i class="fa-solid fa-scissors"></i> <span id="slice-val-' + i + '">0.0</span> m</span>' +
                                        '<span class="dev-label-bottom" id="dev-trend-box-' + i + '">Dev: 0.000</span>' +
                                    '</div>' +
                                    '<input type="range" class="form-range custom-range-mobile" id="slider-' + i + '" min="0" max="1" step="0.001" value="0" oninput="updateSlice(' + i + ', this.value)">' +
                                '</div>' +
                            '</div>' +
                            '<div class="col-lg-5 p-2 bg-white border-start hist-card-right">' +
                                '<div class="hist-order-workbench border rounded-4 p-0 bg-light mb-2 shadow-sm overflow-hidden" style="position:relative;">' +
                                    '<div class="p-2 d-flex justify-content-between align-items-center bg-white border-bottom">' +
                                        '<small class="fw-bold text-muted" style="font-size:10px;">Workbench (จิ้มวางใบมีด)</small>' +
                                        '<small id="slice-stat-text-' + i + '" class="fw-bold text-primary" style="font-size:9px;"></small>' +
                                    '</div>' +
                                    '<div style="position:relative;">' +
                                        '<canvas id="slice-canvas-' + i + '" width="300" height="90" style="width:100%; height:90px; cursor:crosshair;"></canvas>' +
                                        '<div id="knife-container-' + i + '" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>' +
                                    '</div>' +
                                    '<div class="cutting-ruler" id="ruler-' + i + '"></div>' +
                                '</div>' +
                                '<div id="slitting-ctrl-' + i + '" class="hist-order-slit p-2 mb-2 rounded" style="background:#0f172a;">' +
                                    '<label class="text-white-50" style="font-size:9px;">ปรับแผนการซอย (คีย์เลข หรือ จิ้มบนรูป)</label>' +
                                    '<input type="text" class="form-control form-control-sm bg-dark text-success border-success fw-bold" ' +
                                            'id="slit-input-' + i + '" value="' + displaySlitPlan + '" placeholder="เช่น 400, 400..." ' +
                                            'oninput="syncKeyInputToCanvas(' + i + ', this.value)">' +
                                    '<div id="slit-stats-' + i + '" class="d-flex gap-2 mt-2 pb-1 overflow-auto" style="scrollbar-width: thin;"></div>' +
                                '</div>' +
                                '<div id="operator-actions-' + i + '" style="display:none;" class="hist-order-actions mb-2">' +
                                    '<div class="d-flex gap-1">' +
                                        '<button class="btn btn-primary btn-sm flex-grow-1 fw-bold" onclick="commitSlitIdentities(' + i + ')">บันทึกอัตลักษณ์</button>' +
                                        '<button class="btn btn-outline-danger btn-sm" onclick="confirmResetAndEdit(' + i + ')">ล้าง</button>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="hist-order-meta row g-1 mb-2 text-center" style="font-size:10px;">' +
                                    '<div class="col-4"><div class="p-1 border rounded bg-light"><div class="text-muted" style="font-size:8px;">TMT</div><div class="fw-bold text-truncate">' + (l.tmtNo||'-') + '</div></div></div>' +
                                    '<div class="col-4"><div class="p-1 border rounded bg-light"><div class="text-muted" style="font-size:8px;">HEAT</div><div class="fw-bold text-truncate">' + (l.heatNo||'-') + '</div></div></div>' +
                                    '<div class="col-4"><div class="p-1 border rounded bg-light"><div class="text-muted" style="font-size:8px;">M-COIL</div><div class="fw-bold text-truncate">' + (l.mCoil||'-') + '</div></div></div>' +
                                '</div>' +
                                '<div class="hist-order-table">' +
                                '<div class="d-flex justify-content-between align-items-end px-1 mb-1">' +
                                    '<div class="fw-bold" style="font-size:13px;"><span class="badge bg-primary me-1">' + l.millNo + '</span> ' + targetThkDisplay + ' mm</div>' +
                                    '<div class="text-end fw-bold text-dark" style="font-size:15px;">' + Number(l.weight).toLocaleString() + ' <small class="text-muted" style="font-size:8px;">KG</small></div>' +
                                '</div>' +
                                '<div class="table-responsive">' +
                                    '<table class="table table-sm table-bordered text-center mb-0" style="font-size:10px;">' +
                                        '<thead class="table-light"><tr><th></th><th>H</th><th>HM</th><th>M</th><th>MT</th><th>T</th></tr></thead>' +
                                        '<tbody>' + wRow + tRows + '</tbody>' +
                                    '</table>' +
                                '</div>' +
                                imgGalleryHtml +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                });
                cont.innerHTML = finalHtml;
                if (logs.length > 0) setTimeout(function() { if(typeof load3DSpecific === "function") load3DSpecific(0); }, 500);
            }).getJobLogs(jobId);
        }
        
        function showLoading() { document.getElementById('loading').style.display='flex'; }
        function hideLoading() { document.getElementById('loading').style.display='none'; }

        function openAddJobModal() {
            const f = document.getElementById('add-job-form');
            f.reset();
            f.newJobId.readOnly = false; // เปิดให้พิมพ์ Job ID ได้
            document.getElementById('new-machine').value = CURRENT_MACHINE;
            
            const btn = document.getElementById('btn-add-job-save');
            btn.innerText = "สร้างแผนงานใหม่";
            
            // ล้างค่าพิเศษที่อาจค้างมาจากการกด "แก้ไข"
            f.dataset.mode = "ADD"; 

            new bootstrap.Modal(document.getElementById('modal-add-job')).show();
        }

        // --- [แก้ไข] ส่วน Submit สร้าง Job ใหม่: เพิ่ม Alert ถ้าไม่เจอ STD ---
        document.getElementById('add-job-form').onsubmit = async function(e) {
            e.preventDefault();
            const f = this;
            const mode = f.dataset.mode || "ADD"; 
            const btn = document.getElementById('btn-add-job-save');
            const originalText = btn.innerText;
            const fileIn = document.getElementById('new-job-file'); // ช่องเลือกรูปใบสั่ง

            // 1. ดึงข้อมูลจากฟอร์ม
            const fd = {};
            new FormData(f).forEach((v, k) => fd[k] = v);

            // 2. จัดการรูปภาพใบสั่งผลิต (ถ้ามีการเลือกรูป)
            let filePayload = null;
            if (fileIn && fileIn.files.length > 0) {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i> กำลังอัพโหลดรูป...';
                try {
                    filePayload = await compressImage(fileIn.files[0]); // บีบอัดรูปก่อนส่ง
                } catch (err) {
                    console.error("Image compression error:", err);
                }
            }

            // 3. เริ่มกระบวนการส่งข้อมูลไป Server
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i> กำลังบันทึก...';

            if (mode === "EDIT") {
                // กรณีแก้ไข (EDIT)
                callGAS('hide', [], res => {
                    btn.disabled = false; btn.innerText = originalText;
                    if (res === "SUCCESS") {
                        Swal.fire({ icon: 'success', title: 'แก้ไขข้อมูลสำเร็จ', timer: 1500, showConfirmButton: false });
                        bootstrap.Modal.getInstance(document.getElementById('modal-add-job')).hide();
                        refreshAllData(() => { setupQueue(); });
                    } else {
                        Swal.fire("Error", res, "error");
                    }
                }, null);
                        refreshAllData(() => { setupQueue(); });
                    } else {
                        Swal.fire("Error", res, "error");
                    }
                }).updateJobData(fd);
            } else {
                // กรณีสร้างใหม่ (ADD) - แก้ไขจาก null เป็น filePayload
                callGAS('hide', [], res => {
                    btn.disabled = false; btn.innerText = originalText;
                    if (res === "SUCCESS") {
                        Swal.fire({ icon: 'success', title: 'สร้างแผนงานสำเร็จ', timer: 1500, showConfirmButton: false });
                        bootstrap.Modal.getInstance(document.getElementById('modal-add-job')).hide();
                        refreshAllData(() => { setupQueue(); });
                    } else if (res === "DUPLICATE") {
                        Swal.fire("Job ID ซ้ำ", "รหัส Job นี้มีอยู่ในระบบแล้ว", "warning");
                    } else {
                        Swal.fire("Error", res, "error");
                    }
                }, null);
                        refreshAllData(() => { setupQueue(); });
                    } else if (res === "DUPLICATE") {
                        Swal.fire("Job ID ซ้ำ", "รหัส Job นี้มีอยู่ในระบบแล้ว", "warning");
                    } else {
                        Swal.fire("Error", res, "error");
                    }
                }).addNewJob(fd, filePayload); // <--- เปลี่ยนจาก null เป็น filePayload
            }
        };


          function switchRecordTab(code) {
              // 1. ปิดทุก Section & เอา Active ออกจากปุ่ม
              document.querySelectorAll('.input-section').forEach(el => el.classList.remove('active'));
              document.querySelectorAll('#pills-tab .nav-link').forEach(btn => btn.classList.remove('active'));
              
              // 2. เปิด Section ที่เลือก
              document.getElementById('sec-' + code).classList.add('active');
              
              // 3. Highlight ปุ่ม (ใช้ Loop หาปุ่มที่กด)
              // Map code กับ Index ของปุ่ม
              const mapIndex = { 'H':0, 'HM':1, 'M':2, 'MT':3, 'T':4, 'Review':5 };
              const buttons = document.querySelectorAll('#pills-tab .nav-link');
              if(buttons[mapIndex[code]]) buttons[mapIndex[code]].classList.add('active');

              // [ใหม่] ถ้ากด Tab Review ให้ดึงข้อมูลมาทำตารางสรุป
              if (code === 'Review') {
                  updateReviewTable();
              }

              drawStripProfile(); 

          }

          // [ใหม่] ฟังก์ชันสร้างตารางสรุป
          function updateReviewTable() {
              const f = document.getElementById('record-form');
              const positions = [{k:'H',l:'ต้น'}, {k:'HM',l:'30m H'}, {k:'M',l:'กลาง'}, {k:'MT',l:'30m T'}, {k:'T',l:'ท้าย'}];
              
              let html = '';
              positions.forEach(p => {
                  const rowData = [f['thick'+p.k+'1']?.value, f['thick'+p.k+'2']?.value, f['thick'+p.k+'3']?.value];
                  html += `<tr>
                      <td class="fw-bold bg-light">${p.l}</td>
                      <td>${f['width'+p.k]?.value || '-'}</td>
                      ${rowData.map(v => {
                          const cls = getSpecClass(v, CURRENT_JOB_STD?.min, CURRENT_JOB_STD?.max);
                          return `<td class="${cls}">${parseFloat(v) > 0 ? parseFloat(v).toFixed(2) : '-'}</td>`;
                      }).join('')}
                      <td>${f['cond'+p.k]?.value || '-'}</td>
                  </tr>`;
              });
              document.getElementById('review-table-body').innerHTML = html;
          }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('auto-refresh-toggle');
            if (toggle.checked) {
                // เริ่มจับเวลา: เรียก showDashboard(true) ทุกๆ 30 วินาที
                refreshTimer = setInterval(() => {
                    // เช็คว่ายังอยู่หน้า Dashboard ไหม? ถ้าไม่อยู่ไม่ต้องโหลด
                    if(document.getElementById('screen-dashboard').classList.contains('active-screen')) {
                        showDashboard(true); // true = ไม่ต้องขึ้น Loading เต็มจอ
                    }
                }, 30000); // 30000 ms = 30 วินาที
                
                // แจ้งเตือนเล็กน้อย
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                Toast.fire({ icon: 'success', title: 'Auto Refresh: ON' });

            } else {
                // ยกเลิกจับเวลา
                if (refreshTimer) clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        function openDailyPlanModal() {
            const tbody = document.getElementById('daily-plan-list');
            tbody.innerHTML = '';
            
            // 1. ดึง Job ที่สถานะ Waiting หรือ Running ของเครื่องปัจจุบัน
            const jobs = ALL_DATA.jobs.filter(j => 
                j.machine === CURRENT_MACHINE && 
                (j.status === 'Waiting' || j.status === 'Running')
            );
            
            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ไม่มีงานรอผลิต</td></tr>';
            } else {
                jobs.forEach(j => {
                    const total = j.totalCoils || 0;
                    const done = j.produced || 0;
                    const remaining = Math.max(0, total - done);
                    
                    // ถ้าเคยตั้งเป้าไว้ให้ใช้เป้าเดิม ถ้าไม่เคยให้ใช้ยอดคงเหลือ (Remaining)
                    let defaultVal = j.dailyTarget > 0 ? j.dailyTarget : remaining;
                    
                    // ป้องกันกรณีเป้าเกินยอดคงเหลือ (เช่น เหลือ 2 แต่เป้าค้าง 5)
                    // if (defaultVal > remaining) defaultVal = remaining; 

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="ps-3 fw-bold">${j.jobId}</td>
                        <td><div class="small text-muted">${j.customer}</div></td>
                        <td class="text-center text-secondary">${total}</td>
                        <td class="text-center text-success fw-bold">${done}</td>
                        <td class="p-2">
                            <input type="number" class="form-control text-center fw-bold text-primary plan-input" 
                                   data-job="${j.jobId}" 
                                   value="${defaultVal}" 
                                   min="0" 
                                   onchange="calcPlanSum()">
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            calcPlanSum(); // คำนวณยอดรวมครั้งแรก
            new bootstrap.Modal(document.getElementById('modal-daily-plan')).show();
        }
        
        function calcPlanSum() {
            let sum = 0;
            document.querySelectorAll('.plan-input').forEach(inp => {
                sum += parseInt(inp.value) || 0;
            });
            document.getElementById('sum-daily-target').innerText = sum;
        }
        
        function saveDailyPlan() {
            const planList = [];
            document.querySelectorAll('.plan-input').forEach(inp => {
                planList.push({
                    jobId: inp.getAttribute('data-job'),
                    target: parseInt(inp.value) || 0
                });
            });
            
            // Show Loading
            const btn = document.querySelector('#modal-daily-plan .btn-primary');
            const oldText = btn.innerText;
            btn.disabled = true; btn.innerText = "Saving...";
            
            callGAS('hide', [], res => {
                btn.disabled = false; btn.innerText = oldText;
                bootstrap.Modal.getInstance(document.getElementById('modal-daily-plan')).hide();
                
                // Reload Data
                showLoading();
                callGAS('getInitialData', [], data => {
                    ALL_DATA = data;
                    const rJob = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');
                    rJob ? setupRunning(rJob) : setupQueue();
                    hideLoading();
                }, null);
                
            }, null);
                
                // Reload Data
                showLoading();
                callGAS('getInitialData', [], data => {
                    ALL_DATA = data;
                    const rJob = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');
                    rJob ? setupRunning(rJob) : setupQueue();
                    hideLoading();
                }, null);
                
            }).saveDailyPlan(planList);
        }

        function exportToExcel() {
            // 1. ดึงวันที่จากหน้าจอ
            const sDate = document.getElementById('dash-date-start').value;
            const eDate = document.getElementById('dash-date-end').value;

            if(!sDate || !eDate) {
                Swal.fire("แจ้งเตือน", "กรุณาเลือกวันที่เริ่มต้น-สิ้นสุดก่อนครับ", "warning");
                return;
            }

            // 2. เปลี่ยนข้อความปุ่มให้ User รู้ว่ากำลังทำงาน
            const btn = document.querySelector('button[onclick="exportToExcel()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Downloading...';
            btn.disabled = true;

            // 3. เรียกข้อมูลจาก Server
            callGAS('withSuccessHandler', [data => {
                if(!data || data.length === 0) {
                    Swal.fire("ไม่พบข้อมูล", "ไม่มีข้อมูลการผลิตในช่วงวันที่เลือก", "info"], null, null);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // 4. สร้างไฟล์ Excel (ด้วย SheetJS)
                const ws = XLSX.utils.json_to_sheet(data); // แปลง JSON เป็น Sheet
                const wb = XLSX.utils.book_new();          // สร้าง Workbook ใหม่
                XLSX.utils.book_append_sheet(wb, ws, "Production_Log"); // ใส่ Sheet เข้าไป

                // ตั้งชื่อไฟล์: Production_Log_2023-10-01.xlsx
                const fileName = `Production_Log_${sDate}_to_${eDate}.xlsx`;
                
                // ดาวน์โหลด
                XLSX.writeFile(wb, fileName);

                // คืนค่าปุ่ม
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // แจ้งเตือนความสำเร็จ
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: 'Export เรียบร้อย!' });

            }).getLogsForExport(sDate, eDate);
        }

        // 1. ฟังก์ชันก๊อปปี้ข้อมูล (แบบรวมศูนย์)
        function copyFromPrevious(curr) {
            const f = document.getElementById('record-form');
            const sequence = ['H', 'HM', 'M', 'MT', 'T'];
            const prev = sequence[sequence.indexOf(curr) - 1];
            if (!prev) return;

            // ก๊อปปี้ Width และ Condition (ใช้ชื่อใหม่ H, HM, M, MT, T)
            f['width'+curr].value = f['width'+prev].value;
            f['cond'+curr].value = f['cond'+prev].value;
            
            // ก๊อปปี้ Thick 1, 2, 3
            [1, 2, 3].forEach(i => {
                f['thick'+curr+i].value = f['thick'+prev+i].value;
            });

            // สั่งเช็คสี QC ทันทีที่ดึงข้อมูลมา
            const currentSection = document.getElementById('sec-' + curr);
            currentSection.querySelectorAll('.qc-thick').forEach(input => validateQC(input));

            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 800 });
            Toast.fire({ icon: 'info', title: `ดึงข้อมูลจาก ${prev} มาแล้ว` });
        }

        // 2. ฟังก์ชันสลับแท็บอัตโนมัติเมื่อกรอกช่องสุดท้ายของหน้า
        function setupAutoSwitch() {
            const sequence = ['H', 'HM', 'M', 'MT', 'T'];
            sequence.forEach((code, index) => {
                const lastInput = document.getElementsByName('thick' + code + '3')[0];
                if (lastInput) {
                    lastInput.addEventListener('change', () => {
                        if (lastInput.value !== "" && index < sequence.length - 1) {
                            setTimeout(() => {
                                switchRecordTab(sequence[index + 1]);
                                const nextInp = document.getElementsByName('width' + sequence[index + 1])[0];
                                if (nextInp) nextInp.focus();
                            }, 300);
                        } else if (index === sequence.length - 1) {
                            switchRecordTab('Review');
                        }
                    });
                }
            });
        }

        function prepareTrendFilters() {
            // 1. ใส่รายชื่อเครื่องจักร (เพิ่ม ALL เข้าไปด้วย)
            const mSel = document.getElementById('trend-machine');
            mSel.innerHTML = '<option value="ALL">รวมทุกเครื่อง (All)</option>';
            ALL_DATA.machines.forEach(m => mSel.add(new Option(m, m)));

            // 2. โหลดความหนาครั้งแรก (ตาม Mill Group ที่ถูกเลือกอยู่)
            updateThicknessDropdown();
        }

        function updateThicknessDropdown() {
            const millGroup = document.getElementById('trend-mill-group').value;
            const tSel = document.getElementById('trend-thickness');
            tSel.innerHTML = '<option value="">กำลังโหลด...</option>';

            if (millGroup === "ALL") {
                // กรณีเลือก ALL ให้ดึงความหนารวมทั้งโรงงาน
                callGAS('withSuccessHandler', [list => {
                    renderThkOptions(list], null, null);
                }).getGlobalThicknessList();
            } else {
                // กรณีเลือกกลุ่มเฉพาะ ให้ดึงความหนาเฉพาะกลุ่มนั้น
                callGAS('withSuccessHandler', [list => {
                    renderThkOptions(list], null, null);
                }).getThicknessByMillGroup(millGroup);
            }

            // ฟังก์ชันย่อยสำหรับวาด Option
            function renderThkOptions(list) {
                tSel.innerHTML = '<option value="ALL">ALL</option>';
                if (list && list.length > 0) {
                    list.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t;
                        opt.text = t.toFixed(2) + " mm";
                        tSel.appendChild(opt);
                    });
                }
            }
        }      

        function loadTrendChart() {
            // ดึงค่าจาก Filter ทุกช่อง
            const filterObj = {
                millGroup: document.getElementById('trend-mill-group').value,
                targetThk: document.getElementById('trend-thickness').value,
                workType:  document.getElementById('trend-work-type').value,
                machineId: document.getElementById('trend-machine').value,
                pointType: document.getElementById('trend-point-type').value,
                search:    document.getElementById('trend-search') ? document.getElementById('trend-search').value : "", // รองรับช่องค้นหา
                start:     document.getElementById('trend-date-start').value,
                end:       document.getElementById('trend-date-end').value
            };

            showLoading();
            
            callGAS('withSuccessHandler', [result => {
                hideLoading(], null, null);
                
                const points = result.points;
                const spec = result.spec;

                // อัปเดตกล่องสถิติ Cp/Cpk
                updateTrendStats(result);

                if (!points || points.length === 0) {
                    if (trendChartInstance) trendChartInstance.destroy();
                    return Swal.fire("ไม่พบข้อมูล", "ไม่พบประวัติการผลิตที่ตรงกับเงื่อนไขการกรองของคุณ", "info");
                }

                const ctx = document.getElementById('trendChart').getContext('2d');
                if (trendChartInstance) trendChartInstance.destroy();

                // กำหนดสีประจำตำแหน่ง
                const colors = { H: '#fd7e14', HM: '#ffc107', M: '#4361ee', MT: '#9b5de5', T: '#d63384' };
                const ptText = filterObj.pointType === "AVG" ? "เฉลี่ย" : "จุดที่ " + filterObj.pointType;

                // สร้างชุดข้อมูล 5 ตำแหน่ง
                const datasets = [
                    { label: `ต้นม้วน (${ptText})`, data: points.map(d => d.avgH), borderColor: colors.H, backgroundColor: colors.H },
                    { label: `30m แรก (${ptText})`, data: points.map(d => d.avgHM), borderColor: colors.HM, backgroundColor: colors.HM },
                    { label: `กลางม้วน (${ptText})`, data: points.map(d => d.avgM), borderColor: colors.M, backgroundColor: colors.M },
                    { label: `30m ท้าย (${ptText})`, data: points.map(d => d.avgMT), borderColor: colors.MT, backgroundColor: colors.MT },
                    { label: `ท้ายม้วน (${ptText})`, data: points.map(d => d.avgT), borderColor: colors.T, backgroundColor: colors.T }
                ].map(ds => ({
                    ...ds,
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 2,
                    fill: false,
                    spanGaps: true
                }));

                // เพิ่มเส้น Spec (เฉพาะกรณีที่มีค่า USL/LSL ส่งมา)
                if (spec && spec.usl !== null) {
                    datasets.push({
                        label: 'MAX Spec',
                        data: Array(points.length).fill(spec.usl),
                        borderColor: '#ef4444',
                        borderDash: [5, 5],
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false
                    });
                    datasets.push({
                        label: 'MIN Spec',
                        data: Array(points.length).fill(spec.lsl),
                        borderColor: '#ef4444',
                        borderDash: [5, 5],
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false
                    });
                }

                trendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: points.map(d => d.label),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 11 }, usePointStyle: true } },
                            tooltip: {
                                callbacks: {
                                    title: (ctx) => `Job: ${points[ctx[0].dataIndex].jobId}`,
                                    afterBody: (ctx) => `Coil: ${points[ctx[0].dataIndex].coil}`
                                }
                            }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: 'ความหนา (mm)' },
                                // ปรับสเกลให้อัตโนมัติถ้าไม่มี Spec
                                suggestedMin: spec.lsl ? spec.lsl - 0.05 : undefined,
                                suggestedMax: spec.usl ? spec.usl + 0.05 : undefined
                            }
                        }
                    }
                });
            }).getAdvancedTrendData(filterObj);
        }

        function updateTrendStats(result) {
            const data = result.points;
            const spec = result.spec;
            const container = document.getElementById('trend-stats-container');
            
            if (!data || data.length === 0 || !spec || spec.usl === null) {
                if(container) container.style.display = 'none';
                return;
            }

            let allValues = [];
            data.forEach(d => {
                [d.avgH, d.avgHM, d.avgM, d.avgMT, d.avgT].forEach(v => {
                    if (v !== null && !isNaN(v)) allValues.push(v);
                });
            });

            if (allValues.length === 0) return;

            const avg = allValues.reduce((a, b) => a + b) / allValues.length;
            const squareDiffs = allValues.map(v => Math.pow(v - avg, 2));
            const sd = Math.sqrt(squareDiffs.reduce((a, b) => a + b) / squareDiffs.length);

            let cp = 0, cpk = 0;
            if (sd > 0) {
                cp = (spec.usl - spec.lsl) / (6 * sd);
                const cpu = (spec.usl - avg) / (3 * sd);
                const cpl = (avg - spec.lsl) / (3 * sd);
                cpk = Math.min(cpu, cpl);
            }

            document.getElementById('stat-avg').innerText = avg.toFixed(3);
            document.getElementById('stat-spec-range').innerText = `${spec.lsl.toFixed(2)} - ${spec.usl.toFixed(2)}`;
            document.getElementById('stat-cp').innerText = cp.toFixed(2);
            document.getElementById('stat-cpk').innerText = cpk.toFixed(2);

            const interpretEl = document.getElementById('stat-interpretation');
            const cpkInp = document.getElementById('stat-cpk');
            
            if (cpk >= 1.33) {
                cpkInp.className = "fs-4 text-success";
                interpretEl.innerHTML = "✅ <b>ดีเยี่ยม:</b> กระบวนการผลิตนิ่งและอยู่ในเกณฑ์ดีเยี่ยม";
            } else if (cpk >= 1.0) {
                cpkInp.className = "fs-4 text-warning";
                interpretEl.innerHTML = "⚠️ <b>พอใช้:</b> อยู่ในเกณฑ์มาตรฐาน แต่ควรเฝ้าระวัง";
            } else {
                cpkInp.className = "fs-4 text-danger";
                interpretEl.innerHTML = "❌ <b>อันตราย:</b> กระบวนการผลิตไม่มีความสามารถเพียงพอ มีโอกาสหลุดสเปกสูง";
            }

            if(container) container.style.display = 'block';
        }     

        function drawStripProfile() {
            const canvas = document.getElementById('profileCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            // ตั้งขนาดพิกเซลจริงให้คมชัด
            if (canvas.width !== Math.floor(rect.width * dpr)) {
                canvas.width = Math.floor(rect.width * dpr);
                canvas.height = Math.floor(rect.height * dpr);
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.scale(dpr, dpr);
            
            const w = rect.width;
            const h = rect.height;
            
            const activeSection = document.querySelector('.input-section.active');
            if (!activeSection) { ctx.restore(); return; }
            
            const inputs = activeSection.querySelectorAll('.qc-thick');
            const p1 = parseFloat(inputs[0].value) || 0;
            const p2 = parseFloat(inputs[1].value) || 0;
            const p3 = parseFloat(inputs[2].value) || 0;

            if (p1 === 0 || p2 === 0 || p3 === 0) { ctx.restore(); return; }

            const minVal = Math.min(p1, p2, p3);
            const getY = (val) => h - 25 - ((val - minVal) * 200);

            ctx.beginPath();
            ctx.moveTo(40, h - 15);
            ctx.lineTo(w - 40, h - 15);
            ctx.lineTo(w - 40, getY(p3));
            ctx.quadraticCurveTo(w / 2, getY(p2) - 5, 40, getY(p1));
            ctx.closePath();
            
            const crown = p2 - ((p1 + p3) / 2);
            ctx.fillStyle = crown >= 0 ? 'rgba(67, 97, 238, 0.15)' : 'rgba(239, 68, 68, 0.15)';
            ctx.fill();
            ctx.strokeStyle = crown >= 0 ? '#4361ee' : '#ef4444';
            ctx.lineWidth = 2;
            ctx.stroke();

            const points = [
                { x: 40, y: getY(p1), val: p1, label: 'T1' },
                { x: w / 2, y: getY(p2), val: p2, label: 'T2' },
                { x: w - 40, y: getY(p3), val: p3, label: 'T3' }
            ];

            points.forEach(pt => {
                ctx.fillStyle = '#1e293b';
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 3.5, 0, Math.PI * 2); ctx.fill();
                ctx.font = 'bold 10px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(pt.val.toFixed(3), pt.x, pt.y - 12);
            });
            ctx.restore();

            // อัปเดต Crown / Wedge badge ใน Simulation panel
            const crownBadge = document.getElementById('live-crown-val');
            const wedgeBadge = document.getElementById('live-wedge-val');
            if (crownBadge) {
                const c = p2 - ((p1 + p3) / 2);
                crownBadge.innerText = 'Crown: ' + c.toFixed(3);
                crownBadge.className = 'stat-badge-crown text-white ' +
                    (Math.abs(c) > 0.035 ? 'bg-danger' : Math.abs(c) > 0.008 ? 'bg-warning' : 'bg-primary');
            }
            if (wedgeBadge) {
                const w2 = Math.abs(p1 - p3);
                wedgeBadge.innerText = 'Wedge: ' + w2.toFixed(3);
                wedgeBadge.className = 'stat-badge-crown text-dark ' +
                    (w2 > 0.03 ? 'bg-danger text-white' : 'bg-warning');
            }
        }

        // สั่งให้วาดรูปทุกครั้งที่มีการพิมพ์ตัวเลข
        // เพิ่มคำสั่งนี้เข้าไปในฟังก์ชัน openRecordModal ตรงที่ผูก Event ครับ
        document.querySelectorAll('.qc-thick').forEach(input => {
            input.addEventListener('input', function() { 
                validateQC(this); 
                drawStripProfile(); // <--- เพิ่มตรงนี้
            });
        });

        function drawCoilFilmStrip(l, canvasId) {
            // ต้องทำใน setTimeout เพื่อรอให้ HTML Render เสร็จก่อน
            setTimeout(() => {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;

                // เตรียมข้อมูล 5 ตำแหน่ง x 3 จุด
                const positions = [
                    { p1: l.tH1,  p2: l.tH2,  p3: l.tH3 },
                    { p1: l.tHM1, p2: l.tHM2, p3: l.tHM3 },
                    { p1: l.tM1,  p2: l.tM2,  p3: l.tM3 },
                    { p1: l.tMT1, p2: l.tMT2, p3: l.tMT3 },
                    { p1: l.tT1,  p2: l.tT2,  p3: l.tT3 }
                ];

                // หาค่า Min/Max ทั้งหมดเพื่อกำหนด Scale กราฟ
                const allVals = [l.tH1, l.tH2, l.tH3, l.tHM1, l.tHM2, l.tHM3, l.tM1, l.tM2, l.tM3, l.tMT1, l.tMT2, l.tMT3, l.tT1, l.tT2, l.tT3]
                                .map(v => parseFloat(v)).filter(v => v > 0);
                const minThk = Math.min(...allVals);
                const maxThk = Math.max(...allVals);
                const diff = (maxThk - minThk) || 0.1;
                
                const padding = 20;
                const graphHeight = h - (padding * 2);
                const sectionWidth = w / 5;

                // ฟังก์ชันแปลงค่าความหนาเป็นพิกัด Y
                const getY = (val) => {
                    if (!val || val <= 0) return h/2;
                    // ยิ่งหนา ยิ่งอยู่สูง (Y น้อยลง)
                    return (h - padding) - ((val - minThk) / diff) * graphHeight;
                };

                // วาดเส้นแบ่ง Section (Head, HM, Mid, MT, Tail)
                ctx.strokeStyle = '#334155';
                ctx.setLineDash([5, 5]);
                for (let i = 1; i < 5; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * sectionWidth, 0);
                    ctx.lineTo(i * sectionWidth, h);
                    ctx.stroke();
                }
                ctx.setLineDash([]); // ยกเลิกเส้นประ

                // วาดเส้น 3 สี (P1, P2, P3)
                const colors = ['#fd7e14', '#4361ee', '#ffc107']; // ส้ม, น้ำเงิน, เหลือง
                
                [1, 2, 3].forEach((pIdx, cIdx) => {
                    ctx.beginPath();
                    ctx.strokeStyle = colors[cIdx];
                    ctx.lineWidth = 2;
                    ctx.lineJoin = 'round';

                    positions.forEach((pos, i) => {
                        const x = (i * sectionWidth) + (sectionWidth / 2);
                        const y = getY(pos['p' + pIdx]);
                        
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);

                        // วาดจุดมาร์กเกอร์จิ๋ว
                        ctx.fillStyle = colors[cIdx];
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    ctx.stroke();
                });

            }, 150);
        }

        function showToast(msg) {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'my-toast';
          toast.innerHTML = `<i class="fa-solid fa-check-circle me-2"></i> ${msg}`;
          container.appendChild(toast);
          setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
          }, 2500);
        }

        function setupEnterToTab() {
          const form = document.getElementById('record-form');
          // เลือกเฉพาะช่องที่มองเห็นและไม่ได้ถูกล็อค (Read-only)
          const inputs = Array.from(form.querySelectorAll('input:not([type="hidden"]):not([readonly])'));
          
          inputs.forEach((input, index) => {
            input.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                e.preventDefault(); // กันไม่ให้มันกด Save ทันที
                const nextInput = inputs[index + 1];
                if (nextInput) {
                  nextInput.focus();
                  if (typeof nextInput.select === "function") nextInput.select(); 
                }
              }
            });
          });
        }                

        function renderJobTrendChart(logs) {
            const ctx = document.getElementById('job-trend-chart').getContext('2d');
            if (JOB_TREND_CHART_INSTANCE) JOB_TREND_CHART_INSTANCE.destroy();
            
            const trendData = [...logs].reverse(); 
            
            const getValue = (v1, v2, v3) => {
                if (CURRENT_TREND_MODE === 'T1') return parseFloat(v1) || null;
                if (CURRENT_TREND_MODE === 'T2') return parseFloat(v2) || null;
                if (CURRENT_TREND_MODE === 'T3') return parseFloat(v3) || null;
                let vals = [v1,v2,v3].map(v => parseFloat(v)).filter(v => !isNaN(v) && v > 0);
                return vals.length > 0 ? (vals.reduce((a,b) => a+b) / vals.length) : null;
            };

            const datasets = [
                { label: 'H', data: trendData.map(l => getValue(l.tH1, l.tH2, l.tH3)), borderColor: '#3b82f6', tension: 0.3, pointRadius: 4, fill: false },
                { label: 'HM', data: trendData.map(l => getValue(l.tHM1, l.tHM2, l.tHM3)), borderColor: '#10b981', tension: 0.3, pointRadius: 4, fill: false },
                { label: 'M', data: trendData.map(l => getValue(l.tM1, l.tM2, l.tM3)), borderColor: '#f59e0b', tension: 0.3, pointRadius: 4, fill: false },
                { label: 'MT', data: trendData.map(l => getValue(l.tMT1, l.tMT2, l.tMT3)), borderColor: '#8b5cf6', tension: 0.3, pointRadius: 4, fill: false },
                { label: 'T', data: trendData.map(l => getValue(l.tT1, l.tT2, l.tT3)), borderColor: '#ef4444', tension: 0.3, pointRadius: 4, fill: false }
            ];

            // --- ส่วนที่วาดเส้น Limit ---
            if (CURRENT_JOB_SPEC.max > 0) {
                datasets.push({
                    label: `MAX (${CURRENT_JOB_SPEC.max})`,
                    data: Array(trendData.length).fill(CURRENT_JOB_SPEC.max),
                    borderColor: '#ff0000',
                    borderWidth: 2,
                    borderDash: [5, 5], // เส้นประ
                    pointRadius: 0,     // ไม่เอาจุด
                    fill: false,
                    order: 1            // ให้เส้นอยู่ข้างหลังจุด
                });
                datasets.push({
                    label: `MIN (${CURRENT_JOB_SPEC.min})`,
                    data: Array(trendData.length).fill(CURRENT_JOB_SPEC.min),
                    borderColor: '#ff0000',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 1
                });
            }

            JOB_TREND_CHART_INSTANCE = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(l => l.coilNo),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: {size: 9} } }
                    },
                    scales: {
                        y: { 
                            title: { display: true, text: 'Thickness (mm)' },
                            // บังคับสเกลให้เห็นเส้นแดงเสมอ
                            suggestedMin: CURRENT_JOB_SPEC.min > 0 ? (CURRENT_JOB_SPEC.min - 0.05) : undefined,
                            suggestedMax: CURRENT_JOB_SPEC.max > 0 ? (CURRENT_JOB_SPEC.max + 0.05) : undefined
                        }
                    }
                }
            });
        }

        window.cameraControllers = {};

        window.setCamera = function(canvasId, view) {
            const ctrl = window.cameraControllers[canvasId];
            if (!ctrl) return;

            if (view === '3d')    { ctrl.rotX = -0.4; ctrl.rotY = 0.5; }
            if (view === 'front') { ctrl.rotX = 0;    ctrl.rotY = 0;   } // ดูหน้าตัดตรงๆ
            if (view === 'side')  { ctrl.rotX = 0;    ctrl.rotY = 1.57;} // ดูด้านข้าง (PI/2)
            if (view === 'top')   { ctrl.rotX = -1.57;ctrl.rotY = 0;   } // ดูจากข้างบนลงมา

            ctrl.render(); // สั่งวาดใหม่ทันที
        };


        // ฟังก์ชันสลับโหมด (T1, T2, T3, AVG)
        function updateTrendMode(mode, btn) {
            CURRENT_TREND_MODE = mode;
            // สลับคลาส active ของปุ่ม
            const group = btn.parentElement;
            group.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // วาดกราฟใหม่ด้วยข้อมูลเดิมแต่โหมดใหม่
            if(ALL_LOGS_DATA.length > 0) {
                renderJobTrendChart(ALL_LOGS_DATA);
            }
        }        

        // ฟังก์ชันสำหรับบีบอัดรูปภาพ
        async function compressImage(file) {
            const maxWidth = 1000; // ลดจาก 1280 เหลือ 1000 (ประหยัดพื้นที่ 30%)
            const quality = 0.6;   // ลดจาก 0.7 เหลือ 0.6 (ไฟล์เล็กลงมาก แต่ตาเปล่ายังแยกไม่ออก)

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve({
                            name: file.name.split('.')[0] + "_" + Date.now() + ".jpg", // เติม Timestamp กันชื่อซ้ำ
                            mimeType: "image/jpeg",
                            data: dataUrl.split(',')[1]
                        });
                    };
                };
                reader.onerror = error => reject(error);
            });
        }

        function getDriveId(url) {
            if (!url) return null;
            // ใช้ Regex ที่ครอบคลุมทุกลักษณะของลิงก์ Google Drive
            var parts = url.match(/[-\w]{25,}/);
            return (parts && parts.length > 0) ? parts[0] : null;
        }

        let html5QrCode = null;
        let currentCameraId = null;

        // 1. ฟังก์ชันเปิดกล้อง (ดึงรายชื่อลง Dropdown)
        async function openQRScanner() {
            // สร้าง input file ชั่วคราวเพื่อเปิดกล้องผ่าน OS โดยตรง
            // วิธีนี้ผ่าน iframe ของ Google Apps Script ได้ เพราะเป็น user gesture
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // เปิดกล้องหลังโดยตรงบนมือถือ

            input.onchange = async function() {
                const file = input.files[0];
                if (!file) return;

                showLoading();

                try {
                    // ใช้ Html5Qrcode อ่านจากไฟล์รูปภาพแทนการเปิดกล้องสด
                    const html5QrCodeFile = new Html5Qrcode('qr-reader-file');
                    const result = await html5QrCodeFile.scanFile(file, false);

                    // อ่านได้ — ส่งไปประมวลผลเหมือนเดิม
                    handleParsedQR(result);

                } catch (err) {
                    console.error('QR scan error:', err);
                    Swal.fire({
                        icon: 'warning',
                        title: 'อ่าน QR ไม่สำเร็จ',
                        html: 'โปรดลองใหม่ โดย:<br>• ถ่ายให้ QR อยู่กึ่งกลางและชัดเจน<br>• แสงสว่างเพียงพอ<br>• ระยะห่างพอดี ไม่ใกล้หรือไกลเกินไป',
                        confirmButtonText: 'ลองใหม่'
                    }).then(() => openQRScanner()); // เปิดให้ลองใหม่อัตโนมัติ
                } finally {
                    hideLoading();
                }
            };

            // กระตุ้นให้เปิดกล้อง/แกลเลอรี่ทันที
            input.click();
        }

        // 2. ฟังก์ชันสั่งรันสแกน (แยกออกมาเพื่อให้เรียกซ้ำได้)
        async function startScanning(cameraId) {
            // ล้าง Element ก่อนสร้างใหม่
            document.getElementById("qr-reader").innerHTML = "";
            html5QrCode = new Html5Qrcode("qr-reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            try {
                await html5QrCode.start(
                    cameraId, 
                    config,
                    (decodedText) => {
                        handleParsedQR(decodedText);
                        stopQRScanner();
                    }
                );
            } catch (err) {
                // ถ้าใช้ ID กล้องไม่ได้ ให้ลองใช้ facingMode แทน
                console.warn("Start with ID failed, trying environment mode...");
                try {
                    await html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                        handleParsedQR(decodedText);
                        stopQRScanner();
                    });
                } catch (e) {
                    console.error("Final camera error:", e);
                }
            }
        }   
 

        // 3. ฟังก์ชันสลับกล้อง (เมื่อเปลี่ยนค่าใน Dropdown)
        async function switchCamera(newCameraId) {
            if (html5QrCode) {
                const btn = document.querySelector('button[onclick="stopQRScanner()"]');
                btn.innerText = "กำลังสลับกล้อง...";
                btn.disabled = true;

                try {
                    await html5QrCode.stop(); // ต้องรอให้หยุดสนิทจริงๆ
                    await startScanning(newCameraId); // เปิดกล้องใหม่ด้วย ID ใหม่
                } catch (e) {
                    console.error("Switch error:", e);
                } finally {
                    btn.innerHTML = '<i class="fa-solid fa-video-slash"></i> ปิดกล้อง';
                    btn.disabled = false;
                }
            }
        }

        // 2. ฟังก์ชันปิดกล้อง
        async function stopQRScanner() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    html5QrCode = null;
                } catch (e) {
                    console.error("Stop error:", e);
                }
            }
            document.getElementById('qr-reader-container').style.display = 'none';
        }

        // 3. ฟังก์ชันแยกข้อมูล (Parse) และเติมลงฟอร์ม
        function handleParsedQR(data) {
            try {
                const p = data.split(',');
                if (p.length < 8) { Swal.fire("ข้อมูลไม่ครบ", "QR นี้มีข้อมูลไม่ครบตามโครงสร้าง", "warning"); return; }

                const f = document.getElementById('record-form');
                if(p[4]) f.weight.value = p[4].trim(); // Net weight
                if(p[2]) f.tmtNo.value = p[2].trim();  // TMT No
                if(p[7]) f.heatNo.value = p[7].trim(); // Heat No
                if(p[6]) f.mCoil.value = p[6].trim();  // Coil No

                Swal.fire({ icon: 'success', title: 'สแกนสำเร็จ', timer: 1500, showConfirmButton: false });
            } catch (e) { Swal.fire("ข้อผิดพลาด", "ไม่สามารถประมวลผล QR ได้", "error"); }
        }

        function getSpecClass(val, min, max) {
            const n = parseFloat(val);
            if (isNaN(n) || n === 0) return "";
            if (max > 0 && n > max) return "qc-high"; // เกิน Max = น้ำเงิน
            if (min > 0 && n < min) return "qc-low";  // ต่ำกว่า Min = แดง
            return "";
        }

        // ฟังก์ชันตรวจจับว่าใช่เครื่อง Sandbox หรือไม่
        function checkSandboxMode() {
            const panel = document.getElementById('sandbox-panel');
            if (CURRENT_MACHINE === "SANDBOX") {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // แก้ไขฟังก์ชัน enterSystem เดิมของคุณ ให้เรียก checkSandboxMode ด้วย
        function enterSystem() {
            CURRENT_MACHINE = document.getElementById('machine-select').value;
            const rJob = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');
            checkSandboxMode(); // <--- เพิ่มตรงนี้
            rJob ? setupRunning(rJob) : setupQueue();
        }

        // ฟังก์ชัน "มหาเวทย์ดูดดาว" เติมข้อมูลอัตโนมัติ
        function fillSandbox(type) {
            const f = document.getElementById('record-form');
            const target = parseFloat(document.getElementById('disp-target-thick').value) || 2.0;
            const min = CURRENT_JOB_STD ? CURRENT_JOB_STD.min : target - 0.1;
            const max = CURRENT_JOB_STD ? CURRENT_JOB_STD.max : target + 0.1;

            const positions = ['H', 'HM', 'M', 'MT', 'T'];
            
            // เติม Mill และ Coil เบื้องต้น
            f.millNo.value = "SANDBOX-M";
            f.coilNo.value = Math.floor(Math.random() * 10) + "/10";
            f.weight.value = 25000;

            positions.forEach(p => {
                let val1, val2, val3;
                
                if (type === 'normal') {
                    val1 = val2 = val3 = target;
                } else if (type === 'thin') {
                    val1 = min - 0.05; val2 = min - 0.02; val3 = min - 0.04; // ต่ำกว่า Min
                } else if (type === 'thick') {
                    val1 = max + 0.05; val2 = max + 0.03; val3 = max + 0.06; // สูงกว่า Max
                } else if (type === 'chaos') {
                    val1 = min + (Math.random() * (max - min + 0.1));
                    val2 = min + (Math.random() * (max - min + 0.1));
                    val3 = min + (Math.random() * (max - min + 0.1));
                }

                f['thick' + p + '1'].value = val1.toFixed(2);
                f['thick' + p + '2'].value = val2.toFixed(2);
                f['thick' + p + '3'].value = val3.toFixed(2);
                f['width' + p].value = 1250;
                f['cond' + p].value = "GOOD";
            });

            // สั่งวาด 3D และเช็คสีตารางทันทีที่เติมค่าเสร็จ
            document.querySelectorAll('.qc-thick').forEach(input => validateQC(input));
            drawStripProfile();
            
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
            Toast.fire({ icon: 'info', title: 'จำลองข้อมูลแบบ ' + type });
        }

        function confirmClearSandbox() {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ข้อมูลการผลิตทั้งหมดของเครื่อง SANDBOX จะถูกลบถาวร!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [res => {
                        hideLoading(], null, null);
                        Swal.fire('สำเร็จ!', 'ล้างข้อมูล Sandbox เรียบร้อยแล้ว', 'success');
                        if (CURRENT_JOB_INFO) loadHistory(CURRENT_JOB_INFO.jobId); // รีโหลดประวัติ
                    }).clearSandboxLogs();
                }
            });
        }

        function backToRunning() {
            // หางานที่มีสถานะ Running ของเครื่องปัจจุบัน
            const runningJob = ALL_DATA.jobs.find(j => j.machine === CURRENT_MACHINE && j.status === 'Running');
            if (runningJob) {
                setupRunning(runningJob); // เรียกใช้ฟังก์ชันเดิมเพื่อเข้าหน้า Screen 3
            } else {
                Swal.fire('ไม่พบงาน', 'ปัจจุบันไม่มีงานที่กำลังผลิตอยู่', 'info');
                setupQueue(); // ถ้าไม่เจอให้รีเฟรชหน้า Queue
            }
        }

        function pauseJob(id) {
            Swal.fire({
                title: 'หยุดงานชั่วคราว?',
                text: "งานนี้จะกลับไปอยู่ในคิวรอผลิต",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน Pause',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [() => {
                        // อัปเดตข้อมูลในเครื่องแบบเร็ว (ไม่ต้องโหลดใหม่หมด)
                        const job = ALL_DATA.jobs.find(j => j.jobId === id], null, null);
                        if(job) job.status = 'Waiting';
                        setupQueue();
                        hideLoading();
                    }).pauseJob(id);
                }
            });
        }

        // ฟังก์ชันเปิด Modal แก้ไข (ใช้ Modal เดิมแต่เติมค่าเข้าไป)
        function openEditJobModal(id) {
            const job = ALL_DATA.jobs.find(j => j.jobId === id);
            if (!job) return;

            const f = document.getElementById('add-job-form');
            f.reset();
            resetSlitBuilder(); // ล้างแถวเก่าที่ค้างอยู่ในหน้าจอออกก่อน

            // เติมข้อมูลพื้นฐาน
            f.newJobId.value = job.jobId;
            f.newJobId.readOnly = true;
            f.newMachine.value = job.machine;
            f.newCustomer.value = job.customer;
            f.newDate.value = job.planDate;
            f.newCoils.value = job.totalCoils;
            f.newWorkType.value = job.workType;
            f.newThickness.value = job.thickness;
            f.newMill.value = job.millPlan;
            if (job.stripWidth) f.newStripWidth.value = job.stripWidth;

            // --- จุดสำคัญ: ดึงข้อมูล Slit Plan เก่ามาสร้างแถว ---
            if (job.slitPlan) {
                const planString = String(job.slitPlan).replace(/^'/, '');
                const items = planString.split(',');

                items.forEach(item => {
                    const widthMatch = item.match(/^([0-9.]+)/);      // แกะเอาตัวเลข
                    const noteMatch  = item.match(/\[(.*?)\]/);        // แกะเอาข้อความใน [ ]
                    
                    const w = widthMatch ? widthMatch[1] : '';
                    const n = noteMatch ? noteMatch[1] : '';
                    
                    if (w) addSlitRow(w, n); // สร้างแถวใหม่พร้อมข้อมูลเก่า
                });
            }

            const btn = document.getElementById('btn-add-job-save');
            btn.innerText = "บันทึกการแก้ไขข้อมูล";
            f.dataset.mode = "EDIT";

            new bootstrap.Modal(document.getElementById('modal-add-job')).show();
        }

        // ฟังก์ชันส่งค่าแก้ไขไป Server
        function updateJob(formElement) {
            const btn = document.getElementById('btn-add-job-save');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังบันทึก...';

            // ดึงข้อมูลจากฟอร์มใส่ Object
            const fd = {};
            const formData = new FormData(formElement); // ต้องมีบรรทัดนี้
            formData.forEach((v, k) => fd[k] = v);
            
            callGAS('hide', [], res => {
                btn.disabled = false;
                btn.innerText = "บันทึกการแก้ไขข้อมูล";
                
                if(res === "SUCCESS") {
                    Swal.fire({ icon: 'success', title: 'แก้ไขสำเร็จ', timer: 2000, showConfirmButton: false });
                    bootstrap.Modal.getInstance(document.getElementById('modal-add-job')).hide();
                    refreshAllData(() => { setupQueue(); }); 
                } else {
                    Swal.fire("เกิดข้อผิดพลาด", res, "error");
                }
              }, null);
                    refreshAllData(() => { setupQueue(); }); 
                } else {
                    Swal.fire("เกิดข้อผิดพลาด", res, "error");
                }
              })
              .withFailureHandler(err => {
                  btn.disabled = false;
                  btn.innerText = "บันทึกการแก้ไขข้อมูล";
                  Swal.fire("Error", err.message, "error");
              })
              .updateJobData(fd); // ส่ง Object ไปที่ Server
        }

        function refreshAllData(callback) {
            callGAS('getInitialData', [], data => {
                ALL_DATA = data; // อัปเดตข้อมูลในหน่วยความจำใหม่ทั้งหมด
                if (callback) callback(); // ทำงานต่อตามที่สั่ง (เช่น วาดหน้า Queue ใหม่)
            }, null);
        }

        function confirmDeleteJob(id, status) {
            // ป้องกันการลบงานที่กำลังทำงานอยู่
            if (status === "Running") {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถลบได้',
                    text: 'งานนี้กำลัง Running อยู่ โปรดกด PAUSE ก่อนทำการลบ',
                    confirmButtonColor: '#ef4444'
                });
                return;
            }

            Swal.fire({
                title: 'ยืนยันการลบแผนผลิต?',
                text: `คุณกำลังจะลบงาน ${id} ออกจากระบบอย่างถาวร (ไม่สามารถเรียกคืนได้)`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [res => {
                        hideLoading(], null, null);
                        if (res === "SUCCESS") {
                            Swal.fire({
                                icon: 'success',
                                title: 'ลบแผนงานสำเร็จ',
                                timer: 1000,
                                showConfirmButton: false
                            });
                            // รีเฟรชข้อมูลล่าสุดและวาดหน้า Queue ใหม่
                            refreshAllData(() => { setupQueue(); });
                        } else {
                            Swal.fire("เกิดข้อผิดพลาด", res, "error");
                        }
                    }).removeJob(id); // เรียกฟังก์ชันฝั่ง Server
                }
            });
        }

        function showDashboardLogDetail(index) {
            const log = DASHBOARD_LOGS[index];
            if (!log) return;
            
            const body = document.getElementById('detail-body');
            
            // 1. สร้างตาราง QC พร้อมระบบตรวจสอบสี (Red/Blue)
            const positions = [
                {k:'H', l:'ต้นม้วน (H)'}, {k:'HM', l:'30m แรก (HM)'}, 
                {k:'M', l:'กลางม้วน (M)'}, {k:'MT', l:'30m ท้าย (MT)'}, {k:'T', l:'ท้ายม้วน (T)'}
            ];
            
            let qcHtml = '<div class="table-responsive rounded-4 border bg-white mb-3 shadow-sm">' +
                        '<table class="table table-sm text-center mb-0 align-middle" style="font-size: 0.85rem;">' +
                        '<thead class="table-dark"><tr><th>ตำแหน่ง</th><th>จุดที่ 1</th><th>จุดที่ 2</th><th>จุดที่ 3</th></tr></thead><tbody>';
            
            positions.forEach(p => {
                qcHtml += '<tr><td class="fw-bold bg-light text-start ps-3">' + p.l + '</td>';
                
                // วนลูปเช็คความหนาทั้ง 3 จุดในแต่ละตำแหน่ง
                log.qc[p.k].forEach(v => {
                    // เรียกใช้ getSpecClass เพื่อหาว่าควรเป็นสีแดง (qc-low) หรือน้ำเงิน (qc-high)
                    const cls = getSpecClass(v, log.min, log.max);
                    const valDisp = parseFloat(v) > 0 ? parseFloat(v).toFixed(2) : '-';
                    
                    qcHtml += `<td class="${cls}">${valDisp}</td>`;
                });
                qcHtml += '</tr>';
            });
            qcHtml += '</tbody></table></div>';

            // 2. จัดการรูปภาพ (ถ้ามี)
            let imgHtml = "";
            if (log.img && log.img.trim() !== "") {
                const urls = log.img.split(',');
                imgHtml = '<div class="mt-3"><h6 class="fw-bold text-muted small mb-2"><i class="fa-solid fa-image me-1"></i> รูปถ่ายหน้างาน</h6><div class="d-flex flex-wrap gap-2">';
                urls.forEach(url => {
                    const fId = getDriveId(url.trim());
                    const thumb = fId ? 'https://lh3.googleusercontent.com/u/0/d/' + fId + '=w400-h400-p-k-no-iv1' : '';
                    imgHtml += `<a href="${url.trim()}" target="_blank" class="text-decoration-none">
                                    <img src="${thumb}" class="img-thumbnail shadow-sm rounded-3" 
                                        style="width:100px; height:100px; object-fit:cover; border: 2px solid #fff;"
                                        onerror="this.src='https://via.placeholder.com/100?text=No+Image'">
                                </a>`;
                });
                imgHtml += '</div></div>';
            }

            // 3. ประกอบเนื้อหาลง Modal (ส่วน UI สรุป)
            body.innerHTML = `
                <div class="row g-3 mb-4">
                    <div class="col-md-7">
                        <div class="card border-0 shadow-sm rounded-4 h-100">
                            <div class="card-body">
                                <h6 class="text-muted small fw-bold text-uppercase border-bottom pb-2 mb-3">Traceability Data</h6>
                                <div class="row g-3">
                                    <div class="col-6"><label class="small text-muted d-block">JOB ID</label><strong class="text-primary fs-5">${log.job}</strong></div>
                                    <div class="col-6 text-end"><label class="small text-muted d-block">น้ำหนัก (kg)</label><strong class="fs-5">${log.weight.toLocaleString()}</strong></div>
                                    <div class="col-4"><label class="small text-muted d-block">COIL NO.</label><strong class="text-dark">${log.coil}</strong></div>
                                    <div class="col-4"><label class="small text-muted d-block">MILL</label><strong class="text-dark">${log.millNo}</strong></div>
                                    <div class="col-4"><label class="small text-muted d-block">MACHINE</label><strong class="text-dark">${log.machine}</strong></div>
                                    <div class="col-4"><label class="small text-muted d-block">TMT NO.</label><span class="badge bg-light text-dark border w-100">${log.tmtNo}</span></div>
                                    <div class="col-4"><label class="small text-muted d-block">HEAT NO.</label><span class="badge bg-light text-dark border w-100">${log.heatNo}</span></div>
                                    <div class="col-4"><label class="small text-muted d-block">M-COIL</label><span class="badge bg-light text-dark border w-100">${log.mCoil}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                      <div class="col-md-5">
                          <div class="card border-0 shadow-sm rounded-4 h-100 bg-white">
                              <div class="card-body">
                                  <h6 class="text-muted small fw-bold text-uppercase border-bottom pb-2 mb-3">เกณฑ์คุณภาพ (Spec)</h6>
                                  
                                  <!-- จุดที่แก้ไข: เปลี่ยนเป็น justify-content-center และเพิ่ม gap-3 เพื่อให้เว้นระยะกึ่งกลางเท่ากัน -->
                                  <div class="d-flex justify-content-center align-items-center p-3 bg-light rounded-3 mb-2 text-center gap-3">
                                      
                                      <!-- MIN -->
                                      <div style="min-width: 60px;">
                                          <small class="text-muted d-block" style="font-size: 10px;">MIN</small>
                                          <strong class="text-danger fs-5">${log.min.toFixed(2)}</strong>
                                      </div>

                                      <div class="text-muted opacity-50">↔</div>

                                      <!-- TARGET (กึ่งกลาง) -->
                                      <div class="px-3 border-start border-end">
                                          <small class="text-muted d-block" style="font-size: 10px;">TARGET</small>
                                          <strong class="text-dark fs-3">${log.target.toFixed(2)}</strong>
                                          <div class="fw-bold" style="font-size: 9px; color: #64748b;">mm</div>
                                      </div>

                                      <div class="text-muted opacity-50">↔</div>

                                      <!-- MAX -->
                                      <div style="min-width: 60px;">
                                          <small class="text-muted d-block" style="font-size: 10px;">MAX</small>
                                          <strong class="text-primary fs-5">${log.max.toFixed(2)}</strong>
                                      </div>

                                  </div>
                                  
                                  <div class="small text-muted mt-3">
                                      <i class="fa-solid fa-clock me-1"></i> บันทึกเมื่อ: ${log.time}
                                  </div>
                              </div>
                          </div>
                      </div>
                </div>
                <h6 class="fw-bold text-muted small text-uppercase mb-2"><i class="fa-solid fa-microscope me-1"></i> ตรวจสอบความหนา</h6>
                ${qcHtml}
                <div class="p-3 bg-white border rounded-3 mb-3 small shadow-sm">
                    <span class="fw-bold text-muted">หมายเหตุ:</span> ${log.note !== "-" ? log.note : 'ไม่มีบันทึกเพิ่มเติม'}
                </div>
                ${imgHtml}
            `;
            
            new bootstrap.Modal(document.getElementById('modal-log-detail')).show();
        }  

        // ฟังก์ชันเมื่อเลื่อนสไลเดอร์
        function updateSlice(index, value) {
            const canvasId = '3d-canvas-' + index;
            const getV = window['func_' + canvasId];
            if (typeof getV !== 'function') return;

            const v = parseFloat(value);
            const totalLen = window['len_' + canvasId] || 0;
            
            // 1. อัปเดตเมตรที่แสดงผล
            const meterEl = document.getElementById('slice-val-' + index);
            if(meterEl) meterEl.innerText = (totalLen * v).toFixed(1);

            // 2. อัปเดตค่า L-C-R รายเส้น (DNA Live Scan)
            const slits = window['slits_' + canvasId];
            if (slits) {
                slits.forEach((slit, sIdx) => {
                    // สแกนความหนา ณ เมตรปัจจุบัน (v) ตามตำแหน่งหน้ากว้างของสลิทเส้นนั้น
                    const valL = getV(slit.start, v);
                    const valC = getV(slit.center, v);
                    const valR = getV(slit.end, v);
                    
                    const elL = document.getElementById(`slit-${index}-${sIdx}-L`);
                    const elC = document.getElementById(`slit-${index}-${sIdx}-C`);
                    const elR = document.getElementById(`slit-${index}-${sIdx}-R`);
                    
                    if(elL) elL.innerText = valL.toFixed(3);
                    if(elC) elC.innerText = valC.toFixed(3);
                    if(elR) elR.innerText = valR.toFixed(3);
                });
            }

            // 3. อัปเดตการวิเคราะห์รูปทรง (Crown)
            const p1 = getV(0, v), p2 = getV(0.5, v), p3 = getV(1, v);
            const crown = p2 - ((p1 + p3) / 2);
            const flatText = document.getElementById('flat-text-' + index);
            if (flatText) {
                const absC = Math.abs(crown);
                let shape = "เรียบ (Flat)", color = "#10b981";
                if(crown > 0.008) { shape = "นูน (Crown)"; color = absC > 0.035 ? "#ef4444" : "#f59e0b"; }
                else if(crown < -0.008) { shape = "แอ่น (Buckle)"; color = absC > 0.035 ? "#ef4444" : "#f59e0b"; }
                flatText.innerText = shape; 
                flatText.style.color = color;
            }

            // อัปเดต Crown value display ใน flat-box
            const crownEl = document.getElementById('crown-display-' + index);
            if (crownEl) crownEl.innerText = 'Crown: ' + crown.toFixed(3);

            window['slice_' + canvasId] = v;
            draw3DCoilProfile(ALL_LOGS_DATA[index] || {}, canvasId);
            draw2DSliceProfile(index, v);
        }
        // ตัวแปรส่วนกลางสำหรับเก็บสถานะมุมหมุนของแต่ละม้วน
        window.coilStates = window.coilStates || {};
        window.cameraControllers = window.cameraControllers || {};

        function draw3DCoilProfile(l, canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;

            // --- 1. เตรียมข้อมูลพื้นฐาน ---
            const rawThk = [l.tH1, l.tH2, l.tH3, l.tHM1, l.tHM2, l.tHM3, l.tM1, l.tM2, l.tM3, l.tMT1, l.tMT2, l.tMT3, l.tT1, l.tT2, l.tT3];
            const numericThk = rawThk.map(v => parseFloat(v)).filter(v => !isNaN(v) && v > 0);
            const weight = parseFloat(l.weight) || 0;
            const avgThkMM = numericThk.length > 0 ? (numericThk.reduce((a, b) => a + b, 0) / numericThk.length) : 0;
            const avgWidthMM = [l.wH, l.wHM, l.wM, l.wMT, l.wT].map(parseFloat).filter(v => v > 0).reduce((a, b) => a + b, 0) / 5 || 1219;

            const srcData = [[l.tH1, l.tH2, l.tH3], [l.tHM1, l.tHM2, l.tHM3], [l.tM1, l.tM2, l.tM3], [l.tMT1, l.tMT2, l.tMT3], [l.tT1, l.tT2, l.tT3]]
                .map(row => row.map(v => parseFloat(v) || (numericThk[0] || 0)));

            if (avgThkMM === 0 || weight === 0) return;

            // ✅ ความยาวม้วนลูก = ความยาวม้วนแม่ (ม้วนลูกยาวเท่าแม่เสมอ)
            // ถ้ามี parentWeight และ parentWidth → คำนวณจากแม่
            // ถ้าไม่มี → fallback คำนวณจากข้อมูลของตัวเอง (เดิม)
            const parentWeight = parseFloat(l.parentWeight) || 0;
            const parentWidth  = parseFloat(l.parentWidth)  || 0;
            let totalLengthM;
            if (parentWeight > 0 && parentWidth > 0 && avgThkMM > 0) {
              // คำนวณจากม้วนแม่: ความยาวแม่ = weightแม่ / (density × thkแม่ × widthแม่)
              // ใช้ avgThkMM (วัดจริง) และ parentWidth (หน้ากว้างแม่จริง)
              totalLengthM = parentWeight / (7850 * (avgThkMM / 1000) * (parentWidth / 1000));
            } else {
              // fallback: คำนวณจากข้อมูลม้วนนี้เอง
              totalLengthM = weight / (7850 * (avgThkMM / 1000) * (avgWidthMM / 1000));
            }
            window['len_' + canvasId] = totalLengthM;

            const srcZ = [0, 30/totalLengthM, 0.5, (totalLengthM-30)/totalLengthM, 1.0];
            const getVal = (u, v) => {
                let vi = 0; while (vi < 3 && v > srcZ[vi+1]) vi++;
                if (v >= 1.0) vi = 3; // Force tail index
                let v_f = (v - srcZ[vi]) / ((srcZ[vi+1] || 1.0) - srcZ[vi]);
                let ui = 0; while (ui < 1 && u > 0.5) ui++;
                let u_f = (u - (ui * 0.5)) / 0.5;
                const p00 = srcData[vi][ui], p10 = srcData[vi+1][ui], p01 = srcData[vi][ui+1], p11 = srcData[vi+1][ui+1];
                return (p00 + u_f * (p01 - p00)) + v_f * ((p10 + u_f * (p11 - p10)) - (p00 + u_f * (p01 - p00)));
            };
            window['func_' + canvasId] = getVal;

            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

            if (!window.coilStates[canvasId]) { window.coilStates[canvasId] = { rotX: -0.4, rotY: 0.3 }; }
            const state = window.coilStates[canvasId];

            function render() {
                const w = rect.width, h = rect.height;
                ctx.clearRect(0, 0, w, h);
                const minV = Math.min(...numericThk), maxV = Math.max(...numericThk);

                const project = (u, v, val, isBottom = false) => {
                    let x3d = (u - 0.5) * (w * 0.45), z3d = (v - 0.5) * (h * 0.95);
                    let crown = getVal(0.5, v) - ((getVal(0, v) + getVal(1, v)) / 2);
                    let wave = isBottom ? 0 : getWaviness(u, v, crown, totalLengthM);
                    let yScale = 35; let y3d = isBottom ? -12 : ((val - minV) * yScale) + wave;
                    let cosY = Math.cos(state.rotY), sinY = Math.sin(state.rotY);
                    let xR = x3d * cosY - z3d * sinY, zR = x3d * sinY + z3d * cosY;
                    let cosX = Math.cos(state.rotX), sinX = Math.sin(state.rotX);
                    return { x: xR + (w / 2), y: -(y3d * cosX - zR * sinX) + (h / 2) + 10 };
                };

                const getColor = (u, v, thkVal) => {
                    if (window.CURRENT_MAP_MODE === 'DEV') {
                        const jobInfo = ALL_DATA.jobs.find(j => j.jobId === l.jobId);
                        const target = jobInfo ? parseFloat(jobInfo.thickness) : avgThkMM;
                        const minS = l.min || target - 0.05, maxS = l.max || target + 0.05;
                        if (thkVal < minS) return `red`; if (thkVal > maxS) return `blue`;
                        return `#eee`;
                    }
                    let hue = ((thkVal - minV) / ((maxV - minV) || 0.001)) * 240;
                    let baseLightness = 55;
                    if (window.CURRENT_MAP_MODE === 'HEAT') {
                        const t1 = getVal(0, v), t2 = getVal(0.5, v), t3 = getVal(1, v);
                        const crown = t2 - ((t1 + t3) / 2);
                        const crownNorm = Math.max(-1, Math.min(1, crown / 0.05));
                        if (crownNorm > 0) {
                            hue = hue * (1 - crownNorm * 0.7);
                            baseLightness = 55 + crownNorm * 15;
                        } else {
                            hue = hue + Math.abs(crownNorm) * (220 - hue);
                            baseLightness = 55 - Math.abs(crownNorm) * 15;
                        }
                    }
                    return `hsla(${hue}, 90%, ${baseLightness}%, 1)`;
                };

                // 1. วาดท้องเหล็ก
                ctx.beginPath();
                const b = [project(0,0,0,true), project(1,0,0,true), project(1,1,0,true), project(0,1,0,true)];
                ctx.moveTo(b[0].x, b[0].y); ctx.lineTo(b[1].x, b[1].y); ctx.lineTo(b[2].x, b[2].y); ctx.lineTo(b[3].x, b[3].y);
                ctx.fillStyle="#000"; ctx.fill();

                // 2. วาดผิวหน้าแผ่นเหล็ก + ป้ายเมตร
                const vStep = 0.1;
                for (let v = 0; v <= 1.0; v += vStep) {
                    const vNext = Math.min(1.0, v + vStep);
                    for (let u = 0; u < 1; u += 0.25) {
                        const p1=project(u,v,getVal(u,v)), p2=project(u+0.25,v,getVal(u+0.25,v)), p3=project(u+0.25,vNext,getVal(u+0.25,vNext)), p4=project(u,vNext,getVal(u,vNext));
                        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y);
                        ctx.fillStyle = getColor(u, v, getVal(u, v)); ctx.fill();
                        ctx.strokeStyle = "rgba(255,255,255,0.05)"; ctx.stroke();
                    }
                    // ป้ายบอกเมตรที่ขอบ
                    ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.font = "9px Arial";
                    const mLabelPos = project(1.05, v, getVal(1, v));
                    ctx.fillText((v * totalLengthM).toFixed(0) + "m", mLabelPos.x, mLabelPos.y);
                }

                // 3. วาดเส้นรอยซอย (Slitting Lines)
                const slits = window['slits_' + canvasId];
                if (slits && slits.length > 0) {
                    ctx.setLineDash([8, 4]); ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)'; ctx.lineWidth = 1.5;
                    slits.forEach(slit => {
                        ctx.beginPath();
                        for (let v = 0; v <= 1.0; v += 0.05) {
                            let p = project(slit.end, v, getVal(slit.end, v));
                            if (v === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                        }
                        ctx.stroke();
                        let labelP = project(slit.start + (slit.end - slit.start)/2, 0, getVal(slit.start, 0));
                        ctx.fillStyle = "cyan"; ctx.font = "bold 9px Arial"; ctx.textAlign="center";
                        ctx.fillText("#" + slit.no, labelP.x, labelP.y - 15);
                    });
                    ctx.setLineDash([]); ctx.textAlign="left";
                }

                // 4. เส้นเลเซอร์สีเขียว
                const curV = window['slice_' + canvasId] || 0;
                const s1=project(0,curV,getVal(0,curV)), s2=project(1,curV,getVal(1,curV));
                ctx.beginPath(); ctx.moveTo(s1.x, s1.y); ctx.lineTo(s2.x, s2.y);
                ctx.strokeStyle = '#22c55e'; ctx.lineWidth = 3; ctx.stroke();

                // 5. ป้าย HEAD / TAIL
                ctx.fillStyle = "white"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
                const hPos = project(0.5, 0, 0, true);
                const tPos = project(0.5, 1, 0, true);
                ctx.fillText("--- HEAD ---", hPos.x, hPos.y + 45);
                ctx.fillText(`--- TAIL (${totalLengthM.toFixed(0)}m) ---`, tPos.x, tPos.y + 45);
                ctx.textAlign = "left";
            }
            render();

            // expose render สำหรับ animation loop
            if (window.coilStates && window.coilStates[canvasId]) {
                window.coilStates[canvasId]._triggerRender = render;
            }

            // Interaction Setup
            if (!canvas.dataset.eventLinked) {
                let isDragging = false, lx, ly;
                canvas.onmousedown = (e) => { isDragging = true; lx = e.pageX; ly = e.pageY; };
                canvas.ontouchstart = (e) => { isDragging = true; lx = e.touches[0].pageX; ly = e.touches[0].pageY; };
                window.addEventListener('mousemove', (e) => { if (!isDragging) return; state.rotY += (e.pageX - lx) * 0.01; state.rotX += (e.pageY - ly) * 0.01; lx = e.pageX; ly = e.pageY; render(); });
                window.addEventListener('mouseup', () => isDragging = false);
                window.addEventListener('touchmove', (e) => { if (!isDragging) return; state.rotY += (e.touches[0].pageX - lx) * 0.01; state.rotX += (e.touches[0].pageY - ly) * 0.01; lx = e.touches[0].pageX; ly = e.touches[0].pageY; render(); if(e.cancelable) e.preventDefault(); }, {passive: false});
                window.addEventListener('touchend', () => isDragging = false);
                canvas.dataset.eventLinked = "true";
            }
        }

        function load3DSpecific(index) {
            const log = ALL_LOGS_DATA[index];
            const canvasId = `3d-canvas-${index}`;
            const canvas = document.getElementById(canvasId);
            
            // ตรวจสอบความพร้อมของ Element ก่อนสั่งงาน
            if (!canvas) return; 

            const btn = document.getElementById(`btn-load-3d-${index}`);
            const sliceCtrl = document.getElementById(`slice-ctrl-${index}`);
            const slitCtrl = document.getElementById(`slitting-ctrl-${index}`);
            const legend = document.getElementById(`3d-legend-${index}`);
            const flatBox = document.getElementById(`flat-box-${index}`);

            if (btn) btn.style.display = 'none';
            canvas.style.display = 'block';
            
            if (sliceCtrl) sliceCtrl.style.display = 'block';
            if (slitCtrl) slitCtrl.style.display = 'block';
            if (legend) legend.style.display = 'flex';
            if (flatBox) flatBox.style.display = 'block';

            updateLegendDisplay(index, log);
            draw3DCoilProfile(log, canvasId);
            initInteractiveWorkbench(index);
            if (log.slitPlan) {
                    setTimeout(() => {
                        applySlitting(index, log.slitPlan);
                        // แสดงปุ่มบันทึกม้วนลูก
                        const confirmArea = document.getElementById(`slit-confirm-area-${index}`);
                        if(confirmArea) confirmArea.style.display = 'block';
                    }, 150);
                }

                setTimeout(() => { updateSlice(index, 0); }, 60);

            initInteractiveWorkbench(index);

            }

        function draw2DSliceProfile(index, v) {
            const canvas = document.getElementById('slice-canvas-' + index);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const canvas3dId = '3d-canvas-' + index;
            const getV = window['func_' + canvas3dId];
            if (typeof getV !== 'function') return;

            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            const w = rect.width, h = rect.height;

            const p1 = getV(0, v), p2 = getV(0.5, v), p3 = getV(1, v);
            const crown = p2 - ((p1 + p3) / 2);

            ctx.clearRect(0, 0, w, h);
            const minVal = Math.min(p1, p2, p3);
            const getY = (val) => h - 35 - ((val - minVal) * 180);

            // วาดเหล็ก
            ctx.beginPath();
            ctx.moveTo(40, h - 20); ctx.lineTo(w - 40, h - 20); 
            ctx.lineTo(w - 40, getY(p3));
            ctx.quadraticCurveTo(w / 2, getY(p2) - 5, 40, getY(p1));
            ctx.closePath();
            ctx.fillStyle = crown >= 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
            ctx.fill();
            ctx.strokeStyle = crown >= 0 ? '#16a34a' : '#dc2626';
            ctx.lineWidth = 2; ctx.stroke();

            // วาดจุด T1, T2, T3 และตัวเลข
            const points = [{ x: 40, y: getY(p1), val: p1, label: 'T1' }, { x: w / 2, y: getY(p2), val: p2, label: 'T2' }, { x: w - 40, y: getY(p3), val: p3, label: 'T3' }];
            points.forEach(pt => {
                ctx.fillStyle = '#1e293b'; ctx.beginPath(); ctx.arc(pt.x, pt.y, 3, 0, Math.PI * 2); ctx.fill();
                ctx.save(); ctx.textAlign = 'center'; ctx.font = 'bold 9px sans-serif'; ctx.fillStyle = '#64748b';
                ctx.fillText(pt.label, pt.x, pt.y - 25); ctx.font = 'bold 11px sans-serif';
                ctx.fillText(pt.val.toFixed(2), pt.x, pt.y - 10); ctx.restore();
            });

            // --- [จุดแก้ไข] วาดเส้นรอยตัดสีแดงลงใน Canvas ---
            const knives = ACTIVE_KNIVES[index] || [];
            knives.forEach(kRatio => {
                const xPos = 40 + (kRatio * (w - 80)); // 40 คือ padding ซ้าย-ขวา
                ctx.beginPath();
                ctx.setLineDash([4, 2]);
                ctx.strokeStyle = '#ef4444'; // เส้นแดงใบมีด
                ctx.lineWidth = 2;
                ctx.moveTo(xPos, 10);
                ctx.lineTo(xPos, h - 10);
                ctx.stroke();
                ctx.setLineDash([]);
            });

            // เส้นประฐาน
            ctx.setLineDash([2, 2]); ctx.strokeStyle = '#cbd5e1';
            ctx.beginPath(); ctx.moveTo(40, h - 20); ctx.lineTo(w - 40, h - 20); ctx.stroke();
            ctx.setLineDash([]);
        }
        // ฟังก์ชันคำนวณการตัด
        function applySlitting(index, value) {
            let log;
            if (index === 'current') {
                const f = document.getElementById('record-form');
                log = {
                    jobId: document.getElementById('input-job-id').value,
                    wM: parseFloat(f.elements['widthM'].value) || 1225
                };
            } else {
                log = ALL_LOGS_DATA[index];
            }

            if (!log) return;

            const canvasId = (index === 'current') ? 'profileCanvas' : '3d-canvas-' + index;
            const totalWidth = parseFloat(log.wM) || 1225;
            const getV = window['func_' + canvasId];
            const statsContainer = document.getElementById('slit-stats-' + index);

            if (!value || value.trim() === "") {
                window['slits_' + canvasId] = null;
                if(statsContainer) statsContainer.innerHTML = "";
                return;
            }

            const slitWidths = value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
            let currentPos = 0;
            let html = "";

            const slits = slitWidths.map((w, slitIdx) => {
                const startR = currentPos / totalWidth;
                const endR = (currentPos + w) / totalWidth;
                const midR = (startR + endR) / 2;

                // สร้าง Badge แบบมี Grid L-C-R
                html += `
                    <div class="slit-badge-live">
                        <div class="d-flex justify-content-between border-bottom border-secondary mb-1 pb-1">
                            <span class="text-info fw-bold">#${slitIdx+1}</span>
                            <span class="text-white small">${w}mm</span>
                        </div>
                        <div class="slit-val-grid">
                            <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:8px;">L</span><span id="slit-${index}-${slitIdx}-L" class="slit-val-live">-.---</span></div>
                            <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:8px;">C</span><span id="slit-${index}-${slitIdx}-C" class="slit-val-live" style="color:#06b6d4;">-.---</span></div>
                            <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:8px;">R</span><span id="slit-${index}-${slitIdx}-R" class="slit-val-live">-.---</span></div>
                        </div>
                    </div>`;

                currentPos += w;
                return { no: slitIdx + 1, w: w, start: startR, center: midR, end: endR };
            });

            window['slits_' + canvasId] = slits;
            if(statsContainer) {
                statsContainer.innerHTML = html;
                // บังคับให้อัปเดตตัวเลขทันทีที่สร้างเสร็จ
                updateSlice(index, (index === 'current' ? 0 : document.getElementById('slider-' + index).value));
            }

            if (index !== 'current') draw3DCoilProfile(log, canvasId);
        }
        // --- 1. เพิ่มฟังก์ชันคณิตศาสตร์คำนวณลอนคลื่น (Waviness) ---
        function getWaviness(u, v, crown, totalLen) {
            if (Math.abs(crown) < 0.01) return 0; // เรียบปกติ

            const freq = 15; // จำนวนลูกคลื่น
            const ampScale = 120; // ความสูงของลอน (ปรับความชัดเจน)
            let wave = 0;

            if (crown > 0.02) { 
                // Edge Wave: ขอบย้วย (นูนกลาง) -> ยิ่งไกลจากกลาง (u=0.5) ยิ่งย้วย
                const edgeEffect = Math.pow(Math.abs(u - 0.5) * 2, 4); 
                wave = Math.sin(v * totalLen * freq) * (crown * ampScale) * edgeEffect;
            } else if (crown < -0.01) { 
                // Center Buckle: กลางย้วย (บางกลาง) -> ยิ่งใกล้กลาง ยิ่งย้วย
                const centerEffect = 1 - Math.pow(Math.abs(u - 0.5) * 2, 2);
                wave = Math.sin(v * totalLen * freq) * (Math.abs(crown) * ampScale) * centerEffect;
            }
            return wave;
        }

        function confirmSlitIdentity(index) {
            const log = ALL_LOGS_DATA[index];
            const canvasId = '3d-canvas-' + index;
            const slits = window['slits_' + canvasId];
            const getV = window['func_' + canvasId];

            if (!slits || slits.length === 0 || !getV) {
                Swal.fire("ไม่พบข้อมูล", "กรุณาระบุขนาดซอยและกด 'ตัด' ก่อน", "warning");
                return;
            }

            const parentWeight = parseFloat(log.weight) || 0;
            const parentWidth = parseFloat(log.wM) || 1225; // อ้างอิงหน้ากว้างจริงจาก Log

            const slitPayload = slits.map((slit, sIdx) => {
                // คำนวณน้ำหนักตามสัดส่วน (แก้ NaN โดยใช้ค่า w ที่เพิ่มเข้าไป)
                const currentWidth = parseFloat(slit.w) || 0;
                const slitWeight = parentWidth > 0 ? Math.round((currentWidth / parentWidth) * parentWeight) : 0;
                
                // สแกนความหนา DNA 3 จุดตลอดความยาว
                let sumL = 0, sumC = 0, sumR = 0, count = 0;
                for (let v = 0; v <= 1.0; v += 0.05) { 
                    sumL += getV(slit.start, v);
                    sumC += getV(slit.center, v);
                    sumR += getV(slit.end, v);
                    count++;
                }

                const avgL = (sumL / count).toFixed(3);
                const avgC = (sumC / count).toFixed(3);
                const avgR = (sumR / count).toFixed(3);

                // วิเคราะห์เกรด (เทียบกับ Target ของ Job)
                const target = parseFloat(log.thickness) || parseFloat(avgC);
                const grade = Math.abs(avgC - target) <= 0.035 ? "A" : "B";

                return {
                    slitId: String(log.jobId).trim() + "-S" + (sIdx + 1),
                    parentId: log.jobId,
                    no: sIdx + 1,
                    width: currentWidth,
                    weight: slitWeight,
                    thkL: avgL,
                    thkC: avgC,
                    thkR: avgR,
                    grade: grade,
                    position: sIdx === 0 ? "Left" : (sIdx === slits.length - 1 ? "Right" : "Center")
                };
            });

            // สร้างข้อความสรุปรายการที่จะบันทึก
            const summaryHtml = slitPayload.map(s => 
                `<div class="d-flex justify-content-between border-bottom py-1">
                    <span><b>#${s.no}</b>: ${s.width}mm</span>
                    <span class="text-primary fw-bold">${Number(s.weight).toLocaleString()} kg</span>
                </div>`
            ).join('');

            Swal.fire({
                title: 'ยืนยันสร้างอัตลักษณ์?',
                html: `<div class="text-start small mt-2">
                        <div class="mb-2 text-muted">ม้วนแม่: <b>${log.jobId}</b></div>
                        ${summaryHtml}
                      </div>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4361ee',
                confirmButtonText: 'บันทึก Identity',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [res => {
                        hideLoading(], null, null);
                        if(res === "SUCCESS") {
                            Swal.fire('สำเร็จ!', 'บันทึกม้วนลูกเข้าคลังเรียบร้อยแล้ว', 'success');
                        } else {
                            Swal.fire('Error', res, 'error');
                        }
                    }).saveSlitIdentity(slitPayload);
                }
            });
        }

        // ============================================================
        // Slit Plan — Job_Master Integration
        // ============================================================

        // โหลดแผนจาก Job_Master และแสดง UI
        function loadSlitPlanFromJobMaster(isEdit) {
            if (!CURRENT_JOB_INFO) return;
            const f = document.getElementById('record-form');

            // Mill No. — โหลดทั้ง new และ edit (ถ้า edit จะถูก editLogByIndex ทับทีหลังอยู่แล้ว)
            const sw = Number(CURRENT_JOB_INFO.stripWidth || 0);
            const swInput = document.getElementById('record-strip-width');
            const swHint  = document.getElementById('record-strip-width-hint');
            if (swInput) swInput.value = sw > 0 ? sw : '';
            if (swHint)  swHint.innerText = sw > 0 ? `(จากแผน: ${sw} mm)` : '';

            // Slit Plan — โหลดเฉพาะม้วนใหม่เท่านั้น
            if (!isEdit) {
                const slitInput = document.getElementById('input-slit-plan');
                const masterPlan = String(CURRENT_JOB_INFO.slitPlan || '').replace(/^'/, '').replace(/\[.*?\]/g, '').trim();
                const stripWidth = Number(CURRENT_JOB_INFO.stripWidth || 0);

                if (masterPlan) {
                    // clear rows เดิม
                    document.getElementById('record-slit-rows').innerHTML = '';
                    recordSlitCount = 0;
                    // parse แต่ละเส้นแล้วสร้าง row
                    masterPlan.split(',').forEach(item => {
                        const wm = item.match(/^([0-9.]+)/);
                        const nm = item.match(/\[(.*?)\]/);
                        if (wm) addRecordSlitRow(wm[1], nm ? nm[1] : '');
                    });
          
                    if (stripWidth > 0) {
                        calculatePrePlanWithWidth(masterPlan, stripWidth);
                    } else {
                        const btnSave = document.getElementById('btn-save');
                        if (btnSave) btnSave.disabled = false;
                    }
                }
            }
        }

        // ปุ่ม "ใช้แผนนี้" — รีเซ็ตกลับไปใช้แผน Job_Master
        function applyJobMasterSlitPlan() {
            if (!CURRENT_JOB_INFO?.slitPlan) return;
            const masterPlan = String(CURRENT_JOB_INFO.slitPlan).replace(/^'/, '').trim();
            const slitInput  = document.getElementById('input-slit-plan');
            if (slitInput) {
                slitInput.value = masterPlan;
                calculatePrePlan(masterPlan);
                syncKeyInputToCanvas('current', masterPlan);
                onSlitPlanInput();
            }
        }

        // ล้างช่อง slit plan
        function clearSlitPlanInput() {
            const slitInput = document.getElementById('input-slit-plan');
            if (slitInput) slitInput.value = '';
            calculatePrePlan('');
            syncKeyInputToCanvas('current', '');
            onSlitPlanInput();
        }

        // เรียกทุกครั้งที่ user พิมพ์ใน slit plan input
        // แสดง/ซ่อนปุ่ม "ใช้แผนนี้" ตาม state
        function onSlitPlanInput() {
            const jobBar    = document.getElementById('slit-plan-from-job');
            const slitInput = document.getElementById('input-slit-plan');
            if (!CURRENT_JOB_INFO?.slitPlan || !jobBar) return;
            const masterPlan = String(CURRENT_JOB_INFO.slitPlan).replace(/^'/, '').trim();
            const current    = (slitInput?.value || '').trim();
            // ถ้าค่าต่างจากแผน Job_Master ให้แสดงปุ่มรีเซ็ต; ถ้าเหมือนกันซ่อน
            const btn = jobBar.querySelector('button');
            if (btn) btn.style.display = (current !== masterPlan) ? 'inline-block' : 'none';
        }

        function calculatePrePlanWithWidth(value, totalWidth) {
            const countEl = document.getElementById('preplan-count');
            const scrapEl = document.getElementById('preplan-scrap');
            if (!value || !value.trim()) {
                countEl.innerText = "0 เส้น"; scrapEl.innerText = "Scrap: - mm";
                return;
            }
            const slitWidths = value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
            const sumSlits = slitWidths.reduce((a, b) => a + b, 0);
            const scrap = totalWidth - sumSlits;
            countEl.innerText = `${slitWidths.length} เส้น`;
            scrapEl.innerText = `Scrap: ${scrap.toFixed(1)} mm`;
            if (scrap < 0) {
                scrapEl.className = "badge bg-danger text-white border-0";
                document.getElementById('btn-save').disabled = true;
            } else {
                scrapEl.className = "badge bg-success text-white border-0";
                document.getElementById('btn-save').disabled = false;
            }
        }

        function calculatePrePlan(value) {
            const countEl = document.getElementById('preplan-count');
            const scrapEl = document.getElementById('preplan-scrap');
            const f = document.getElementById('record-form');
            
            // ดึงหน้ากว้างจากช่องที่กรอกอยู่ (ถ้ายังไม่กรอกใช้ 1225)
            const totalWidth = parseFloat(f.widthM.value) || Number(CURRENT_JOB_INFO?.stripWidth || 0) || 1225;

            if (!value.trim()) {
                countEl.innerText = "0 เส้น"; scrapEl.innerText = "Scrap: - mm";
                return;
            }

            const slitWidths = value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
            const sumSlits = slitWidths.reduce((a, b) => a + b, 0);
            const scrap = totalWidth - sumSlits;

            countEl.innerText = `${slitWidths.length} เส้น`;
            // แก้ไข: ถ้า scrap ติดลบ ให้แสดงเลขจริงพร้อมสีแดง
            scrapEl.innerText = `Scrap: ${scrap.toFixed(1)} mm`;

            if (scrap < 0) {
                scrapEl.className = "badge bg-danger text-white border-0";
                // แจ้งเตือนพนักงาน
                document.getElementById('btn-save').disabled = true;
            } else {
                scrapEl.className = "badge bg-success text-white border-0";
                document.getElementById('btn-save').disabled = false;
            }
        }

        function initInteractiveWorkbench(index) {
            const canvas = document.getElementById(`slice-canvas-${index}`);
            const knifeContainer = document.getElementById(`knife-container-${index}`);
            const ruler = document.getElementById(`ruler-${index}`);
            if (!canvas) return;

            // 1. สร้างไม้บรรทัด (Scale) ให้ตรงจุด
            if(ruler) {
                ruler.innerHTML = "";
                const log = ALL_LOGS_DATA[index] || CURRENT_JOB_INFO;
                const totalW = parseFloat(log.wM) || 1225;
                for(let p=0; p<=100; p+=20) {
                    let label = document.createElement('div');
                    label.style.position = "absolute";
                    label.style.left = `calc(40px + ${p}% * (100% - 80px) / 100)`;
                    label.style.fontSize = "8px"; label.style.transform = "translateX(-50%)";
                    label.innerText = Math.round((p/100) * totalW);
                    ruler.appendChild(label);
                }
            }

            // 2. ระบบ Click-to-Cut / Click-to-Delete
            canvas.onclick = function(e) {
                // เช็คว่าถ้าไม่ใช่หน้าบันทึก (Operator) ให้ Simulate ได้อย่างเดียว
                const isOperator = document.getElementById('screen-running').classList.contains('active-screen');
                
                const rect = canvas.getBoundingClientRect();
                const xRatio = (e.clientX - rect.left - 40) / (rect.width - 80);

                if (xRatio < 0 || xRatio > 1) return; // คลิกนอกแผ่นเหล็กไม่นับ

                if(!ACTIVE_KNIVES[index]) ACTIVE_KNIVES[index] = [];
                
                // ค้นหาว่าจิ้มโดนเส้นเดิมไหม (ระยะ 4%)
                const existingIdx = ACTIVE_KNIVES[index].findIndex(k => Math.abs(k - xRatio) < 0.04);
                
                if (existingIdx !== -1) {
                    ACTIVE_KNIVES[index].splice(existingIdx, 1); // ลบเส้นเดิม
                } else {
                    ACTIVE_KNIVES[index].push(xRatio); // เพิ่มเส้นใหม่
                }
                
                ACTIVE_KNIVES[index].sort((a,b) => a-b);
                
                // อัปเดต UI ทันที
                draw2DSliceProfile(index, document.getElementById('slider-'+index)?.value || 0);
                syncCutsToLogic(index);
            };
        }

        function renderKnifeLines(index, container) {
            if(!container) return;
            container.innerHTML = (ACTIVE_KNIVES[index] || []).map(k => 
                `<div class="knife-indicator" style="left:${k*100}%"></div>`).join('');
        }

        function syncCutsToLogic(index) {
            const log = ALL_LOGS_DATA[index] || CURRENT_JOB_INFO;
            const totalW = parseFloat(log.wM) || 1225;
            let slitWidths = [];
            let lastX = 0;

            (ACTIVE_KNIVES[index] || []).forEach(k => {
                let currentX = k * totalW;
                let width = Math.round(currentX - lastX);
                if (width > 0) slitWidths.push(width); // ป้องกันค่าติดลบ
                lastX = currentX;
            });
            
            let remainingWidth = Math.round(totalW - lastX);
            if (remainingWidth > 0) slitWidths.push(remainingWidth);

            const slitString = slitWidths.join(',');
            
            // อัปเดตตัวเลขเข้าช่อง Input (ทั้งหน้าประวัติและหน้าบันทึก)
            const inputId = (index === 'current') ? 'input-slit-plan' : `slit-input-${index}`;
            const inputEl = document.getElementById(inputId);
            if(inputEl) inputEl.value = slitString;

            applySlitting(index, slitString); // วาด 3D และคำนวณ DNA
        }

        function commitSlitIdentities(index) {
            const log = ALL_LOGS_DATA[index];
            const canvasId = '3d-canvas-' + index;
            const getV = window['func_' + canvasId];
            const rawSlits = window['slits_' + canvasId]; 

            if(!rawSlits || rawSlits.length < 2) {
                Swal.fire("แจ้งเตือน", "กรุณาวางใบมีดบนหน้าตัดก่อนบันทึกครับ", "warning");
                return;
            }

            // ดึงค่า TMT No. มาทำรหัส (ถ้าไม่มีให้ใช้คำว่า NA)
            const tmtSuffix = (log.tmtNo && log.tmtNo !== "-") ? log.tmtNo : "NA";

            const finalPayload = rawSlits.map((s, sIdx) => {
                let sumL=0, sumC=0, sumR=0, count=0;
                for(let v=0; v<=1; v+=0.1) {
                    sumL += getV(s.start, v); sumC += getV(s.center, v); sumR += getV(s.end, v); count++;
                }
                
                // *** รหัสใหม่: JobID - TMTNo - S1 ***
                const uniqueSlitId = `${log.jobId}-${tmtSuffix}-S${sIdx + 1}`;

                return {
                    slitId: uniqueSlitId,
                    parentId: log.jobId,
                    width: s.w,
                    weight: Math.round((s.w / (parseFloat(log.wM)||1225)) * log.weight),
                    thkL: (sumL/count).toFixed(3),
                    thkC: (sumC/count).toFixed(3),
                    thkR: (sumR/count).toFixed(3),
                    grade: "A",
                    position: sIdx === 0 ? "Left" : (sIdx === rawSlits.length - 1 ? "Right" : "Center")
                };
            });

            Swal.fire({
                title: 'บันทึกม้วนย่อยเข้าสต็อก?',
                text: `ม้วนแม่ ${log.jobId} [TMT: ${tmtSuffix}] จะถูกบันทึกเป็นม้วนลูก ${finalPayload.length} เส้น`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ตกลง บันทึก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [res => {
                        hideLoading(], null, null);
                        if(res === "SUCCESS") {
                            Swal.fire('สำเร็จ', 'บันทึกอัตลักษณ์เรียบร้อยแล้ว', 'success');
                            load3DSpecific(index); 
                        } else {
                            Swal.fire('Error', res, 'error');
                        }
                    }).syncSlitIdentities(log.jobId, finalPayload);
                }
            });
        }


        function confirmResetAndEdit(index) {
            Swal.fire({
                title: 'ล้างแผนการซอย?',
                text: "ข้อมูลม้วนย่อยเดิมในสต็อกจะถูกลบเพื่อเริ่มใหม่",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ลบและเริ่มใหม่'
            }).then((result) => {
                if (result.isConfirmed) {
                    const log = ALL_LOGS_DATA[index];
                    showLoading();
                    callGAS('withSuccessHandler', [res => {
                        hideLoading(], null, null);
                        ACTIVE_KNIVES[index] = []; 
                        renderKnifeLines(index, document.getElementById(`knife-container-${index}`)); 
                        applySlitting(index, ""); 
                        Swal.fire('ล้างข้อมูลสำเร็จ', 'วางใบมีดใหม่ได้เลยครับ', 'success');
                    }).syncSlitIdentities(log.jobId, []); 
                }
            });
        }

        function syncKeyInputToCanvas(index, value) {
            let log;
            if (index === 'current') {
                const f = document.getElementById('record-form');
                // ใช้ค่าเฉลี่ยหน้ากว้างที่กรอก หรือถ้ายังไม่กรอกให้ใช้ 1225
                const wVal = parseFloat(f.elements['widthM'].value) || 
                            parseFloat(f.elements['widthH'].value) || 1225;
                log = {
                    jobId: document.getElementById('input-job-id').value,
                    wM: wVal,
                    thickness: document.getElementById('disp-target-thick').value
                };
            } else {
                log = ALL_LOGS_DATA[index];
            }

            if (!log) return;
            const totalW = parseFloat(log.wM) || 1225;
            
            if (!ACTIVE_KNIVES[index]) ACTIVE_KNIVES[index] = [];

            if (!value || value.trim() === "") {
                ACTIVE_KNIVES[index] = [];
            } else {
                const widths = value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v) && v > 0);
                let currentPos = 0;
                ACTIVE_KNIVES[index] = [];
                for (let i = 0; i < widths.length - 1; i++) {
                    currentPos += widths[i];
                    let ratio = currentPos / totalW;
                    if (ratio < 1) ACTIVE_KNIVES[index].push(ratio);
                }
            }
            
            // วาดภาพหน้าตัด 2D ใหม่
            draw2DSliceProfile(index, (index === 'current' ? 0 : document.getElementById('slider-' + index)?.value || 0));
            // เรียกคำนวณสถิติรายเส้น
            applySlitting(index, value);
        }

        function confirmDeleteExistingSlits() {
            const jobId = document.getElementById('input-job-id').value;
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ข้อมูลม้วนย่อย (ลูก) ของม้วนนี้จะถูกลบออกจากคลังทั้งหมดเพื่อบันทึกใหม่",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'ใช่, ลบเลย'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    callGAS('withSuccessHandler', [res => {
                        hideLoading(], null, null);
                        document.getElementById('record-re-slit-area').style.display = 'none';
                        document.getElementById('slit-already-exists-msg').style.display = 'none';
                        document.getElementById('btn-save').disabled = false;
                        Swal.fire('ลบแล้ว', 'คุณสามารถบันทึกข้อมูลการซอยใหม่ได้', 'success');
                    }).deleteSlitData(jobId);
                }
            });
        }

        function checkIdentityStatus(jobId) {
            callGAS('checkSlitExists', [jobId], exists => {
                if (exists) {
                    document.getElementById('record-re-slit-area').style.display = 'block';
                    document.getElementById('slit-already-exists-msg').style.display = 'block';
                    // ปิดปุ่มบันทึกไว้ก่อน เพื่อบังคับให้เขากดลบของเก่าถ้าจะแก้
                    document.getElementById('btn-save').disabled = true;
                } else {
                    document.getElementById('record-re-slit-area').style.display = 'none';
                    document.getElementById('slit-already-exists-msg').style.display = 'none';
                    document.getElementById('btn-save').disabled = false;
                }
            });
        }

        function renderTimelineChart(data) {
            const canvas = document.getElementById('timelineChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (window.myTimeline) window.myTimeline.destroy();

            const selectedDate = document.getElementById('dash-date-start').value; 
            const minTime = new Date(selectedDate + "T00:00:00").getTime();
            const maxTime = new Date(selectedDate + "T23:59:59").getTime();

            const datasets = data.map(item => ({
                label: item.jobId,
                data: [{
                    x: [item.start, item.end],
                    y: item.machine
                }],
                backgroundColor: item.status === 'Finished' ? 'rgba(16, 185, 129, 0.9)' : 'rgba(59, 130, 246, 0.9)',
                borderRadius: 4,
                barPercentage: 0.85
            }));

            window.myTimeline = new Chart(ctx, {
                type: 'bar',
                data: { datasets: datasets },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            min: minTime, max: maxTime,
                            time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                            grid: { color: 'rgba(0,0,0,0.03)' },
                            ticks: { font: { size: 10 } }
                        },
                        y: { 
                            type: 'category',
                            labels: ALL_DATA.machines, 
                            ticks: { font: { weight: 'bold', size: 11 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => ` Job: ${ctx.dataset.label}` } }
                    }
                }
            });
        }

        function toggleTimelineFullscreen() {
            const card = document.getElementById('timeline-card-node');
            const heightCtrl = document.getElementById('chart-height-control');
            
            card.classList.toggle('timeline-fullscreen');
            
            if (card.classList.contains('timeline-fullscreen')) {
                heightCtrl.style.height = "75vh";
            } else {
                heightCtrl.style.height = "150px";
            }
            renderTimelineChart(ALL_TIMELINE_DATA);
        }

        // [REMOVED] reCalibrateModel + event listener

        // [REMOVED] displayPredictionUI


        // === AI SUGGESTION HINT FUNCTIONS ===
        // แสดงค่าแนะนำจาก AI โดยไม่แตะช่อง input เลย
        function showAiHints(prediction) {
            const keys = ['H', 'HM', 'M', 'MT', 'T'];
            keys.forEach(k => {
                const bar = document.getElementById('hint-' + k);
                if (!bar || !prediction[k]) return;
                const p = prediction[k];
                document.getElementById('hint-' + k + '1').textContent = parseFloat(p.t1).toFixed(3);
                document.getElementById('hint-' + k + '2').textContent = parseFloat(p.t2).toFixed(3);
                document.getElementById('hint-' + k + '3').textContent = parseFloat(p.t3).toFixed(3);
                bar.classList.add('visible');
            });
        }

        function clearAiHints() {
            ['H', 'HM', 'M', 'MT', 'T'].forEach(k => {
                const bar = document.getElementById('hint-' + k);
                if (!bar) return;
                bar.classList.remove('visible');
                ['1','2','3'].forEach(n => {
                    const el = document.getElementById('hint-' + k + n);
                    if (el) el.textContent = '—';
                });
            });
        }


        


        // ================================================================
        // MOBILE DASHBOARD — App-style accordion (replaces desktop grid)
        // ================================================================

        function renderMobileDash(data) {
            if (!data || !data.machines) return;

            // อัปเดตเวลา
            const upEl = document.getElementById('mob-last-update');
            if (upEl) upEl.innerText = 'อัปเดต ' + new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});

            // Stat bar
            let nRun = 0, nWait = 0, nTotal = 0;
            data.machines.forEach(m => {
                (m.jobs||[]).forEach(j => {
                    nTotal++;
                    if (j.status === 'Running') nRun++;
                    if (j.status === 'Waiting') nWait++;
                });
            });
            ['mob-stat-run','mob-stat-wait','mob-stat-total'].forEach((id,i) => {
                const el = document.getElementById(id);
                if (el) el.innerText = [nRun, nWait, nTotal][i];
            });

            // Machine list
            const list = document.getElementById('mob-machine-list');
            if (!list) return;
            list.innerHTML = '';

            data.machines.forEach((m, mi) => {
                const running = m.jobs && m.jobs.find(j => j.status === 'Running');
                const isRunning = !!running;
                const pending  = (m.jobs||[]).filter(j => j.status !== 'Finished');
                const subText  = running
                    ? running.jobId + ' · ' + running.thickness.toFixed(2) + ' mm'
                    : pending.length + ' งานรอ';

                // Job rows
                let jobsHtml = '';
                if (pending.length === 0) {
                    jobsHtml = '<div class="mob-empty"><i class="fa-solid fa-inbox me-1"></i>ไม่มีงานในคิว</div>';
                } else {
                    pending.forEach(job => {
                        const cls = job.status.toLowerCase();
                        const lbl = job.status === 'Running'
                            ? '<span class="mob-job-status-label running">● Running</span>'
                            : '<span class="mob-job-status-label waiting">○ Waiting</span>';
                        jobsHtml += `
                        <div class="mob-job-item" onclick="viewJobHistory('${job.jobId}','${(job.customer||'').replace(/'/g,'\'')}')">
                            <div class="mob-job-bar ${cls}"></div>
                            <div class="mob-job-info">
                                <div class="mob-job-id">${job.jobId}</div>
                                <div class="mob-job-cust">${job.customer||'-'}</div>
                                <div class="mob-job-thk">${job.thickness.toFixed(2)} mm</div>
                            </div>
                            <div class="mob-job-right">
                                <div class="mob-job-count">${job.producedTotal}/${job.totalCoils}</div>
                                ${lbl}
                            </div>
                            <i class="fa-solid fa-chevron-right" style="color:#e2e8f0;font-size:.8rem;"></i>
                        </div>`;
                    });
                }

                const rowId = 'mob-mc-' + mi;
                const div = document.createElement('div');
                div.className = 'mob-machine-row' + (isRunning ? ' is-running' : '') + (isRunning ? ' open' : '');
                div.id = rowId;
                div.innerHTML = `
                    <div class="mob-machine-header" onclick="toggleMobMachine('${rowId}')">
                        <div class="mob-machine-dot ${isRunning?'running':'idle'}"></div>
                        <div style="flex:1;min-width:0">
                            <div class="mob-machine-name">${m.machine}</div>
                            <div class="mob-machine-sub">${subText}</div>
                        </div>
                        <span class="mob-mc-badge ${isRunning?'running':'idle'}">${isRunning?'Running':'Idle'}</span>
                        <i class="fa-solid fa-chevron-down mob-chevron"></i>
                    </div>
                    <div class="mob-job-list">${jobsHtml}</div>`;
                list.appendChild(div);
            });
        }

        function toggleMobMachine(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('open');
        }

        // Bottom nav — highlight active tab + show/hide record button
        function updateMobNav() {
            const screens = ['screen-select','screen-queue','screen-running','screen-dashboard','screen-dashboard-exec'];
            const navMap  = {
                'screen-select':          'mob-nav-home',
                'screen-queue':           'mob-nav-queue',
                'screen-running':         'mob-nav-queue',
                'screen-dashboard':       'mob-nav-monitor',
                'screen-dashboard-exec':  'mob-nav-analytics',
            };
            let activeScreen = '';
            screens.forEach(s => {
                if (document.getElementById(s) && document.getElementById(s).classList.contains('active-screen'))
                    activeScreen = s;
            });

            // highlight
            ['mob-nav-home','mob-nav-monitor','mob-nav-queue','mob-nav-analytics'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('active', navMap[activeScreen] === id);
            });

            // Record button: แสดงเฉพาะตอนอยู่หน้า Running
            const recBtn = document.getElementById('mob-nav-record');
            if (recBtn) recBtn.style.display = (activeScreen === 'screen-running') ? 'flex' : 'none';
        }


        // ====================================================
        // SLIT PLAN BUILDER — ฟอร์มสร้างแผนผลิต
        // ====================================================

        const SLIT_COLORS = [
            '#4361ee','#10b981','#f59e0b','#ef4444','#8b5cf6',
            '#06b6d4','#ec4899','#84cc16','#f97316','#6366f1'
        ];

        let recordSlitCount = 0;

        function addRecordSlitRow(defaultVal = '', defaultNote = '') {
            const container = document.getElementById('record-slit-rows');
            const idx = recordSlitCount++;
            const color = SLIT_COLORS[idx % SLIT_COLORS.length];
            const row = document.createElement('div');
            row.className = 'mb-2 w-100';
            row.id = `record-slit-row-${idx}`;
            row.innerHTML = `
                <div class="d-flex align-items-center gap-1">
                    <div class="rounded-circle flex-shrink-0"
                        style="width:10px;height:10px;background:${color};"></div>
                    <div class="input-group input-group-sm flex-shrink-0" style="width:95px;">
                        <input type="number" class="form-control fw-bold text-center record-slit-width"
                               placeholder="ขนาด" value="${defaultVal}"
                               oninput="updateRecordSlitPreview()" min="1" step="1">
                        <span class="input-group-text px-1" style="font-size:10px;">mm</span>
                    </div>
                    <input type="text" class="form-control form-control-sm record-slit-note"
                           placeholder="Next Station..."
                           value="${defaultNote}"
                           oninput="updateRecordSlitPreview()"
                           style="font-size:11px;border-color:#f8bbd0;min-width:0;">
                    <button type="button" class="btn btn-sm btn-light border text-danger px-2 flex-shrink-0"
                            onclick="document.getElementById('record-slit-row-${idx}').remove(); updateRecordSlitPreview();">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>`;
            container.appendChild(row);
            updateRecordSlitPreview();
            row.querySelector('input').focus();
        }

        function updateRecordSlitPreview() {
            const stripWidth = parseFloat(document.getElementById('record-strip-width')?.value)
                            || Number(CURRENT_JOB_INFO?.stripWidth || 0);
            const widthInputs = document.querySelectorAll('.record-slit-width');
            const noteInputs  = document.querySelectorAll('.record-slit-note');
            let combined = [], total = 0;

            widthInputs.forEach((el, i) => {
                const w    = parseFloat(el.value) || 0;
                const note = noteInputs[i] ? noteInputs[i].value.trim() : '';
                if (w > 0) {
                    total += w;
                    combined.push(note ? `${w}[${note}]` : `${w}`);
                }
            });

            // อัปเดต hidden input
            document.getElementById('input-slit-plan').value = combined.join(',');

            // อัปเดต preview bar + scrap
            const preview = document.getElementById('record-slit-preview');
            const countEl = document.getElementById('preplan-count');
            const scrapEl = document.getElementById('preplan-scrap');
            const barEl   = document.getElementById('record-slit-bar');

            if (combined.length === 0) {
                preview.style.display = 'none';
                countEl.innerText = '0 เส้น';
                scrapEl.innerText = 'Scrap: - mm';
                document.getElementById('btn-save').disabled = false;
                return;
            }
            preview.style.display = 'block';
            countEl.innerText = `${combined.length} เส้น`;

            const scrap = stripWidth > 0 ? stripWidth - total : null;
            if (scrap !== null) {
                scrapEl.innerText = `Scrap: ${scrap.toFixed(1)} mm`;
                if (scrap < 0) {
                    scrapEl.className = 'badge bg-danger text-white border-0';
                    document.getElementById('btn-save').disabled = true;
                } else {
                    scrapEl.className = 'badge bg-success text-white border-0';
                    document.getElementById('btn-save').disabled = false;
                }
            } else {
                scrapEl.innerText = 'Scrap: - mm';
                scrapEl.className = 'badge bg-light text-danger border';
            }

            // วาด color bar
            const segments = combined.map((d, i) => {
                const w   = parseFloat(d);
                const pct = stripWidth > 0 ? (w / stripWidth * 100).toFixed(1) : (w / total * 100).toFixed(1);
                return `<div style="width:${pct}%;background:${SLIT_COLORS[i % SLIT_COLORS.length]};display:flex;align-items:center;justify-content:center;font-size:9px;color:white;font-weight:bold;overflow:hidden;" title="${w}mm">${w}</div>`;
            });
            if (scrap > 0 && stripWidth > 0) {
                const sp = (scrap / stripWidth * 100).toFixed(1);
                segments.push(`<div style="width:${sp}%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-size:9px;color:#94a3b8;">scrap</div>`);
            }
            barEl.innerHTML = segments.join('');

            // sync canvas
            syncKeyInputToCanvas('current', combined.join(','));
        }


        let slitRowCount = 0;

        function addSlitRow(defaultVal = '', defaultNote = '') {
            const container = document.getElementById('slit-rows-container');
            const idx = slitRowCount++;
            const color = SLIT_COLORS[idx % SLIT_COLORS.length];

            const row = document.createElement('div');
            row.className = 'd-flex align-items-center gap-2 mb-2';
            row.id = `slit-row-${idx}`;
            row.innerHTML = `
                <div class="rounded-circle flex-shrink-0" 
                    style="width:12px; height:12px; background:${color};"></div>
                
                <!-- ช่องใส่ขนาด -->
                <div class="input-group input-group-sm" style="max-width: 110px;">
                    <input type="number" class="form-control fw-bold text-center slit-width-input"
                          placeholder="ขนาด" value="${defaultVal}"
                          oninput="updateSlitPreview()" min="1" step="1">
                    <span class="input-group-text px-1" style="font-size:10px;">mm</span>
                </div>

                <!-- ช่องใส่ Note (จุดที่เกิด Error เมื่อกี้) -->
                <input type="text" class="form-control form-control-sm slit-note-input" 
                      placeholder="Note / Next Station..." 
                      value="${defaultNote}"
                      oninput="updateSlitPreview()"
                      style="font-size: 11px; border-color: #f8bbd0;">

                <!-- ปุ่มลบ -->
                <button type="button" class="btn btn-sm btn-light border text-danger px-1"
                        onclick="removeSlitRow('slit-row-${idx}')">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            container.appendChild(row);
            updateSlitPreview();

            // Focus ช่องใหม่ทันที
            row.querySelector('input').focus();
        }

        function removeSlitRow(rowId) {
            document.getElementById(rowId)?.remove();
            updateSlitPreview();
        }

        function updateSlitPreview() {
            const stripWidth = parseFloat(document.getElementById('new-strip-width')?.value) || 0;
            const widthInputs = document.querySelectorAll('.slit-width-input');
            const noteInputs = document.querySelectorAll('.slit-note-input'); // ดึงช่อง Note
            
            let combinedData = [];
            let total = 0;

            widthInputs.forEach((el, i) => {
                const w = parseFloat(el.value) || 0;
                const note = noteInputs[i] ? noteInputs[i].value.trim() : "";
                
                if (w > 0) {
                    total += w;
                    // รวมข้อมูลในรูปแบบ "430[Note]" ถ้าไม่มีโน้ตจะเหลือแค่ "430"
                    const valueString = note ? `${w}[${note}]` : `${w}`;
                    combinedData.push(valueString);
                }
            });

            const scrap = stripWidth > 0 ? stripWidth - total : null;

            // อัปเดต hidden input สำหรับส่งไปบันทึก (เป็น string เช่น "430[งานด่วน],430[เก็บสต็อก]")
            document.getElementById('new-slit-plan-value').value = combinedData.join(',');

            const previewBar = document.getElementById('slit-preview-bar');
            if (combinedData.length === 0) {
                previewBar.style.display = 'none';
                return;
            }
            previewBar.style.display = 'block';

            // วาด color bar สัดส่วน
            const colorBar = document.getElementById('slit-color-bar');
            if (stripWidth > 0 && total > 0) {
                const segments = combinedData.map((dataStr, i) => {
                    const w = parseFloat(dataStr); // parseFloat จะดึงแค่ตัวเลขหน้า [ ออกมาอัตโนมัติ
                    const pct = (w / stripWidth * 100).toFixed(1);
                    const color = SLIT_COLORS[i % SLIT_COLORS.length];
                    return `<div style="width:${pct}%; background:${color}; 
                                display:flex; align-items:center; justify-content:center;
                                font-size:9px; color:white; font-weight:bold; overflow:hidden;"
                                title="${dataStr} mm">${w}</div>`;
                });

                if (scrap > 0) {
                    const scrapPct = (scrap / stripWidth * 100).toFixed(1);
                    segments.push(`<div style="width:${scrapPct}%; background:#e2e8f0;
                                        display:flex; align-items:center; justify-content:center;
                                        font-size:9px; color:#94a3b8;" title="Scrap ${scrap.toFixed(1)}mm">scrap</div>`);
                }
                colorBar.innerHTML = segments.join('');
            } else {
                colorBar.innerHTML = combinedData.map((dataStr, i) => {
                    const w = parseFloat(dataStr);
                    const pct = (w / (total || 1) * 100).toFixed(1);
                    return `<div style="width:${pct}%; background:${SLIT_COLORS[i % SLIT_COLORS.length]};
                                display:flex; align-items:center; justify-content:center;
                                font-size:9px; color:white; font-weight:bold;">${w}</div>`;
                }).join('');
            }

            // อัปเดต Label สรุปยอด
            document.getElementById('slit-sum-label').textContent = `รวม: ${total.toFixed(1)} mm`;
            const scrapEl = document.getElementById('slit-scrap-label');
            
            if (scrap !== null) {
                const isOver = scrap < 0;
                scrapEl.textContent = isOver ? `เกิน: ${Math.abs(scrap).toFixed(1)} mm` : `Scrap: ${scrap.toFixed(1)} mm`;
                // เปลี่ยนสี: เขียวถ้าพอดี/เหลือ, แดงถ้าเกิน
                scrapEl.className = `fw-bold small ${isOver ? 'text-danger' : 'text-success'}`;
                
                // ถ้ายอดเกิน ให้ทำกรอบสีแดงแจ้งเตือน
                const scrapContainer = document.getElementById('slit-scrap-container');
                if (scrapContainer) {
                    scrapContainer.style.borderColor = isOver ? "#ef4444" : "#10b981";
                    scrapContainer.style.backgroundColor = isOver ? "#fef2f2" : "#f0fdf4";
                }
            } else {
                scrapEl.textContent = '';
            }
        }

        function resetSlitBuilder() {
            slitRowCount = 0;
            const container = document.getElementById('slit-rows-container');
            if (container) container.innerHTML = '';
            const preview = document.getElementById('slit-preview-bar');
            if (preview) preview.style.display = 'none';
            const hidden = document.getElementById('new-slit-plan-value');
            if (hidden) hidden.value = '';
            const stripInput = document.getElementById('new-strip-width');
            if (stripInput) stripInput.value = '';
        }

    </script>

    <div id="toast-container" style="position:fixed; top:20px; right:20px; z-index:10000;"></div>

  </body>
</html>
