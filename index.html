<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Production App - Final Phase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4361ee; --dark: #1e293b; --success: #10b981; }
        body { background: #f8fafc; font-family: 'Sarabun', sans-serif; }
        .card-custom { background: white; border-radius: 16px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .screen { display: none; padding: 15px; }
        .active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .btn-main { border-radius: 12px; padding: 12px; font-weight: bold; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }
        .viewer-3d { background: #0f172a; height: 180px; border-radius: 12px; margin-bottom: 15px; position: relative; overflow: hidden; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:none; flex-direction:column; justify-content:center; align-items:center; }
        .thk-badge { background: #eef2ff; color: var(--primary); padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-grow text-primary"></div>
        <div class="mt-2 fw-bold text-primary">SM SYSTEM CONNECTING...</div>
    </div>

    <!-- หน้า 1: Login -->
    <div id="screen-login" class="screen active">
        <div class="container text-center mt-5">
            <div class="mb-4">
                <i class="fa-solid fa-industry text-primary fa-4x"></i>
            </div>
            <h3 class="fw-bold">SM Production</h3>
            <p class="text-muted">เลือกเครื่องจักรเพื่อเข้าสู่ระบบ</p>
            <div class="card-custom mx-auto p-4" style="max-width: 400px;">
                <select id="machine-select" class="form-select form-select-lg mb-3"></select>
                <button class="btn btn-primary btn-lg w-100 btn-main" onclick="enterSystem()">Login</button>
            </div>
        </div>
    </div>

    <!-- หน้า 2: Queue -->
    <div id="screen-queue" class="screen">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold m-0"><i class="fa-solid fa-list-check me-2"></i>รายการงาน</h4>
            <span id="display-machine" class="badge bg-primary px-3 py-2"></span>
        </div>
        <div id="job-list-container"></div>
    </div>

    <!-- หน้า 3: Record -->
    <div id="screen-running" class="screen">
        <div class="card-custom bg-dark text-white p-3 mb-3">
            <div class="d-flex justify-content-between">
                <div>
                    <h2 id="run-job-id" class="fw-bold m-0 text-info">JOB-XXXX</h2>
                    <div id="run-customer" class="small opacity-75">Customer Name</div>
                </div>
                <div class="text-end">
                    <span id="prediction-conf" class="badge bg-success">AI 95%</span>
                </div>
            </div>
        </div>

        <!-- จำลองหน้าตัดเหล็ก (Profile Simulation) -->
        <div class="card-custom p-3">
            <h6 class="fw-bold mb-3 text-muted"><i class="fa-solid fa-microchip me-2"></i>Mill DNA Simulation</h6>
            <div class="viewer-3d">
                <canvas id="profileCanvas" style="width:100%; height:100%;"></canvas>
            </div>
            
            <button class="btn btn-outline-primary w-100 btn-main mb-3" onclick="openScanner()">
                <i class="fa-solid fa-qrcode me-2"></i> สแกน QR Tag (Coil)
            </button>
            <div id="reader" style="display:none;" class="mb-3"></div>

            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Mill No.</label>
                    <input type="text" id="millNo" class="form-control form-control-lg">
                </div>
                <div class="col-6">
                    <label class="small fw-bold">น้ำหนัก (kg)</label>
                    <input type="number" id="weight" class="form-control form-control-lg">
                </div>
            </div>

            <!-- ช่องกรอกความหนาแบบย่อ (หัวม้วน) -->
             <div class="row g-1 mb-3 text-center">
                <div class="col-4"><label class="small">T1</label><input type="number" id="t1" step="0.001" class="form-control text-center"></div>
                <div class="col-4"><label class="small">T2</label><input type="number" id="t2" step="0.001" class="form-control text-center border-primary"></div>
                <div class="col-4"><label class="small">T3</label><input type="number" id="t3" step="0.001" class="form-control text-center"></div>
             </div>

            <button class="btn btn-primary w-100 btn-lg btn-main shadow-lg" onclick="saveRecord()">
                <i class="fa-solid fa-floppy-disk me-2"></i> บันทึกข้อมูลการผลิต
            </button>
        </div>

        <button class="btn btn-light w-100 btn-main text-muted" onclick="switchScreen('screen-queue')">ยกเลิก</button>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzl5VXzGxJo4SnuzkO4G6axSm1rAmBzAQ-9NAQPxEOmtiTVqxbZqmro6-RS94YhYYcJ/exec";
    const API_KEY = "TMT2026";
    let ALL_DATA = { machines: [], jobs: [] };
    let SELECTED_MACHINE = "";
    let CURRENT_JOB = null;
    let PREDICTION = null;
    let html5QrCode = null;

    async function callGAS(action, data = {}) {
        document.getElementById('loading').style.display = 'flex';
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ apiKey: API_KEY, action: action, data: data })
            });
            return await response.json();
        } catch (err) {
            Swal.fire('API Error', 'เชื่อมต่อล้มเหลว', 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    window.onload = async () => {
        showLoading();
        try {
            const data = await callGAS('getInitialData');
            console.log("Received Data:", data); // ดูค่าใน Console

            if (data && data.machines) {
                ALL_DATA = data;
                const select = document.getElementById('machine-select');
                select.innerHTML = '<option value="" selected disabled>-- เลือกเครื่องจักร --</option>';
                
                // แก้ไขจุดที่เคย Error: เช็กก่อนว่ามีข้อมูลไหม
                data.machines.forEach(m => {
                    let opt = new Option(m, m);
                    select.add(opt);
                });
            } else {
                // ถ้าข้อมูลไม่มา ให้แสดง Error ชัดๆ
                Swal.fire('API Error', 'Backend ส่งข้อมูลมาไม่ถูกต้อง หรือ API Key ไม่ตรงกัน', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Connection Error', 'ติดต่อ Google Script ไม่ได้: ' + err.message, 'error');
        } finally {
            hideLoading();
        }
    };

    function enterSystem() {
        SELECTED_MACHINE = document.getElementById('machine-select').value;
        if (!SELECTED_MACHINE) return;
        document.getElementById('display-machine').innerText = SELECTED_MACHINE;
        renderJobs();
        switchScreen('screen-queue');
    }

    function renderJobs() {
        const container = document.getElementById('job-list-container');
        container.innerHTML = "";
        const myJobs = ALL_DATA.jobs.filter(j => j.machine === SELECTED_MACHINE && j.status !== 'Finished');
        myJobs.forEach(j => {
            const div = document.createElement('div');
            div.className = 'card-custom p-3';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${j.jobId}</div>
                        <div class="small text-muted">${j.customer} | ${j.thickness}mm</div>
                    </div>
                    <button class="btn btn-primary btn-sm px-4 btn-main" onclick="startJob('${j.jobId}')">เริ่มงาน</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function startJob(jobId) {
        showLoading();
        // 1. เปลี่ยนสถานะใน Sheet
        await callGAS('startJob', { jobId: jobId });
        // 2. ดึง AI Prediction
        const pred = await callGAS('getSmartPrediction', { jobId: jobId });
        
        CURRENT_JOB = ALL_DATA.jobs.find(j => j.jobId === jobId);
        PREDICTION = pred;

        document.getElementById('run-job-id').innerText = CURRENT_JOB.jobId;
        document.getElementById('run-customer').innerText = CURRENT_JOB.customer;
        
        if (pred.found) {
            document.getElementById('prediction-conf').innerText = "AI Confidence: " + pred.confidence;
            // ใส่ค่าทำนายลงในช่องกรอก (ตำแหน่งหัวม้วน)
            document.getElementById('t1').value = pred.prediction.H.t1;
            document.getElementById('t2').value = pred.prediction.H.t2;
            document.getElementById('t3').value = pred.prediction.H.t3;
        }

        drawProfile();
        switchScreen('screen-running');
        hideLoading();
    }

    function drawProfile() {
        const canvas = document.getElementById('profileCanvas');
        const ctx = canvas.getContext('2d');
        // Logic วาดหน้าตัดเหล็กแบบ Real-time (ขอละย่อเพื่อความสั้น)
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "#3b82f6";
        ctx.beginPath();
        ctx.roundRect(50, 40, 200, 20, 5);
        ctx.fill();
    }

    function openScanner() {
        document.getElementById('reader').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 15, qrbox: 250 },
            (decodedText) => {
                const data = decodedText.split(",");
                if(data[0]) document.getElementById('millNo').value = data[0];
                if(data[4]) document.getElementById('weight').value = data[4];
                stopScanner();
                Swal.fire({ icon:'success', title:'สแกนสำเร็จ', timer:1000, showConfirmButton:false });
            }
        );
    }

    function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => document.getElementById('reader').style.display='none'); }

    async function saveRecord() {
        const formObj = {
            jobId: CURRENT_JOB.jobId,
            machine: SELECTED_MACHINE,
            millNo: document.getElementById('millNo').value,
            weight: document.getElementById('weight').value,
            thickH1: document.getElementById('t1').value,
            thickH2: document.getElementById('t2').value,
            thickH3: document.getElementById('t3').value
        };

        const res = await callGAS('saveProductionLog', { formObj: formObj, fileList: [] });
        if (res.includes("SUCCESS")) {
            Swal.fire('บันทึกสำเร็จ', '', 'success').then(() => location.reload());
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function showLoading() { document.getElementById('loading').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }
</script>
</body>
</html>

